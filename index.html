<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 CBT</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #212529; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .button { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 5px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: bold; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        #auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        #auth-container button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }
        #auth-container span { font-size: 0.9em; margin-right: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em;}
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <div id="logged-out-view">
                <button class="button light-button" onclick="showView('login-view')">로그인</button>
                <button class="button primary-button" onclick="showView('signup-view')">회원가입</button>
            </div>
            <div id="logged-in-view" class="hidden">
                <span id="user-email"></span>
                <button class="button secondary-button" onclick="logOut()">로그아웃</button>
            </div>
        </div>

        <div id="subject-view">
            <h2>과목 선택</h2>
            <div id="subject-list">
                <p>로그인 후 이용해주세요.</p>
            </div>
        </div>

        <div id="signup-view" class="hidden">
            <h2>회원가입</h2>
            <div class="form-group"><label for="signup-email">이메일</label><input type="email" id="signup-email"></div>
            <div class="form-group"><label for="signup-password">비밀번호 (6자리 이상)</label><input type="password" id="signup-password"></div>
            <button class="button primary-button" onclick="signUp()">회원가입</button>
            <button class="button light-button" onclick="showView('subject-view')">취소</button>
        </div>

        <div id="login-view" class="hidden">
            <h2>로그인</h2>
            <div class="form-group"><label for="login-email">이메일</label><input type="email" id="login-email"></div>
            <div class="form-group"><label for="login-password">비밀번호</label><input type="password" id="login-password"></div>
            <button class="button primary-button" onclick="logIn()">로그인</button>
            <button class="button light-button" onclick="showView('subject-view')">취소</button>
        </div>

        <div id="quiz-view" class="hidden">
            <h2 id="quiz-header"></h2>
            <div id="quiz-body"></div>
            <hr style="margin: 20px 0;">
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로 돌아가기</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
        // Firebase 초기화
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 전역 변수
        let questions = [], currentQuiz = 0, score = 0, selectedOption = null;
        const views = ['subject-view', 'signup-view', 'login-view', 'quiz-view'];

        function showView(viewId) {
            views.forEach(id => document.getElementById(id).classList.toggle('hidden', id !== viewId));
        }
        
        auth.onAuthStateChanged(user => {
            document.getElementById('logged-in-view').classList.toggle('hidden', !user);
            document.getElementById('logged-out-view').classList.toggle('hidden', !!user);
            if (user) {
                document.getElementById('user-email').textContent = `${user.email}님`;
                loadSubjects();
            } else {
                showView('subject-view');
                document.getElementById('subject-list').innerHTML = '<p>로그인 후 이용해주세요.</p>';
            }
        });
        
        async function signUp() {
            try {
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                await auth.createUserWithEmailAndPassword(email, password);
                showView('subject-view');
            } catch (error) {
                alert(error.message);
            }
        }

        async function logIn() {
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await auth.signInWithEmailAndPassword(email, password);
                showView('subject-view');
            } catch (error) {
                alert(error.message);
            }
        }

        function logOut() {
            auth.signOut();
        }

        async function loadSubjects() {
            const listDiv = document.getElementById('subject-list');
            listDiv.innerHTML = '과목 로딩 중...';
            try {
                const snapshot = await db.collection('subjects').orderBy('name').get();
                listDiv.innerHTML = '';
                if(snapshot.empty) {
                    listDiv.innerHTML = '<p>과목이 없습니다. Firebase에서 과목을 추가해주세요.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const subject = doc.data();
                    const button = document.createElement('button');
                    button.textContent = `${subject.name} (${subject.questionCount || 0}문제)`;
                    button.className = 'button light-button';
                    button.onclick = () => selectSubject(doc.id, subject);
                    listDiv.appendChild(button);
                });
            } catch(error) {
                console.error("Error loading subjects: ", error);
                listDiv.innerHTML = '<p>과목을 불러오는 중 오류가 발생했습니다.</p>';
            }
        }
        
        function selectSubject(id, data) {
            showView('quiz-view');
            document.getElementById('quiz-header').textContent = `${data.name} 퀴즈`;
            loadQuestionsForSubject(id);
        }

        async function loadQuestionsForSubject(subjectId) {
            const quizBody = document.getElementById('quiz-body');
            quizBody.innerHTML = '<p>문제 로딩 중...</p>';
            try {
                const snapshot = await db.collection('subjects').doc(subjectId).collection('questions').get();
                questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentQuiz = 0;
                score = 0;
                displayCurrentQuiz();
            } catch(error) {
                console.error("Error loading questions: ", error);
                quizBody.innerHTML = '<p>문제를 불러오는 중 오류가 발생했습니다.</p>';
            }
        }

        function displayCurrentQuiz() {
            const quizBody = document.getElementById('quiz-body');
            selectedOption = null;
            
            if (questions.length === 0) {
                quizBody.innerHTML = "<p>이 과목에 문제가 없습니다.</p>";
                return;
            }
            if (currentQuiz >= questions.length) {
                quizBody.innerHTML = `<h2>퀴즈 결과: ${score}/${questions.length}</h2><button class="button primary-button" onclick="selectSubject(currentSubjectId, currentSubjectData)">다시 풀기</button>`;
                return;
            }

            const data = questions[currentQuiz];
            let optionsHTML = '';
            (data.options || []).forEach(opt => {
                optionsHTML += `<li class="option">${opt}</li>`;
            });

            quizBody.innerHTML = `
                <div id="question">${data.fixedId || (currentQuiz + 1)}. ${data.text}</div>
                <ul id="options-container" class="options-container">${optionsHTML}</ul>
                <button id="submit-btn" class="button primary-button">정답 제출</button>
            `;
            
            document.querySelectorAll('.option').forEach(li => {
                li.onclick = () => {
                    document.querySelector('.option.selected')?.classList.remove('selected');
                    li.classList.add('selected');
                    selectedOption = li.textContent;
                };
            });
            document.getElementById('submit-btn').onclick = submitAnswer;
        }

        function submitAnswer() {
            if (!selectedOption) return alert("보기를 선택해주세요!");
            if (selectedOption === questions[currentQuiz].answer) score++;
            currentQuiz++;
            displayCurrentQuiz();
        }
    </script>
</body>
</html>
