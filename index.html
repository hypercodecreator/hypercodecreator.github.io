<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 CBT</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #212529; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .button { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 5px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: bold; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .danger-button { background-color: #dc3545; color: white; border-color: #dc3545; }
        #auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        #auth-container button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }
        #auth-container span { font-size: 0.9em; margin-right: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em;}
        .tag-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag-group input { flex-grow: 1; }
        #management-actions { display: flex; justify-content: space-between; align-items: center; border: 1px solid #0d6efd; background-color: #e7f1ff; padding: 8px 12px; border-radius: 5px; margin-bottom: 10px; }
        #management-actions .button-group { display: flex; gap: 5px; }
        #management-actions .button { margin-top: 0; padding: 6px 10px; font-size: 0.9em; }
        .quiz-question-header { display: flex; align-items: center; justify-content: space-between; }
        #bookmark-toggle { font-size: 1.5em; cursor: pointer; color: #ffc107; user-select: none; }
        .question-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .question-item-text { flex-grow: 1; margin-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .question-item-part { font-size: 0.8em; color: #6c757d; margin-left: 8px; flex-shrink: 0; }
        .question-item > div { flex-shrink: 0; }
        .question-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.2); }
        .range-select-container { display: flex; margin-bottom: 10px; }
        .range-select-container input { flex-grow: 1; margin-right: 10px; }
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .feedback p { margin: 5px 0; }
        .mode-toggle { display: flex; justify-content: flex-end; align-items: center; font-size: 0.9em; margin-bottom: 10px; }
        .confidence-buttons button { margin: 5px; padding: 8px 12px; font-size: 0.9em; }
        #help-button { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: #0d6efd; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; z-index: 1002; }
        .modal-content h3 { margin-top: 0; }
        .modal-content .feature { margin-bottom: 15px; }
        .modal-content .feature-title { font-weight: bold; }
        #tree-container ul { list-style-type: none; padding-left: 20px; }
        .tree-node { cursor: pointer; padding: 5px; }
        .subject-node::before { content: '► '; }
        .subject-node.expanded::before { content: '▼ '; }
        .part-node { font-weight: bold; }
        .question-node { font-size: 0.9em; color: #343a40; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">로그인</button><button class="button primary-button" onclick="showView('signup-view')">회원가입</button></div>
            <div id="logged-in-view" class="hidden"><span id="user-email"></span><button class="button secondary-button" onclick="logOut()">로그아웃</button></div>
        </div>
        
        <div id="subject-view">
            <h2>과목 선택</h2>
            <button class="button primary-button" onclick="showTreeView()">🌳 지식 체계 보기</button>
            <button class="button secondary-button hidden" onclick="showBookmarkView()">⭐ 북마크 모아보기</button>
            <hr style="border:none;border-top:1px solid #eee;margin:15px 0;" class="hidden">
            <div id="subject-list"></div>
        </div>

        <div id="quiz-view" class="hidden">
            <div class="quiz-question-header">
                <h2 id="quiz-header" style="margin:0;"></h2>
                <span id="bookmark-toggle">☆</span>
            </div>
            <div id="breadcrumb-nav" style="font-size: 0.9em; color: #6c757d; margin-top: 5px;"></div>
            <div class="mode-toggle" style="margin-top:10px;"><label for="feedback-toggle">즉시 결과 확인</label><input type="checkbox" id="feedback-toggle" onchange="toggleFeedbackMode(this.checked)"></div>
            <div id="quiz-body"></div>
            <div id="immediate-feedback"></div>
            <div id="concept-map" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
                <h4>🗺️ 개념 연결 지도</h4>
                <div id="map-content"></div>
            </div>
            <hr style="margin:20px 0;">
            <button class="button secondary-button" onclick="showManagementView()">📋 문제 관리</button>
            <button class="button primary-button" onclick="startWeaknessQuiz()">🎯 취약점 공략 퀴즈</button>
            <button class="button primary-button" style="background-color: #198754;" onclick="startHorizontalQuiz()">↔️ 연관 문제 풀기</button>
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로</button>
        </div>

        <div id="tree-view" class="hidden">
            <h2>🌳 지식 체계 보기</h2>
            <div id="tree-container"></div>
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로</button>
        </div>
        
        <div id="bookmark-view" class="hidden"><h2>⭐ 북마크 모아보기</h2><div id="bookmark-list-container"></div><button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로</button></div>
        <div id="signup-view" class="hidden"><h2>회원가입</h2><div class="form-group"><label for="signup-email">이메일</label><input type="email" id="signup-email"></div><div class="form-group"><label for="signup-password">비밀번호</label><input type="password" id="signup-password"></div><button class="button primary-button" onclick="signUp()">회원가입</button><button class="button light-button" onclick="showView('subject-view')">취소</button></div>
        <div id="login-view" class="hidden"><h2>로그인</h2><div class="form-group"><label for="login-email">이메일</label><input type="email" id="login-email"></div><div class="form-group"><label for="login-password">비밀번호</label><input type="password" id="login-password"></div><button class="button primary-button" onclick="logIn()">로그인</button><button class="button light-button" onclick="showView('subject-view')">취소</button></div>
        
        <div id="management-view" class="hidden"><h2 id="management-header"></h2><button class="button primary-button" onclick="showAddForm()">+ 새 키워드 추가</button><button class="button primary-button" onclick="showView('bulk-add-view')">+ 여러 키워드 추가</button><hr><div class="form-group"><label for="part-filter" style="font-weight:normal;">파트별로 보기</label><select id="part-filter" class="form-group" onchange="showManagementView()"></select></div><div id="management-actions" class="hidden"><span id="selection-count"></span><div class="button-group"><button class="button secondary-button" onclick="showMoveDialog()">이동</button><button class="button danger-button" onclick="deleteSelectedQuestions()">삭제</button></div></div><div class="range-select-container"><input type="text" id="range-select-input" class="form-group" placeholder="예: 1-5, 8, 10-12"><button class="button light-button" onclick="selectByRange()">구간 선택</button></div><div><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this.checked)"> <label for="select-all-checkbox">전체 선택</label></div><div id="question-list-container"></div><button class="button light-button" onclick="showView('quiz-view')">← 퀴즈 화면으로</button></div>
        
        <div id="move-question-view" class="hidden"><h2>선택한 키워드 이동</h2><div class="form-group"><label for="target-part">이동할 파트</label><select id="target-part" class="form-group"></select></div><button class="button primary-button" onclick="executeMove()">이동 실행</button><button class="button light-button" onclick="showView('management-view')">취소</button></div>
        
        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            <div class="form-group"><label for="q-keyword">핵심 키워드 (문제 텍스트)</label><textarea id="q-keyword" rows="3" placeholder="예: 명장초등학교의 역사"></textarea></div>
            <div class="form-group"><label for="q-answer">정답</label><input type="text" id="q-answer"></div>
            <div class="form-group"><label for="q-explanation">해설</label><textarea id="q-explanation" rows="3"></textarea></div>
            <div class="form-group"><label for="q-part">소속 파트</label><select id="q-part"></select></div>
            <hr>
            <h4>구조화된 태그 (개념의 속성)</h4>
            <div id="q-tags-container"></div>
            <button class="button light-button" onclick="addTagField()">+ 태그 추가</button>
            <hr>
            <h4>단순 보기 (4지선다 등)</h4>
            <div id="q-options-container"></div>
            <button class="button light-button" onclick="addOptionField()">+ 보기 추가</button>
            <hr>
            <button id="save-btn" class="button primary-button">저장</button>
            <button class="button light-button" onclick="showView('management-view')">← 관리 화면으로</button>
        </div>

        <div id="bulk-add-view" class="hidden"><h2>📚 여러 키워드 추가</h2><div class="form-group"><textarea id="bulk-text" rows="10" placeholder="문제: ..."></textarea></div><button class="button primary-button" onclick="addBulkQuestions()">DB에 저장</button><button class="button light-button" onclick="showView('management-view')">← 관리 화면으로</button></div>
    </div>

    <button id="help-button" onclick="displayHelpModal()">?</button>
    <div id="help-modal-overlay" class="modal-overlay hidden" onclick="closeHelpModal()"></div>
    <div id="help-modal-content" class="modal-content hidden">
        <h3>💡 주요 기능 안내</h3>
        <div class="feature"><p class="feature-title">⭐ 북마크 모아보기</p><p>퀴즈 화면에서 별(☆) 아이콘을 눌러 북마크(★)한 문제들만 모아서 풀어볼 수 있는 기능입니다. 중요한 문제를 따로 관리해보세요.</p></div>
        <div class="feature"><p class="feature-title">🎯 취약점 공략 퀴즈</p><p>퀴즈 정답 후 '애매함' 또는 '찍음'으로 표시한 문제들만 모아서 복습하는 개인 맞춤형 퀴즈입니다. 나의 약점을 집중적으로 보완할 수 있습니다.</p></div>
        <div class="feature"><p class="feature-title">↔️ 연관 문제 풀기</p><p>현재 풀고 있는 문제와 동일한 파트(소주제)에 속한 다른 문제들을 이어서 풀어보는 기능입니다. 유사 개념들을 함께 학습하여 지식을 공고히 할 수 있습니다.</p></div>
        <button class="button light-button" onclick="closeHelpModal()">닫기</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentSubjectId, currentSubjectData, allQuestionsForSubject = [], questions = [], displayedQuestions = [], currentQuiz = 0, score = 0, selectedOption = null, immediateFeedbackMode = false;
        const views = ['subject-view', 'signup-view', 'login-view', 'quiz-view', 'management-view', 'add-edit-view', 'move-question-view', 'bookmark-view', 'bulk-add-view', 'tree-view'];

        function showView(viewId) { views.forEach(id => document.getElementById(id)?.classList.toggle('hidden', id !== viewId)); }
        
        auth.onAuthStateChanged(user => {
            const loggedInElements = [document.getElementById('logged-in-view'), document.querySelector('#subject-view button[onclick="showBookmarkView()"]'), document.querySelector('#subject-view hr')];
            loggedInElements.forEach(el => el?.classList.toggle('hidden', !user));
            document.getElementById('logged-out-view').classList.toggle('hidden', !!user);
            if (user) { document.getElementById('user-email').textContent = `${user.email}님`; loadSubjects(); } 
            else { showView('subject-view'); document.getElementById('subject-list').innerHTML = '<p>로그인 후 이용해주세요.</p>'; }
        });
        
        async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        function logOut() { auth.signOut(); }

        function displayHelpModal() { document.getElementById('help-modal-overlay').classList.remove('hidden'); document.getElementById('help-modal-content').classList.remove('hidden'); }
        function closeHelpModal() { document.getElementById('help-modal-overlay').classList.add('hidden'); document.getElementById('help-modal-content').classList.add('hidden'); }

        async function loadSubjects() {
            const listDiv = document.getElementById('subject-list'); listDiv.innerHTML = '과목 로딩 중...';
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const subject = doc.data(); const button = document.createElement('button');
                button.textContent = `${subject.name} (${subject.questionCount || 0}문제)`; button.className = 'button light-button';
                button.onclick = () => selectSubject(doc.id, subject);
                listDiv.appendChild(button);
            });
        }
        
       async function selectSubject(id, data) {
            currentSubjectId = id; currentSubjectData = data;
            showView('quiz-view');
            await loadQuestionsForSubject();
        }

        async function loadQuestionsForSubject(targetQuestionId = null) {
            const quizBody = document.getElementById('quiz-body'); quizBody.innerHTML = '<p>문제 로딩 중...</p>';
            try {
                document.getElementById('quiz-header').textContent = `${currentSubjectData.name} 퀴즈`;
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('fixedId').get();
                allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                questions = [...allQuestionsForSubject];
                score = 0;
                currentQuiz = targetQuestionId ? questions.findIndex(q => q.id === targetQuestionId) : 0;
                if (currentQuiz === -1) currentQuiz = 0;
                await displayCurrentQuiz();
            } catch (e) { console.error("Error loading questions:", e); }
        }
        
        function updateBreadcrumb() {
            const currentQ = questions[currentQuiz];
            const navDiv = document.getElementById('breadcrumb-nav');
            if (!currentQ) { navDiv.innerHTML = ''; return; }
            navDiv.innerHTML = `<strong>과목:</strong> ${currentSubjectData.name} &nbsp;&nbsp; > &nbsp;&nbsp; <strong>파트:</strong> ${currentQ.partName || '미지정'}`;
        }

        async function displayCurrentQuiz() {
            document.getElementById('concept-map').classList.add('hidden');
            updateBreadcrumb();
            const quizBody = document.getElementById('quiz-body'); selectedOption = null;
            document.getElementById('feedback-toggle').checked = immediateFeedbackMode;
            if (questions.length === 0) { quizBody.innerHTML = "<p>표시할 문제가 없습니다.</p>"; return; }
            if (currentQuiz >= questions.length || !questions[currentQuiz]) { quizBody.innerHTML = `<h2>퀴즈가 끝났습니다.</h2><button class="button primary-button" onclick="loadQuestionsForSubject()">다시 풀기</button>`; return; }
            const data = questions[currentQuiz];
            const textContent = data.keyword || data.text; // 이전 버전 호환
            let optionsHTML = '';
            (data.options || []).forEach(opt => { optionsHTML += `<li class="option">${opt}</li>`; });
            quizBody.innerHTML = `<div id="question">${data.fixedId || (currentQuiz + 1)}. ${textContent}</div><ul id="options-container" class="options-container">${optionsHTML}</ul>`;
            document.getElementById('immediate-feedback').innerHTML = `<button id="submit-btn" class="button primary-button">정답 제출</button>`;
            document.querySelectorAll('.option').forEach(li => { li.onclick = () => { document.querySelector('.option.selected')?.classList.remove('selected'); li.classList.add('selected'); selectedOption = li.textContent; }; });
            document.getElementById('submit-btn').onclick = submitAnswer;
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const isBookmarked = await checkBookmarkStatus(data.id);
            bookmarkToggle.textContent = isBookmarked ? '★' : '☆';
            bookmarkToggle.onclick = () => toggleBookmark(data.id);
        }
        
        function submitAnswer() {
            if (!selectedOption) { alert("보기를 선택해주세요!"); return; }
            const data = questions[currentQuiz]; const isCorrect = selectedOption === data.answer;
            if (immediateFeedbackMode) {
                const feedbackDiv = document.getElementById('immediate-feedback');
                let feedbackHTML = '';
                if (isCorrect) {
                    feedbackDiv.className = 'feedback correct';
                    feedbackHTML = `<p><strong>정답입니다!</strong></p><p>이 문제를 얼마나 확실하게 알고 있었나요?</p><div class="confidence-buttons"><button class="button light-button" onclick="recordConfidence('${data.id}', 'confident')">확실함</button><button class="button light-button" onclick="recordConfidence('${data.id}', 'unsure')">애매함</button><button class="button light-button" onclick="recordConfidence('${data.id}', 'guess')">찍음</button></div>`;
                } else {
                    feedbackDiv.className = 'feedback incorrect';
                    feedbackHTML = `<p><strong>오답입니다.</strong></p><p>정답: ${data.answer}</p>`;
                    if (data.explanation) feedbackHTML += `<p>해설: ${data.explanation}</p>`;
                }
                feedbackDiv.innerHTML = feedbackHTML;
                displayConceptMap();
                document.querySelectorAll('.option').forEach(opt => { opt.onclick = null; if (opt.textContent === data.answer) opt.style.borderColor = '#198754'; else if (opt.textContent === selectedOption) opt.style.borderColor = '#dc3545'; });
                const nextButton = document.createElement('button');
                nextButton.className = 'button primary-button';
                nextButton.textContent = '다음 문제 →';
                nextButton.onclick = () => { currentQuiz++; displayCurrentQuiz(); };
                feedbackDiv.appendChild(nextButton);
            } else { if (isCorrect) score++; currentQuiz++; displayCurrentQuiz(); }
        }

        function displayConceptMap() {
            const mapContainer = document.getElementById('concept-map');
            const mapContent = document.getElementById('map-content');
            const currentQ = questions[currentQuiz];
            if (!currentQ) return;
            let contentHTML = '';
            contentHTML += `<div class="feature"><p class="feature-title">🔼 상위 개념 (수직)</p><p><strong>거리 1:</strong> ${currentQ.partName || '미지정 파트'}</p><p><strong>거리 2:</strong> ${currentSubjectData.name}</p></div>`;
            const siblingQuestions = allQuestionsForSubject.filter(q => q.partName === currentQ.partName && q.id !== currentQ.id);
            if (siblingQuestions.length > 0) {
                contentHTML += `<div class="feature"><p class="feature-title">↔️ 연관 개념 (수평 거리 2)</p><ul>`;
                siblingQuestions.slice(0, 5).forEach(q => { contentHTML += `<li>${q.fixedId}. ${q.keyword || q.text}</li>`; });
                if (siblingQuestions.length > 5) contentHTML += `<li>...외 ${siblingQuestions.length - 5}개</li>`;
                contentHTML += '</ul></div>';
            }
            mapContent.innerHTML = contentHTML;
            mapContainer.classList.remove('hidden');
        }

        async function startHorizontalQuiz() {
            const currentQ = questions[currentQuiz];
            if (!currentQ || !currentQ.partName) { alert('현재 문제의 파트 정보가 없어 연관 문제를 찾을 수 없습니다.'); return; }
            const relatedQuestions = allQuestionsForSubject.filter(q => q.partName === currentQ.partName && q.id !== currentQ.id);
            if (relatedQuestions.length === 0) { alert('이 파트에는 다른 연관 문제가 없습니다.'); return; }
            questions = relatedQuestions;
            currentQuiz = 0; score = 0;
            document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] 연관 문제`;
            displayCurrentQuiz();
        }

        async function showTreeView() {
            showView('tree-view');
            const container = document.getElementById('tree-container');
            container.innerHTML = '지식 체계 로딩 중...';
            const subjectsSnapshot = await db.collection('subjects').orderBy('name').get();
            let treeHTML = '<ul>';
            subjectsSnapshot.forEach(doc => {
                const subject = doc.data();
                treeHTML += `<li class="tree-node subject-node" onclick="toggleSubjectNode(event, '${doc.id}')">${subject.name}</li>`;
            });
            treeHTML += '</ul>';
            container.innerHTML = treeHTML;
        }

        async function toggleSubjectNode(event, subjectId) {
            event.stopPropagation();
            const node = event.currentTarget;
            const childUl = node.querySelector('ul');
            if (childUl) { childUl.remove(); node.classList.remove('expanded'); return; }
            node.classList.add('expanded');
            const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').orderBy('fixedId').get();
            const parts = {};
            questionsSnapshot.forEach(doc => {
                const q = doc.data();
                const part = q.partName || '미지정 파트';
                if (!parts[part]) parts[part] = [];
                parts[part].push(q);
            });
            let subTreeHTML = '<ul>';
            for (const partName in parts) {
                subTreeHTML += `<li class="tree-node part-node">${partName}`;
                subTreeHTML += '<ul>';
                parts[partName].forEach(q => { subTreeHTML += `<li class="tree-node question-node">${q.fixedId}. ${q.text}</li>`; });
                subTreeHTML += '</ul></li>';
            }
            subTreeHTML += '</ul>';
            node.insertAdjacentHTML('beforeend', subTreeHTML);
        }
        
        function toggleFeedbackMode(isEnabled) { immediateFeedbackMode = isEnabled; }

        async function recordConfidence(questionId, level) {
            const user = auth.currentUser; if (!user) return;
            const confidenceRef = db.collection('users').doc(user.uid).collection('confidenceRatings').doc(questionId);
            try {
                await confidenceRef.set({
                    level: level,
                    subjectId: currentSubjectId,
                    partName: questions[currentQuiz].partName,
                    ratedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.querySelector('.confidence-buttons').innerHTML = `<p><em>자신감도를 기록했습니다.</em></p>`;
            } catch(e) { console.error("자신감도 기록 오류:", e); alert('자신감도 기록 중 오류가 발생했습니다.'); }
        }

        async function checkBookmarkStatus(questionId) {
            const user = auth.currentUser; if (!user || !questionId) return false;
            const doc = await db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId).get();
            return doc.exists;
        }

        async function toggleBookmark(questionId) {
            const user = auth.currentUser; if (!user || !questionId) return;
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const bookmarkRef = db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId);
            const isBookmarked = await checkBookmarkStatus(questionId);
            if (isBookmarked) { await bookmarkRef.delete(); bookmarkToggle.textContent = '☆'; } 
            else { await bookmarkRef.set({ subjectId: currentSubjectId, subjectName: currentSubjectData.name, addedAt: firebase.firestore.FieldValue.serverTimestamp() }); bookmarkToggle.textContent = '★'; }
        }

        async function showBookmarkView() {
            showView('bookmark-view');
            const container = document.getElementById('bookmark-list-container');
            container.innerHTML = '북마크 로딩 중...';
            const user = auth.currentUser; if (!user) return;
            const snapshot = await db.collection('users').doc(user.uid).collection('bookmarks').orderBy('addedAt', 'desc').get();
            if (snapshot.empty) { container.innerHTML = '<p>북마크한 문제가 없습니다.</p>'; return; }
            container.innerHTML = '';
            for (const doc of snapshot.docs) {
                const bookmark = doc.data();
                if (!bookmark.subjectId) continue;
                try {
                    const questionDoc = await db.collection('subjects').doc(bookmark.subjectId).collection('questions').doc(doc.id).get();
                    if (questionDoc.exists) {
                        const question = questionDoc.data();
                        const item = document.createElement('div');
                        item.className = 'question-item'; item.style.cursor = 'pointer';
                        item.onclick = () => {
                             selectSubject(bookmark.subjectId, { name: bookmark.subjectName, partOrder: currentSubjectData.partOrder });
                             loadQuestionsForSubject(doc.id);
                        };
                        item.innerHTML = `<span class="question-item-text">${question.fixedId || ''} ${question.text}</span><span class="question-item-part">(${bookmark.subjectName})</span>`;
                        container.appendChild(item);
                    }
                } catch (e) { console.error(`북마크된 문제(${doc.id}) 로딩 실패:`, e); }
            }
        }
        
        async function showManagementView() {
            showView('management-view');
            document.getElementById('management-header').textContent = `[${currentSubjectData.name}] 문제 관리`;
            const partFilter = document.getElementById('part-filter');
            const currentFilterValue = partFilter.value;
            partFilter.innerHTML = '<option value="all">-- 전체 파트 --</option>';
            (currentSubjectData.partOrder || []).forEach(part => { const option = document.createElement('option'); option.value = part; option.textContent = part; partFilter.appendChild(option); });
            partFilter.value = currentFilterValue || 'all';
            const container = document.getElementById('question-list-container'); container.innerHTML = '로딩 중...';
            updateSelectionActions();
            document.getElementById('select-all-checkbox').checked = false;
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('fixedId').get();
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const selectedPart = partFilter.value;
            displayedQuestions = selectedPart === 'all' ? questions : questions.filter(q => q.partName === selectedPart);
            container.innerHTML = '';
            if (displayedQuestions.length === 0) { container.innerHTML = '<p>해당 파트에 문제가 없습니다.</p>'; }
            displayedQuestions.forEach(q => {
                const item = document.createElement('div'); item.className = 'question-item';
                item.innerHTML = `<input type="checkbox" class="question-checkbox" value="${q.id}" data-fixed-id="${q.fixedId}" onchange="updateSelectionActions()"><span class="question-item-text">${q.fixedId || '(ID 없음)'}. ${q.text}</span><span class="question-item-part">(${q.partName || '파트 없음'})</span><div><button class="button light-button" onclick="showEditForm('${q.id}')">수정</button></div>`;
                container.appendChild(item);
            });
        }

        function updateSelectionActions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const actionsDiv = document.getElementById('management-actions');
            const countSpan = document.getElementById('selection-count');
            actionsDiv.classList.toggle('hidden', selected.length === 0);
            if (selected.length > 0) {
                countSpan.textContent = `${selected.length}개 선택됨`;
            }
            if (selected.length === 0) {
                document.getElementById('select-all-checkbox').checked = false;
            }
        }

        function toggleSelectAll(checked) { document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = checked); updateSelectionActions(); }

        async function deleteSelectedQuestions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            if (selected.length === 0 || !confirm(`${selected.length}개의 문제를 삭제하시겠습니까?`)) return;
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const batch = db.batch();
            selected.forEach(cb => batch.delete(subjectRef.collection('questions').doc(cb.value)));
            batch.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(-selected.length) });
            await batch.commit();
            currentSubjectData.questionCount -= selected.length;
            showManagementView();
        }

        function showMoveDialog() {
            if (document.querySelectorAll('.question-checkbox:checked').length === 0) { alert('이동할 문제를 선택해주세요.'); return; }
            const select = document.getElementById('target-part'); select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => { const opt = document.createElement('option'); opt.value = part; opt.textContent = part; select.appendChild(opt); });
            showView('move-question-view');
        }

        async function executeMove() {
            const newPartName = document.getElementById('target-part').value;
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const batch = db.batch();
            selected.forEach(cb => { batch.update(db.collection('subjects').doc(currentSubjectId).collection('questions').doc(cb.value), { partName: newPartName }); });
            await batch.commit();
            alert(`${selected.length}개의 문제를 '${newPartName}' 파트로 이동했습니다.`);
            showManagementView();
        }

        async function startWeaknessQuiz() {
            const user = auth.currentUser;
            if (!user) {
                alert('로그인이 필요합니다.');
                return;
            }

            const quizBody = document.getElementById('quiz-body');
            quizBody.innerHTML = '<p>취약점 분석 중...</p>';

            try {
                const ratingsSnapshot = await db.collection('users').doc(user.uid).collection('confidenceRatings')
                    .where('subjectId', '==', currentSubjectId)
                    .where('level', 'in', ['unsure', 'guess'])
                    .get();

                if (ratingsSnapshot.empty) {
                    quizBody.innerHTML = '<h2>🎉 이 과목에는 등록된 취약점이 없습니다!</h2><p>퀴즈를 풀며 자신감도를 기록해보세요.</p>';
                    return;
                }

                const weakQuestionIds = ratingsSnapshot.docs.map(doc => doc.id);
                
                const fetchPromises = [];
                for (let i = 0; i < weakQuestionIds.length; i += 10) {
                    const chunk = weakQuestionIds.slice(i, i + 10);
                    fetchPromises.push(
                        db.collection('subjects').doc(currentSubjectId).collection('questions')
                        .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
                        .get()
                    );
                }
                
                const questionSnapshots = await Promise.all(fetchPromises);
                
                const weakQuestions = [];
                questionSnapshots.forEach(snapshot => {
                    snapshot.forEach(doc => weakQuestions.push({ id: doc.id, ...doc.data() }));
                });

                if (weakQuestions.length === 0) {
                    quizBody.innerHTML = '<h2>문제를 찾을 수 없습니다.</h2><p>삭제되었거나 ID가 변경된 문제일 수 있습니다.</p>';
                    return;
                }

                questions = weakQuestions.sort((a, b) => (a.fixedId > b.fixedId) ? 1 : -1);
                score = 0;
                currentQuiz = 0;
                document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] 취약점 공략`;
                await displayCurrentQuiz();

            } catch (error) {
                console.error("취약점 퀴즈 로딩 중 오류:", error);
                quizBody.innerHTML = '<p>취약점 문제를 불러오는 중 오류가 발생했습니다.</p>';
            }
        }

        function showAddForm() { showEditForm(null); }
        
        function showEditForm(id) {
            const isEditing = !!id;
            const q = isEditing ? allQuestionsForSubject.find(q => q.id === id) : {};
            document.getElementById('add-edit-header').textContent = isEditing ? '키워드 수정' : '새 키워드 추가';
            document.getElementById('editing-question-id').value = id || '';
            document.getElementById('q-keyword').value = q.keyword || q.text || '';
            document.getElementById('q-answer').value = q.answer || '';
            document.getElementById('q-explanation').value = q.explanation || '';
            populatePartSelect(q.partName);
            const tagsContainer = document.getElementById('q-tags-container');
            tagsContainer.innerHTML = '';
            addTagField(); // 기본으로 빈 태그 필드 하나 추가
            if(q.tags) q.tags.forEach((tag, index) => {
                if(index === 0) { // 첫번째 태그는 기본 필드에 값 설정
                    tagsContainer.querySelector('.tag-meta').value = tag.meta;
                    tagsContainer.querySelector('.tag-value').value = tag.value;
                } else {
                    addTagField(tag.meta, tag.value);
                }
            });
            const optsContainer = document.getElementById('q-options-container');
            optsContainer.innerHTML = '';
            addOptionField(); // 기본으로 빈 보기 필드 하나 추가
            if(q.options) q.options.forEach((opt, index) => {
                if(index === 0) {
                    optsContainer.querySelector('input').value = opt;
                } else {
                    addOptionField(opt);
                }
            });
            document.getElementById('save-btn').onclick = saveQuestion;
            showView('add-edit-view');
        }

        async function saveQuestion() {
            const id = document.getElementById('editing-question-id').value;
            const tags = [];
            document.querySelectorAll('#q-tags-container .tag-group').forEach(group => {
                const meta = group.querySelector('.tag-meta').value.trim();
                const value = group.querySelector('.tag-value').value.trim();
                if (meta && value) { tags.push({ meta, value }); }
            });

            const data = { 
                keyword: document.getElementById('q-keyword').value.trim(),
                text: document.getElementById('q-keyword').value.trim(),
                answer: document.getElementById('q-answer').value.trim(), 
                explanation: document.getElementById('q-explanation').value.trim(), 
                partName: document.getElementById('q-part').value, 
                options: Array.from(document.querySelectorAll('#q-options-container input')).map(i => i.value.trim()).filter(Boolean),
                tags: tags
            };
            
            if (!data.keyword || !data.answer || !data.partName) { alert("키워드, 정답, 소속 파트는 필수 항목입니다."); return; }
            if (id) { 
                await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(data); 
                alert('키워드가 수정되었습니다.');
            } else { 
                const subjectRef = db.collection('subjects').doc(currentSubjectId);
                try {
                    await db.runTransaction(async t => {
                        const doc = await t.get(subjectRef);
                        const subjectData = doc.data();
                        const partCode = subjectData.partCodes[data.partName];
                        if (!partCode) throw new Error(`'${data.partName}'에 해당하는 파트 코드가 없습니다.`);
                        const newCount = (subjectData.partCounters[partCode] || 0) + 1;
                        const paddedCount = String(newCount).padStart(3, '0');
                        data.fixedId = `${subjectData.subjectCode}-${partCode}-${paddedCount}`;
                        t.set(subjectRef.collection('questions').doc(), data);
                        t.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(1), [`partCounters.${partCode}`]: newCount });
                    });
                    currentSubjectData.questionCount++;
                    alert('키워드가 추가되었습니다. 고유 ID: ' + data.fixedId);
                } catch (error) { console.error("키워드 추가 오류:", error); alert("고유 ID 생성 중 오류가 발생했습니다."); return; }
            }
            await showManagementView();
        }
        
        function selectByRange() {
            const rangeStr = document.getElementById('range-select-input').value; if (!rangeStr.trim()) return;
            const allCheckboxes = Array.from(document.querySelectorAll('.question-checkbox')); const indicesToSelect = new Set();
            rangeStr.split(',').forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(num => parseInt(num.trim(), 10));
                    if (!isNaN(start) && !isNaN(end)) { for (let i = start; i <= end; i++) indicesToSelect.add(i); }
                } else { const num = parseInt(part, 10); if (!isNaN(num)) indicesToSelect.add(num); }
            });
            displayedQuestions.forEach(q => {
                if (!q.fixedId) return;
                const idNum = parseInt(q.fixedId.split('-')[2], 10);
                if (indicesToSelect.has(idNum)) {
                    const checkbox = allCheckboxes.find(cb => cb.value === q.id);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateSelectionActions();
        }

        async function addBulkQuestions() {
            const blocks = document.getElementById('bulk-text').value.trim().split('---');
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            let count = 0;
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef); const subjectData = doc.data();
                const defaultPart = (subjectData.partOrder || ['일반'])[0];
                let currentCounters = { ...subjectData.partCounters };
                blocks.forEach(block => {
                    if (!block.trim()) return; const lines = block.trim().split('\n');
                    const data = { options: [], partName: defaultPart, text: '', answer: '' };
                    lines.forEach(line => {
                         if (line.toLowerCase().startsWith('문제:')) data.text = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('보기:')) data.options = line.substring(3).trim().split(',').map(s => s.trim());
                         else if (line.toLowerCase().startsWith('정답:')) data.answer = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('해설:')) data.explanation = line.substring(3).trim();
                    });
                    if (data.text && data.answer) {
                        const partCode = subjectData.partCodes[data.partName];
                        if(partCode) {
                            const newCount = (currentCounters[partCode] || 0) + 1;
                            data.fixedId = `${subjectData.subjectCode}-${partCode}-${String(newCount).padStart(3, '0')}`;
                            currentCounters[partCode] = newCount;
                        }
                        t.set(subjectRef.collection('questions').doc(), data); 
                        count++; 
                    }
                });
                t.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(count), partCounters: currentCounters });
            });
            if (count > 0) { currentSubjectData.questionCount += count; alert(`${count}개의 문제가 추가되었습니다.`); showManagementView(); }
             else { alert('추가할 문제를 찾지 못했습니다. 양식을 확인해주세요.'); }
        }

        function addTagField(meta = '', value = '') {
            const container = document.getElementById('q-tags-container');
            const div = document.createElement('div');
            div.className = 'tag-group';
            div.innerHTML = `<input type="text" class="tag-meta" placeholder="메타태그 (예: 위치)" value="${meta}"><input type="text" class="tag-value" placeholder="태그값 (예: 명장동)" value="${value}">`;
            container.appendChild(div);
        }
        
        function addOptionField(value = '') {
            const container = document.getElementById('q-options-container');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-group';
            input.style.marginBottom = '10px';
            input.value = value;
            container.appendChild(input);
        }

        function populatePartSelect(selectedValue) {
            const select = document.getElementById('q-part');
            select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const opt = document.createElement('option');
                opt.value = part;
                opt.textContent = part;
                if (part === selectedValue) opt.selected = true;
                select.appendChild(opt);
            });
        }
        
    </script>
</body>
</html>
