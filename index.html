<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #212529; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .button { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 5px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: bold; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .danger-button { background-color: #dc3545; color: white; border-color: #dc3545; }
        #auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        #auth-container button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }
        #auth-container span { font-size: 0.9em; margin-right: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em;}
        #management-actions { border: 1px solid #0d6efd; background-color: #e7f1ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .question-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .question-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.2); }
        .question-item-text { flex-grow: 1; margin-right: 10px; }
        .question-item .button { width: auto; padding: 5px 10px; font-size: 0.9em; margin-top: 0; margin-left: 5px;}
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .feedback p { margin: 5px 0; }
        .mode-toggle { display: flex; justify-content: flex-end; align-items: center; font-size: 0.9em; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">ë¡œê·¸ì¸</button><button class="button primary-button" onclick="showView('signup-view')">íšŒì›ê°€ì…</button></div>
            <div id="logged-in-view" class="hidden"><span id="user-email"></span><button class="button secondary-button" onclick="logOut()">ë¡œê·¸ì•„ì›ƒ</button></div>
        </div>

        <div id="subject-view"> <h2>ê³¼ëª© ì„ íƒ</h2> <div id="subject-list"></div> </div>
        <div id="signup-view" class="hidden"><h2>íšŒì›ê°€ì…</h2><div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email"></div><div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)</label><input type="password" id="signup-password"></div><button class="button primary-button" onclick="signUp()">íšŒì›ê°€ì…</button><button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button></div>
        <div id="login-view" class="hidden"><h2>ë¡œê·¸ì¸</h2><div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email"></div><div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password"></div><button class="button primary-button" onclick="logIn()">ë¡œê·¸ì¸</button><button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button></div>
        <div id="quiz-view" class="hidden"><div class="mode-toggle"><label for="feedback-toggle">ì¦‰ì‹œ ê²°ê³¼ í™•ì¸</label><input type="checkbox" id="feedback-toggle" onchange="toggleFeedbackMode(this.checked)" style="margin-left: 5px;"></div><h2 id="quiz-header"></h2><div id="quiz-body"></div><hr style="margin: 20px 0;"><button class="button secondary-button" onclick="showManagementView()">ğŸ“‹ ë¬¸ì œ ê´€ë¦¬</button><button class="button light-button" onclick="showView('subject-view')">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button></div>
        <div id="management-view" class="hidden"><h2 id="management-header"></h2><button class="button primary-button" onclick="showAddForm()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button><button class="button primary-button" onclick="showView('bulk-add-view')">+ ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</button><hr><div id="management-actions" class="hidden"><span id="selection-count"></span>ê°œ ì„ íƒë¨<button class="button danger-button" style="width:auto; float:right;" onclick="deleteSelectedQuestions()">ì„ íƒ í•­ëª© ì‚­ì œ</button></div><div style="padding: 5px;"><input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll(this.checked)"> <label for="select-all-checkbox">ì „ì²´ ì„ íƒ</label></div><div id="question-list-container"></div><button class="button light-button" onclick="showView('quiz-view')">â† í€´ì¦ˆ í™”ë©´ìœ¼ë¡œ</button></div>
        <div id="add-edit-view" class="hidden"><h2 id="add-edit-header"></h2><input type="hidden" id="editing-question-id"><div class="form-group"><label for="q-text">ë¬¸ì œ</label><textarea id="q-text" rows="3"></textarea></div><div class="form-group"><label for="q-answer">ì •ë‹µ</label><input type="text" id="q-answer"></div><div class="form-group"><label for="q-explanation">í•´ì„¤</label><textarea id="q-explanation" rows="3"></textarea></div><div class="form-group"><label for="q-part">íŒŒíŠ¸</label><select id="q-part"></select></div><div class="form-group"><label>ë³´ê¸°</label><div id="q-options-container"></div><button class="light-button" style="width: auto; padding: 5px 10px; font-size: 0.9em;" onclick="addOptionField()">ë³´ê¸° í•„ë“œ ì¶”ê°€</button></div><button id="save-btn" class="button primary-button">ì €ì¥</button><button class="button light-button" onclick="showView('management-view')">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button></div>
        <div id="bulk-add-view" class="hidden"><h2>ğŸ“š ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</h2><div class="form-group"><textarea id="bulk-text" rows="10" placeholder="..."></textarea></div><button class="button primary-button" onclick="addBulkQuestions()">DBì— ì €ì¥</button><button class="button light-button" onclick="showView('management-view')">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentSubjectId, currentSubjectData, currentView;
        let questions = [], currentQuiz = 0, score = 0, selectedOption = null;
        let immediateFeedbackMode = false;
        const views = ['subject-view', 'quiz-view', 'management-view', 'add-edit-view', 'bulk-add-view', 'signup-view', 'login-view'];

        function showView(viewId) { currentView = viewId; views.forEach(id => document.getElementById(id).classList.toggle('hidden', id !== viewId)); }
        
        auth.onAuthStateChanged(user => {
            document.getElementById('logged-in-view').classList.toggle('hidden', !user);
            document.getElementById('logged-out-view').classList.toggle('hidden', !!user);
            if (user) { document.getElementById('user-email').textContent = `${user.email}ë‹˜`; loadSubjects(); } 
            else { showView('subject-view'); document.getElementById('subject-list').innerHTML = '<p>ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>'; }
        });
        
        async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        function logOut() { auth.signOut(); }

        async function loadSubjects() {
            const listDiv = document.getElementById('subject-list'); listDiv.innerHTML = 'ê³¼ëª© ë¡œë”© ì¤‘...';
            const snapshot = await db.collection('subjects').orderBy('name').get(); listDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const subject = doc.data(); const button = document.createElement('button');
                button.textContent = `${subject.name} (${subject.questionCount || 0}ë¬¸ì œ)`; button.className = 'button light-button';
                button.onclick = () => selectSubject(doc.id, subject); listDiv.appendChild(button);
            });
        }
        
        function selectSubject(id, data) {
            currentSubjectId = id; currentSubjectData = data;
            document.getElementById('quiz-header').textContent = `${data.name} í€´ì¦ˆ`;
            showView('quiz-view'); loadQuestionsForSubject();
        }

        async function loadQuestionsForSubject() {
            const quizBody = document.getElementById('quiz-body'); quizBody.innerHTML = '<p>ë¬¸ì œ ë¡œë”© ì¤‘...</p>';
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            currentQuiz = 0; score = 0; displayCurrentQuiz();
        }

        function displayCurrentQuiz() {
            const quizBody = document.getElementById('quiz-body'); selectedOption = null;
            document.getElementById('feedback-toggle').checked = immediateFeedbackMode;
            if (questions.length === 0) { quizBody.innerHTML = "<p>ì´ ê³¼ëª©ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
            if (currentQuiz >= questions.length) { quizBody.innerHTML = `<h2>í€´ì¦ˆ ê²°ê³¼: ${score}/${questions.length}</h2><button class="button primary-button" onclick="loadQuestionsForSubject()">ë‹¤ì‹œ í’€ê¸°</button>`; return; }
            quizBody.innerHTML = `<div id="question"></div><ul id="options-container" class="options-container"></ul><div id="immediate-feedback"></div><button id="submit-btn" class="button primary-button">ì •ë‹µ ì œì¶œ</button>`;
            const qEl = document.getElementById('question'), optsEl = document.getElementById('options-container'), submitBtn = document.getElementById('submit-btn');
            const data = questions[currentQuiz]; qEl.textContent = `${currentQuiz + 1}. ${data.text}`;
            data.options.forEach(opt => {
                const li = document.createElement('li'); li.className = 'option'; li.textContent = opt;
                li.onclick = () => { document.querySelector('.option.selected')?.classList.remove('selected'); li.classList.add('selected'); selectedOption = opt; };
                optsEl.appendChild(li);
            });
            submitBtn.onclick = submitAnswer;
        }

        function submitAnswer() {
            if (!selectedOption) { alert("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
            const data = questions[currentQuiz]; const isCorrect = selectedOption === data.answer;
            if (immediateFeedbackMode) {
                const feedbackDiv = document.getElementById('immediate-feedback'), options = document.querySelectorAll('.option');
                feedbackDiv.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
                let feedbackHTML = `<p><strong>${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'ì˜¤ë‹µì…ë‹ˆë‹¤.'}</strong></p>`;
                if (!isCorrect) feedbackHTML += `<p>ì •ë‹µ: ${data.answer}</p>`;
                if (data.explanation) feedbackHTML += `<p>í•´ì„¤: ${data.explanation}</p>`;
                feedbackDiv.innerHTML = feedbackHTML;
                options.forEach(opt => { opt.onclick = null; if (opt.textContent === data.answer) opt.style.borderColor = '#198754'; else if (opt.textContent === selectedOption) opt.style.borderColor = '#dc3545'; });
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.textContent = 'ë‹¤ìŒ ë¬¸ì œ â†’'; submitBtn.onclick = () => { currentQuiz++; displayCurrentQuiz(); };
            } else { if (isCorrect) score++; currentQuiz++; displayCurrentQuiz(); }
        }
        
        function toggleFeedbackMode(isEnabled) { immediateFeedbackMode = isEnabled; }

        async function showManagementView() {
            showView('management-view');
            document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
            const container = document.getElementById('question-list-container'); container.innerHTML = 'ë¡œë”© ì¤‘...';
            updateSelectionActions();
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('text').get();
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); container.innerHTML = '';
            questions.forEach(q => {
                const item = document.createElement('div'); item.className = 'question-item';
                item.innerHTML = `<input type="checkbox" class="question-checkbox" value="${q.id}" onchange="updateSelectionActions()"><span class="question-item-text">${q.text}</span><div><button class="button light-button" onclick="showEditForm('${q.id}')">ìˆ˜ì •</button></div>`;
                container.appendChild(item);
            });
        }

        function updateSelectionActions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const actionsDiv = document.getElementById('management-actions');
            if (actionsDiv) {
                actionsDiv.classList.toggle('hidden', selected.length === 0);
                document.getElementById('selection-count').textContent = selected.length;
            }
        }

        function toggleSelectAll(checked) {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = checked);
            updateSelectionActions();
        }

        async function deleteSelectedQuestions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            if (selected.length === 0 || !confirm(`${selected.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const batch = db.batch();
            selected.forEach(cb => batch.delete(subjectRef.collection('questions').doc(cb.value)));
            const newCount = (currentSubjectData.questionCount || 0) - selected.length;
            batch.update(subjectRef, { questionCount: newCount });
            await batch.commit();
            currentSubjectData.questionCount = newCount;
            showManagementView();
        }

        function showAddForm() { showEditForm(null); }
        function showEditForm(id) {
            const isEditing = !!id, q = isEditing ? questions.find(q => q.id === id) : {};
            document.getElementById('add-edit-header').textContent = isEditing ? 'ë¬¸ì œ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
            document.getElementById('editing-question-id').value = id || '';
            document.getElementById('q-text').value = q.text || '';
            document.getElementById('q-answer').value = q.answer || '';
            document.getElementById('q-explanation').value = q.explanation || '';
            populatePartSelect(q.partName);
            const optsContainer = document.getElementById('q-options-container'); optsContainer.innerHTML = '';
            (q.options || ['', '']).forEach(opt => addOptionField(opt));
            document.getElementById('save-btn').onclick = saveQuestion;
            showView('add-edit-view');
        }

        async function saveQuestion() {
            const id = document.getElementById('editing-question-id').value;
            const data = { text: document.getElementById('q-text').value.trim(), answer: document.getElementById('q-answer').value.trim(), explanation: document.getElementById('q-explanation').value.trim(), partName: document.getElementById('q-part').value, options: Array.from(document.querySelectorAll('#q-options-container input')).map(i => i.value.trim()).filter(Boolean) };
            if (!data.text || !data.answer || !data.partName) { alert("ë¬¸ì œ, ì •ë‹µ, íŒŒíŠ¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤."); return; }
            if (id) { await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(data); } 
            else { const subjectRef = db.collection('subjects').doc(currentSubjectId); await db.runTransaction(async t => { const doc = await t.get(subjectRef); t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + 1 }); t.set(subjectRef.collection('questions').doc(), data); }); currentSubjectData.questionCount++; }
            showManagementView();
        }

        async function addBulkQuestions() {
            const blocks = document.getElementById('bulk-text').value.trim().split('---');
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const questionsRef = subjectRef.collection('questions'); let count = 0;
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef); const defaultPart = (doc.data().partOrder || ['ì¼ë°˜'])[0];
                blocks.forEach(block => {
                    if (!block.trim()) return; const lines = block.trim().split('\n'); const data = { options: [], partName: defaultPart };
                    lines.forEach(line => {
                         if (line.toLowerCase().startsWith('ë¬¸ì œ:')) data.text = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('ë³´ê¸°:')) data.options = line.substring(3).trim().split(',').map(s => s.trim());
                         else if (line.toLowerCase().startsWith('ì •ë‹µ:')) data.answer = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('í•´ì„¤:')) data.explanation = line.substring(3).trim();
                    });
                    if (data.text && data.answer) { t.set(questionsRef.doc(), data); count++; }
                });
                t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + count });
            });
            if (count > 0) { currentSubjectData.questionCount += count; alert(`${count}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`); showManagementView(); }
             else { alert('ì¶”ê°€í•  ë¬¸ì œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
        }
        
        function addOptionField(value = '') { const container = document.getElementById('q-options-container'); const input = document.createElement('input'); input.type = 'text'; input.style.cssText='width:100%;padding:10px;margin-bottom:5px;box-sizing:border-box;border:1px solid #ccc;border-radius:5px;'; input.value = value; container.appendChild(input); }
        function populatePartSelect(selectedValue) { const select = document.getElementById('q-part'); select.innerHTML = ''; (currentSubjectData.partOrder || []).forEach(part => { const opt = document.createElement('option'); opt.value = part; opt.textContent = part; if (part === selectedValue) opt.selected = true; select.appendChild(opt); }); }
        
    </script>
</body>
</html>
