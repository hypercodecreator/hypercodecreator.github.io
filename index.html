<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        /* ê¸°ë³¸ & ë ˆì´ì•„ì›ƒ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* ë²„íŠ¼ */
        .button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: 600; transition: all 0.2s ease-in-out; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .primary-button:hover { background-color: #0b5ed7; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .light-button:hover { background-color: #e2e6ea; }
        .small-button { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; }

        /* ìƒë‹¨ ì¸ì¦ ì˜ì—­ */
        #auth-container { display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        #auth-container span { margin-right: auto; font-size: 0.9em; color: #555; }
        #auth-container .button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }

        /* í”¼ë“œë°± ë°” */
        #feedback-bar { padding: 12px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; }
        #feedback-bar.success { background-color: #d1e7dd; color: #0f5132; }
        #feedback-bar.error { background-color: #f8d7da; color: #842029; }

        /* í¼ ê·¸ë£¹ & ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ í†µì¼ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; font-family: inherit; }
        .dynamic-field-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .dynamic-field-group .field-label { font-size: 0.9em; color: #6c757d; min-width: 25px; }
        .dynamic-field-group input { flex-grow: 1; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .remove-btn { padding: 5px 10px; font-size: 0.8em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* ëª©í‘œ ì„¤ì • UI */
        #goal-view { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        #goal-view h4 { margin-top: 0; margin-bottom: 15px; }
        .goal-input-group { display: flex; align-items: center; gap: 8px; }
        #goal-view input[type="number"] { width: 80px; text-align: center; }
        #goal-view .button { width: auto; margin: 0; }
        #goal-status { font-weight: 600; font-size: 1.1em; }

        /* ê³¼ëª© ì•„ì´í…œ */
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; }
        .subject-item-name { font-weight: 600; font-size: 1.1rem; }
        .subject-item-buttons { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .subject-item-buttons .button { width: auto; margin: 0; padding: 8px 12px; font-size: 0.9em; }
        .edit-btn, .delete-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.1rem; color: #6c757d; margin-left: 5px; }
        .edit-btn:hover, .delete-btn:hover { color: #212529; }
        .subject-name-input { font-size: 1.1rem; font-weight: 600; border: 1px solid #0d6efd; padding: 5px; border-radius: 4px; }
                
        /* ë¬¸ì œ ê´€ë¦¬ í™”ë©´ & 2ë¶„í•  ë ˆì´ì•„ì›ƒ */
        .management-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .view-toggle-buttons .button { margin-top:0; border-radius: 0; }
        .view-toggle-buttons .button:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .view-toggle-buttons .button:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px; border-left: 0px; }
        #question-list-container.split-view { display: flex; gap: 20px; }
        #concept-tree-panel { flex: 1; min-width: 250px; border: 1px solid #eee; border-radius: 8px; padding: 10px; height: 500px; overflow-y: auto; }
        #problem-list-panel { flex: 2; border: 1px solid #eee; border-radius: 8px; height: 500px; overflow-y: auto; }
        .question-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .question-item:last-child { border-bottom: none; }
        .question-item:hover { background-color: #f8f9fa; }
        .question-item-text { flex-grow: 1; margin-right: 15px; }
        .question-item-actions { display: flex; gap: 10px; }
        .problem-list-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.95em; }
        .problem-list-item:hover { background-color: #f0f2f5; }
        .problem-list-item:last-child { border-bottom: none; }
       
        /* í€´ì¦ˆ í™”ë©´ */
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .final-result { text-align: center; padding: 20px; }
        .final-result h2 { font-size: 2em; margin-bottom: 10px; }
        .final-result p { font-size: 1.2em; }
        
        /* ê°œë… íŠ¸ë¦¬ */
        #concept-tree-panel ul { padding-left: 1em; list-style: none; }
        #concept-tree-panel li { padding: 2px 0; }
        #concept-tree-panel .node { cursor: pointer; padding: 4px; border-radius: 4px; }
        #concept-tree-panel .node:hover { background-color: #f0f2f5; }
        #concept-tree-panel .node.selected { background-color: #0d6efd; color: white; }
        #concept-tree-panel .node-icon { margin-right: 5px; display: inline-block; width: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <div id="feedback-bar" class="hidden"></div>
        
        <div id="auth-container">
            <span id="user-email"></span>
            <div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">ë¡œê·¸ì¸</button><button class="button primary-button" onclick="showView('signup-view')">íšŒì›ê°€ì…</button></div>
            <div id="logged-in-view" class="hidden"><button class="button secondary-button" onclick="logOut()">ë¡œê·¸ì•„ì›ƒ</button></div>
        </div>

        <div id="subject-view">
            <h2>ê³¼ëª© ì„ íƒ</h2>
            <div id="goal-view">
                <h4>ğŸ¯ ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œ</h4>
                <div id="goal-setup-view"><div class="goal-input-group"><input type="number" id="goal-input" min="1" value="10"><button class="button primary-button" onclick="setDailyGoal()">ëª©í‘œ ì„¤ì •</button></div></div>
                <div id="goal-status-view" class="hidden" style="display: flex; align-items: center; gap: 10px;"><span id="goal-status" style="flex-grow: 1;"></span><button class="button light-button small-button" onclick="resetDailyProgress()">ì§„í–‰ë„ 0ìœ¼ë¡œ</button><button class="button light-button small-button" onclick="resetDailyGoal()">ëª©í‘œ ì¬ì„¤ì •</button></div>
            </div>
            <div id="subject-list"></div>
        </div>

        <div id="management-view" class="hidden">
            <h2 id="management-header"></h2>
            <div class="management-controls">
                <div class="view-toggle-buttons" id="view-toggle-buttons"></div>
                <button class="button primary-button" style="margin-top:0; width: auto;" onclick="showFullEditView()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
            </div>
            <div id="question-list-container"></div>
            <button class="button light-button" onclick="showView('subject-view')" style="margin-top: 20px;">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button>
        </div>
            
        <div id="quiz-view" class="hidden"></div>
        <div id="login-view" class="hidden"><h2>ë¡œê·¸ì¸</h2><div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email"></div><div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password"></div><button class="button primary-button" onclick="logIn()">ë¡œê·¸ì¸</button><button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button></div>
        <div id="signup-view" class="hidden"><h2>íšŒì›ê°€ì…</h2><div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email"></div><div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signup-password"></div><button class="button primary-button" onclick="signUp()">íšŒì›ê°€ì…</button><button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button></div>
        
        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            
            <h4>1. ëª©ì°¨ ì •ë³´ (ê³„ì¸µ êµ¬ì¡°)</h4>
            <div class="form-group"><label for="q-part">ëŒ€ë¶„ë¥˜</label><input type="text" id="q-part" placeholder="ì˜ˆ: 1ê³¼ëª© ë°ì´í„°ë² ì´ìŠ¤"></div>
            <div class="form-group"><label for="q-chapter">ì¤‘ë¶„ë¥˜</label><input type="text" id="q-chapter" placeholder="ì˜ˆ: 1ì¥ ì •ê·œí™”"></div>
            <div class="form-group"><label for="q-section">ì†Œë¶„ë¥˜</label><input type="text" id="q-section" placeholder="ì˜ˆ: 1ì ˆ BCNF"></div>
            <hr>

            <h4>2. ë¬¸ì œ ì •ë³´</h4>
            <div class="form-group"><label for="q-text-full">ë¬¸ì œ ë‚´ìš© (í•„ìˆ˜)</label><textarea id="q-text-full" rows="3" placeholder="ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>
            <div class="form-group"><label for="q-answer-full">ì •ë‹µ (í•„ìˆ˜)</label><input type="text" id="q-answer-full" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"></div>
            <div class="form-group"><label for="q-explanation-full">í•´ì„¤</label><textarea id="q-explanation-full" rows="3" placeholder="í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>
            <hr>

            <h4>3. ê°ê´€ì‹ ë³´ê¸°</h4>
            <div id="q-options-container"></div>
            <button class="button light-button small-button" onclick="addDynamicField('option')">+ ë³´ê¸° ì¶”ê°€</button>
            <hr>

            <h4>4. ê°œë… ë¶„ì„ (í‚¤ì›Œë“œ)</h4>
            <div class="form-group"><label>í‚¤ì›Œë“œ</label><div id="q-keywords-container"></div><button class="button light-button small-button" onclick="addDynamicField('keyword')">+ í‚¤ì›Œë“œ ì¶”ê°€</button></div>
            <div class="form-group"><label>íƒœê·¸</label><div id="q-tags-container"></div><button class="button light-button small-button" onclick="addDynamicField('tag')">+ íƒœê·¸ ì¶”ê°€</button></div>
            <div class="form-group"><label>ë©”íƒ€íƒœê·¸</label><div id="q-metatags-container"></div><button class="button light-button small-button" onclick="addDynamicField('metatag')">+ ë©”íƒ€íƒœê·¸ ì¶”ê°€</button></div>
            <hr>
            
            <div style="display:flex; gap: 10px;">
                <button class="button light-button" onclick="showManagementView(false)">ì·¨ì†Œ</button>
                <button id="save-full-btn" class="button primary-button">ì €ì¥</button>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
    const firebaseConfig = {
    apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
          authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
          projectId: "my-cbt-app-2cdb9",
          storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
          messagingSenderId: "1091430877229",
          appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
    };
        
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ì „ì—­ ë³€ìˆ˜
    let currentSubjectId, currentSubjectData, allQuestionsForSubject = [];
    let dailyGoal = 0, dailyProgress = 0;
    let quizQuestions = [], selectedOption, currentQuizIndex = 0, quizScore = 0, quizProblemsAttempted = 0;
    const views = ['subject-view', 'quiz-view', 'management-view', 'login-view', 'signup-view', 'add-edit-view'];
    let currentManagementViewMode = 'list'; 

    // ==================================
    // ## í•µì‹¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ##
    // ==================================
    function showView(viewId) { views.forEach(id => document.getElementById(id)?.classList.toggle('hidden', id !== viewId)); }
    function showFeedback(message, type = 'error') { const feedbackBar = document.getElementById('feedback-bar'); if (!feedbackBar) return; feedbackBar.textContent = message; feedbackBar.className = type; feedbackBar.classList.remove('hidden'); setTimeout(() => feedbackBar.classList.add('hidden'), 3000); }
    
    // ==================================
    // ## ì¸ì¦ ë° ì•± ì‹œì‘ í•¨ìˆ˜ ##
    // ==================================
    auth.onAuthStateChanged(async (user) => { if (user) { document.getElementById('logged-in-view').classList.remove('hidden'); document.getElementById('logged-out-view').classList.add('hidden'); document.getElementById('user-email').textContent = `${user.email}ë‹˜`; await loadSubjects(); } else { document.getElementById('logged-in-view').classList.add('hidden'); document.getElementById('logged-out-view').classList.remove('hidden'); document.getElementById('user-email').textContent = ''; document.getElementById('subject-list').innerHTML = `<p style="text-align:center; padding: 20px;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>`; showView('subject-view'); } });
    async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); showView('subject-view'); } catch (e) { showFeedback(e.message); } }
    async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); showView('subject-view'); } catch (e) { showFeedback(e.message); } }
    function logOut() { auth.signOut(); }
    
    // (í•™ìŠµ ëª©í‘œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ì€ ë³€ê²½ ì—†ìŒ)
    function setDailyGoal() { const goalInput = document.getElementById('goal-input'); const goal = parseInt(goalInput.value, 10); if (isNaN(goal) || goal <= 0) { showFeedback('1 ì´ìƒì˜ ìˆ«ìë¥¼ ëª©í‘œë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; } dailyGoal = goal; dailyProgress = 0; document.getElementById('goal-setup-view').classList.add('hidden'); document.getElementById('goal-status-view').classList.remove('hidden'); updateGoalStatusDisplay(); }
    function resetDailyGoal() { dailyGoal = 0; document.getElementById('goal-status-view').classList.add('hidden'); document.getElementById('goal-setup-view').classList.remove('hidden'); }
    function resetDailyProgress() { dailyProgress = 0; updateGoalStatusDisplay(); showFeedback('ì§„í–‰ë„ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
    function updateGoalStatusDisplay() { const el = document.getElementById('goal-status'); if (el) el.innerHTML = `ì˜¤ëŠ˜ì˜ ëª©í‘œ: <span class="progress">${dailyProgress}</span> / <span class="goal">${dailyGoal}</span> ë¬¸ì œ`; }
    function updateDailyProgress(attemptedCount) { if (dailyGoal <= 0) return; const progressBefore = dailyProgress; dailyProgress += attemptedCount; updateGoalStatusDisplay(); if ((dailyProgress >= dailyGoal) && (progressBefore < dailyGoal)) { showFeedback('ğŸ‰ ì˜¤ëŠ˜ì˜ í†µí•© í•™ìŠµ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ëŒ€ë‹¨í•´ìš”!', 'success'); } }

    // ==================================
    // ## ê³¼ëª© ê´€ë¦¬ í•¨ìˆ˜ ##
    // ==================================
    async function loadSubjects() {
        const listDiv = document.getElementById('subject-list');
        listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ê³¼ëª© ë¡œë”© ì¤‘...</div>';
        try {
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const subject = doc.data(); const subjectId = doc.id; const subjectName = subject.name;
                const item = document.createElement('div'); item.className = 'subject-item';
                item.innerHTML = `
                    <div style="flex-grow: 1;"><div id="subject-name-container-${subjectId}" style="display: flex; align-items: center; gap: 5px;"><span class="subject-item-name">${subjectName} (${subject.questionCount || 0}ë¬¸ì œ)</span></div></div>
                    <div class="subject-item-buttons">
                        <button class="button primary-button" onclick="startQuiz('${subjectId}')">í€´ì¦ˆ ì‹œì‘</button>
                        <button class="button secondary-button" onclick="manageSubject('${subjectId}')">ë¬¸ì œ ê´€ë¦¬</button>
                        <button class="edit-btn" onclick="startEditSubject('${subjectId}', '${subjectName}')">âœï¸</button>
                        <button class="delete-btn" onclick="deleteSubject('${subjectId}', '${subjectName}')">ğŸ—‘ï¸</button>
                    </div>`;
                listDiv.appendChild(item);
            });
            listDiv.insertAdjacentHTML('beforeend', `
                <div id="add-subject-form" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div class="form-group"><label for="new-subject-name" style="font-weight: bold;">ìƒˆ ê³¼ëª© ì´ë¦„</label><input type="text" id="new-subject-name" placeholder="ì˜ˆ: ì •ë³´ì²˜ë¦¬ê¸°ì‚¬ í•„ê¸°"></div>
                    <div style="display: flex; gap: 10px; margin-top: 5px;"><button class="button light-button" style="flex: 1;" onclick="hideAddSubjectForm()">ì·¨ì†Œ</button><button class="button primary-button" style="flex: 1;" onclick="addSubject()">ì €ì¥</button></div>
                </div>
                <button id="add-subject-button" class="button primary-button" onclick="showAddSubjectForm()">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>`);
        } catch (error) { console.error("ê³¼ëª© ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }
    
    async function addSubject() { const input = document.getElementById('new-subject-name'); const subjectName = input.value.trim(); if (!subjectName) { showFeedback('ê³¼ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } try { await db.collection('subjects').add({ name: subjectName, questionCount: 0 }); showFeedback(`'${subjectName}' ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success'); hideAddSubjectForm(); await loadSubjects(); } catch (error) { console.error("ê³¼ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); } }
    function showAddSubjectForm() { document.getElementById('add-subject-form').classList.remove('hidden'); document.getElementById('add-subject-button').classList.add('hidden'); }
    function hideAddSubjectForm() { document.getElementById('add-subject-form').classList.add('hidden'); document.getElementById('new-subject-name').value = ''; document.getElementById('add-subject-button').classList.remove('hidden'); }

    function startEditSubject(subjectId, currentName) {
        if (document.querySelector('.subject-name-input')) { cancelEdit(); return; }
        const nameContainer = document.getElementById(`subject-name-container-${subjectId}`);
        const buttonsContainer = nameContainer.closest('.subject-item').querySelector('.subject-item-buttons');
        nameContainer.innerHTML = `<input type="text" id="edit-subject-input-${subjectId}" class="subject-name-input" value="${currentName}">`;
        buttonsContainer.innerHTML = `<button class="button light-button small-button" onclick="cancelEdit()">ì·¨ì†Œ</button><button class="button primary-button small-button" onclick="saveSubjectUpdate('${subjectId}')">ì €ì¥</button>`;
        document.getElementById(`edit-subject-input-${subjectId}`).focus();
    }

    async function saveSubjectUpdate(subjectId) { const input = document.getElementById(`edit-subject-input-${subjectId}`); const newName = input.value.trim(); if (!newName) { showFeedback("ê³¼ëª© ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; } try { await db.collection('subjects').doc(subjectId).update({ name: newName }); showFeedback("ê³¼ëª© ì´ë¦„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); } catch (error) { console.error("ê³¼ëª© ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:", error); showFeedback("ê³¼ëª© ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } await loadSubjects(); }
    function cancelEdit() { loadSubjects(); }
    async function deleteSubject(subjectId, subjectName) { if (!confirm(`'${subjectName}' ê³¼ëª©ê³¼ ëª¨ë“  ë¬¸ì œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; showFeedback(`'${subjectName}' ê³¼ëª©ì„ ì‚­ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤...`); try { const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get(); const batch = db.batch(); questionsSnapshot.forEach(doc => batch.delete(doc.ref)); const subjectRef = db.collection('subjects').doc(subjectId); batch.delete(subjectRef); await batch.commit(); showFeedback(`'${subjectName}' ê³¼ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success'); await loadSubjects(); } catch (error) { console.error("ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); } }

    // ==================================
    // ## ë¬¸ì œ ê´€ë¦¬(Management View) í•¨ìˆ˜ ##
    // ==================================
    async function manageSubject(id) {
        const doc = await db.collection('subjects').doc(id).get();
        if (!doc.exists) { showFeedback("ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        currentSubjectId = id;
        currentSubjectData = doc.data();
        await showManagementView(true);
    }

    function setManagementViewMode(mode) {
        currentManagementViewMode = mode;
        showManagementView(false);
    }

    async function showManagementView(fetchData = false) {
        showView('management-view');
        document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
        const container = document.getElementById('question-list-container');
        
        document.getElementById('view-toggle-buttons').innerHTML = `
            <button class="button ${currentManagementViewMode === 'list' ? 'primary-button' : 'light-button'}" onclick="setManagementViewMode('list')">ëª©ë¡ ë³´ê¸°</button>
            <button class="button ${currentManagementViewMode === 'tree' ? 'primary-button' : 'light-button'}" onclick="setManagementViewMode('tree')">ê°œë… íŠ¸ë¦¬</button>
        `;
        
        if (fetchData) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ë¬¸ì œ ëª©ë¡ ë¡œë”© ì¤‘...</div>';
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        container.innerHTML = '';
        container.className = ''; 

        if (allQuestionsForSubject.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        if (currentManagementViewMode === 'list') {
            const listContainer = document.createElement('div');
            listContainer.style.border = '1px solid #eee'; listContainer.style.borderRadius = '8px';
            allQuestionsForSubject.sort((a,b) => a.text.localeCompare(b.text)).forEach(q => {
                const item = document.createElement('div'); item.className = 'question-item';
                item.innerHTML = `<div class="question-item-text">${q.text}</div><div class="question-item-actions"><button class="button light-button small-button" onclick="showFullEditView('${q.id}')">ìˆ˜ì •</button><button class="button light-button small-button" onclick="deleteProblem('${q.id}')">ì‚­ì œ</button></div>`;
                listContainer.appendChild(item);
            });
            container.appendChild(listContainer);
        } else {
            container.className = 'split-view';
            container.innerHTML = `<div id="concept-tree-panel"></div><div id="problem-list-panel"><p style="color:#888; text-align:center;">â† ì™¼ìª½ì—ì„œ ê°œë…ì„ ì„ íƒí•˜ì„¸ìš”.</p></div>`;
            const conceptTreeData = buildConceptTreeData(allQuestionsForSubject);
            renderConceptTree(conceptTreeData);
        }
    }
    
    function buildConceptTreeData(questions) {
        const tree = {};
        questions.forEach(q => {
            (q.keywords || []).forEach(kw => {
                if (!tree[kw]) tree[kw] = { tags: {} };
                (q.tags || []).forEach(tag => {
                    if (!tree[kw].tags[tag]) tree[kw].tags[tag] = { metatags: {} };
                    (q.metatags || []).forEach(mt => {
                        if (!tree[kw].tags[tag].metatags[mt]) tree[kw].tags[tag].metatags[mt] = {};
                    });
                });
            });
        });
        return tree;
    }

    function renderConceptTree(treeData) {
        const panel = document.getElementById('concept-tree-panel');
        let html = '<ul>';
        for (const kw of Object.keys(treeData).sort()) {
            html += `<li><div class="node" onclick="renderProblemListForConcept(this, 'keyword', '${kw}')"><span class="node-icon">â–¶</span>${kw}</div><ul>`;
            const tags = treeData[kw].tags;
            for (const tag of Object.keys(tags).sort()) {
                html += `<li><div class="node" onclick="renderProblemListForConcept(this, 'tag', '${tag}')"><span class="node-icon">â–¶</span>${tag}</div><ul>`;
                const metatags = tags[tag].metatags;
                for (const mt of Object.keys(metatags).sort()) {
                    html += `<li><div class="node" onclick="renderProblemListForConcept(this, 'metatag', '${mt}')"><span class="node-icon">â–·</span>${mt}</div></li>`;
                }
                html += `</ul></li>`;
            }
            html += `</ul></li>`;
        }
        html += '</ul>';
        panel.innerHTML = html;
    }

    // âœ¨ ìˆ˜ì •: í´ë¦­ëœ ë…¸ë“œë¥¼ ì •í™•íˆ ì„ íƒí•˜ë„ë¡ 'element' ì¸ì ì¶”ê°€
    function renderProblemListForConcept(element, type, name) {
        const panel = document.getElementById('problem-list-panel');
        document.querySelectorAll('#concept-tree-panel .node').forEach(node => node.classList.remove('selected'));
        if (element) element.classList.add('selected');
        
        const filteredQuestions = allQuestionsForSubject.filter(q => q[type + 's'] && q[type + 's'].includes(name));
        if (filteredQuestions.length === 0) {
            panel.innerHTML = `<p style="color:#888; text-align:center;">'${name}'ì„(ë¥¼) í¬í•¨í•˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }
        let html = '';
        filteredQuestions.forEach(q => { html += `<div class="problem-list-item" onclick="showFullEditView('${q.id}')">${q.text}</div>`; });
        panel.innerHTML = html;
    }

    function showFullEditView(questionId = null) {
        showView('add-edit-view');
        const isEditing = !!questionId;
        const question = isEditing ? allQuestionsForSubject.find(q => q.id === questionId) : {};
        document.getElementById('add-edit-header').textContent = isEditing ? 'ë¬¸ì œ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
        document.getElementById('editing-question-id').value = questionId || '';

        // ëª©ì°¨ ì •ë³´ í•„ë“œ ì±„ìš°ê¸°
        document.getElementById('q-part').value = question.part || '';
        document.getElementById('q-chapter').value = question.chapter || '';
        document.getElementById('q-section').value = question.section || '';

        document.getElementById('q-text-full').value = question.text || '';
        document.getElementById('q-answer-full').value = question.answer || '';
        document.getElementById('q-explanation-full').value = question.explanation || '';
        
        ['keyword', 'tag', 'metatag', 'option'].forEach(type => {
            const container = document.getElementById(`q-${type}s-container`);
            container.innerHTML = '';
            const items = question[type + 's'] || [];
            if (items.length === 0) { addDynamicField(type, ''); } 
            else { items.forEach(val => addDynamicField(type, val)); }
        });
        document.getElementById('save-full-btn').onclick = () => saveFullUpdate(questionId);
    }

    function addDynamicField(type, value = '') {
        const container = document.getElementById(`q-${type}s-container`);
        if (!container) return;
        const newField = document.createElement('div'); newField.className = 'dynamic-field-group';
        const count = container.children.length + 1;
        const placeholderText = type.charAt(0).toUpperCase() + type.slice(1);
        newField.innerHTML = `<span class="field-label">${count}.</span><input type="text" class="q-${type}" value="${value}" placeholder="${placeholderText}"><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`;
        container.appendChild(newField);
    }

    async function saveFullUpdate(questionId) {
        const data = {
            // âœ¨ ì¶”ê°€: ëª©ì°¨ ì •ë³´ ì €ì¥
            part: document.getElementById('q-part').value.trim(),
            chapter: document.getElementById('q-chapter').value.trim(),
            section: document.getElementById('q-section').value.trim(),

            text: document.getElementById('q-text-full').value.trim(),
            answer: document.getElementById('q-answer-full').value.trim(),
            explanation: document.getElementById('q-explanation-full').value.trim(),
            keywords: Array.from(document.querySelectorAll('.q-keyword')).map(i => i.value.trim()).filter(Boolean),
            tags: Array.from(document.querySelectorAll('.q-tag')).map(i => i.value.trim()).filter(Boolean),
            metatags: Array.from(document.querySelectorAll('.q-metatag')).map(i => i.value.trim()).filter(Boolean),
            options: Array.from(document.querySelectorAll('.q-option')).map(i => i.value.trim()).filter(Boolean)
        };
        if (!data.text || !data.answer) { showFeedback("ë¬¸ì œ ë‚´ìš©ê³¼ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            if (questionId) { await subjectRef.collection('questions').doc(questionId).update(data); showFeedback("ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); } 
            else { await subjectRef.collection('questions').add(data); await db.runTransaction(async t => { const doc = await t.get(subjectRef); t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + 1 }); }); showFeedback("ìƒˆ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success"); }
            currentManagementViewMode = 'list';
            await showManagementView(true);
        } catch (error) { console.error(error); showFeedback("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
    
    async function deleteProblem(questionId) {
        if (!confirm("ì •ë§ë¡œ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            await subjectRef.collection('questions').doc(questionId).delete();
            await db.runTransaction(async t => { const doc = await t.get(subjectRef); t.update(subjectRef, { questionCount: Math.max(0, (doc.data().questionCount || 1) - 1) }); });
            showFeedback("ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            await showManagementView(true);
        } catch(error) { console.error(error); showFeedback("ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }

    // (í€´ì¦ˆ ì‹¤í–‰ í•¨ìˆ˜ë“¤ì€ ë³€ê²½ ì—†ìŒ)
    async function startQuiz(id) { const doc = await db.collection('subjects').doc(id).get(); if (!doc.exists) return; currentSubjectId = id; currentSubjectData = doc.data(); const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get(); if (snapshot.empty) { showFeedback('í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¬¸ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; } quizQuestions = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort(() => 0.5 - Math.random()); currentQuizIndex = 0; quizScore = 0; quizProblemsAttempted = 0; showView('quiz-view'); displayCurrentQuiz(); }
    async function exitQuiz() { if (quizProblemsAttempted > 0) { updateDailyProgress(quizProblemsAttempted); } await loadSubjects(); showView('subject-view'); }
    function displayCurrentQuiz() { const quizView = document.getElementById('quiz-view'); if (!quizView) return; if (currentQuizIndex >= quizQuestions.length) { quizView.innerHTML = `<div class="final-result"><h2>ğŸ‰ í€´ì¦ˆê°€ ëë‚¬ìŠµë‹ˆë‹¤!</h2><p>ì´ ${quizQuestions.length}ë¬¸ì œ ì¤‘ <strong>${quizScore}ê°œ</strong>ë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤.</p></div><button class="button primary-button" onclick="exitQuiz()">ê³¼ëª© ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>`; if (quizProblemsAttempted > 0) { updateDailyProgress(quizProblemsAttempted); } return; } const data = quizQuestions[currentQuizIndex]; let optionsHTML = (data.options || []).map(opt => `<div class="option">${opt}</div>`).join(''); quizView.innerHTML = `<div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;">${currentQuizIndex + 1} / ${quizQuestions.length}</div><div id="quiz-body"><h4>${data.text}</h4><div>${optionsHTML}</div></div><div id="immediate-feedback" style="margin-top: 15px;"><button id="submit-btn" class="button primary-button">ì •ë‹µ í™•ì¸</button></div><hr style="margin:20px 0;"><button class="button light-button" onclick="exitQuiz()">â†©ï¸ í€´ì¦ˆ ì¤‘ë‹¨</button>`; quizView.querySelectorAll('.option').forEach(li => { li.onclick = (e) => { const selected = quizView.querySelector('.option.selected'); if (selected) selected.classList.remove('selected'); e.currentTarget.classList.add('selected'); selectedOption = e.currentTarget.textContent; } }); quizView.querySelector('#submit-btn').onclick = submitAnswer; }
    function submitAnswer() { const selectedOptElem = document.querySelector('.option.selected'); if (!selectedOptElem) { showFeedback("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; } quizProblemsAttempted++; const data = quizQuestions[currentQuizIndex]; const isCorrect = selectedOption === data.answer; const feedbackDiv = document.getElementById('immediate-feedback'); let feedbackHTML = ''; if (isCorrect) { quizScore++; feedbackHTML = `<div class="feedback correct"><p><strong>ì •ë‹µì…ë‹ˆë‹¤!</strong></p></div>`; } else { feedbackHTML = `<div class="feedback incorrect"><p><strong>ì˜¤ë‹µì…ë‹ˆë‹¤.</strong> ì •ë‹µ: ${data.answer}</p></div>`; } if (data.explanation) { feedbackHTML += `<p style="margin-top:10px;"><strong>í•´ì„¤:</strong> ${data.explanation}</p>`; } feedbackHTML += `<button id="next-btn" class="button primary-button" style="margin-top: 10px;">ë‹¤ìŒ ë¬¸ì œ â†’</button>`; feedbackDiv.innerHTML = feedbackHTML; feedbackDiv.querySelector('#next-btn').onclick = () => { currentQuizIndex++; displayCurrentQuiz(); }; }
</script>
</body>
</html>
