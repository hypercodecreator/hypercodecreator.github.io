<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #212529; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .button { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 5px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: bold; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        #auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        #auth-container button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }
        #auth-container span { font-size: 0.9em; margin-right: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em;}
        .dynamic-field-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee;}
        .dynamic-field-group .inputs { flex-grow: 1; }
        .dynamic-field-group .field-label { font-size: 0.9em; color: #6c757d; min-width: 25px; }
        .remove-btn { padding: 8px 12px; font-size: 0.9em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
        .subject-item-name { font-weight: bold; }
        .subject-item-buttons { display: flex; gap: 10px; }
        .subject-item-buttons .button { width: auto; margin: 0; padding: 8px 12px; font-size: 0.9em; }
        .question-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .question-item-text { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .question-item-button { flex-shrink: 0; width: auto; margin: 0; padding: 6px 10px; font-size: 0.9em; }
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .final-result { text-align: center; padding: 20px; }
        .final-result h2 { font-size: 2em; margin-bottom: 10px; }
        .final-result p { font-size: 1.2em; }
        
        #tree-container { padding: 10px; }
        #tree-container ul { padding-left: 1em; list-style: none; position: relative; }
        #tree-container ul ul { margin-left: .5em; }
        #tree-container li { position: relative; padding: 4px 0 4px 1.2em; line-height: 1.5; }
        #tree-container li::before { content: ""; position: absolute; top: 0; left: 0; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; width: 1em; height: 1em; }
        #tree-container li::after { content: ""; position: absolute; top: 1em; left: 0; bottom: 0; border-left: 1px solid #ccc; }
        #tree-container li:last-child::after { display: none; }
        #tree-container li.expandable { cursor: pointer; }
        #tree-container li.expandable > .node-text { font-weight: bold; }
        #tree-container li.expandable > .node-text:hover { color: #0d6efd; }
        #tree-container li.expandable::before { content: "[+] "; font-family: monospace; border: none; width: auto; height: auto; top: 2px; }
        #tree-container li.expandable.expanded::before { content: "[-] "; }
        #tree-container li.expandable.expanded > ul { display: block; }
        #tree-container li > ul { display: none; }
        
        /* âœ¨ tags-keywords -> concept-badges-containerë¡œ ì´ë¦„ ë³€ê²½ ë° ìŠ¤íƒ€ì¼ ì¶”ê°€ âœ¨ */
        #tree-container .concept-badges-container { display: block; padding-left: 1.2em; margin-top: 4px; }
        .concept-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.75em;
            border-radius: 10px;
            margin-right: 5px;
            margin-bottom: 4px;
        }
        .badge-keyword { background-color: #e0eaff; color: #4361ee; }
        .badge-tag { background-color: #dcfce7; color: #16a34a; }
        .badge-metatag { background-color: #fefce8; color: #b45309; }

        /* âœ¨ ì ì§„ì  í•™ìŠµ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ ì¶”ê°€ âœ¨ */
        #goal-view {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #goal-view h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .goal-setup {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .goal-setup input {
            width: 80px;
            text-align: center;
        }
        .goal-setup .button {
            width: auto;
            margin-top: 0;
            padding: 10px 15px;
        }
        #goal-status {
            font-weight: bold;
            font-size: 1.1em;
        }
        #goal-status .progress {
            color: #0d6efd;
        }
        #goal-status .goal {
            color: #6c757d;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            </div>
        <div id="subject-view">
            <h2>ê³¼ëª© ì„ íƒ</h2>
            <div id="goal-view">
                <h4>ğŸ¯ ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œ</h4>
                <div id="goal-setup-view" class="goal-setup">
                    <input type="number" id="goal-input" min="1" value="10">
                    <button class="button primary-button" onclick="setDailyGoal()">ëª©í‘œ ì„¤ì •</button>
                </div>
                <div id="goal-status-view" class="hidden">
                    <span id="goal-status"></span>
                </div>
            </div>
            <div id="subject-list"></div>
    <div class="container">
        <div id="auth-container">
            <div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">ë¡œê·¸ì¸</button><button class="button primary-button" onclick="showView('signup-view')">íšŒì›ê°€ì…</button></div>
            <div id="logged-in-view" class="hidden"><span id="user-email"></span><button class="button secondary-button" onclick="logOut()">ë¡œê·¸ì•„ì›ƒ</button></div>
        </div>
        <div id="subject-view">
            <h2>ê³¼ëª© ì„ íƒ</h2>
            <div id="subject-list"></div>
        </div>
        <div id="quiz-view" class="hidden">
             <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;"></div>
            <div id="quiz-body"></div>
            <div id="immediate-feedback"></div>
            <hr style="margin:20px 0;">
            <button class="button secondary-button" onclick="showManagementView({ refetch: true })">ğŸ“‹ ë¬¸ì œ ê´€ë¦¬</button>
            <button class="button primary-button" onclick="startWeaknessQuiz()">ğŸ¯ ì·¨ì•½ì  ê³µëµ í€´ì¦ˆ</button>
            <button class="button light-button" onclick="showView('subject-view')">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button>
        </div>
        <div id="management-view" class="hidden">
            <h2 id="management-header"></h2>
            <button class="button primary-button" onclick="showAddForm()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
            <button class="button primary-button" onclick="showBulkAddView()">+ ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</button>
            <button class="button light-button" onclick="showTreeView()">ğŸŒ³ ì§€ì‹ íŠ¸ë¦¬ ë³´ê¸°</button> 
            <hr>
            <div id="question-list-container"></div>
            <button class="button light-button" onclick="showView('subject-view')">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button>
        </div>
        <div id="tree-view" class="hidden">
            <h2>ğŸŒ³ ì§€ì‹ íŠ¸ë¦¬</h2>
            <div id="tree-container">ì§€ì‹ íŠ¸ë¦¬ ë¡œë”© ì¤‘...</div>
            <hr>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">â†©ï¸ ë¬¸ì œ ê´€ë¦¬ë¡œ</button>
        </div>
        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            <h4>1. ë¬¸ì œ ì •ë³´</h4>
            <div class="form-group"><label for="q-text">ë¬¸ì œ ë‚´ìš©</label><textarea id="q-text" rows="3"></textarea></div>
            <div class="form-group"><label for="q-answer">ì •ë‹µ</label><input type="text" id="q-answer"></div>
            <div class="form-group"><label for="q-explanation">í•´ì„¤</label><textarea id="q-explanation" rows="3"></textarea></div>
            <div class="form-group"><label for="q-part">ì†Œì† íŒŒíŠ¸</label><select id="q-part"></select></div>
            <hr>
            <h4>2. ê°œë… ë¶„ì„ (ì„ íƒ)</h4>
            <div class="form-group"><label>êµ¬ì¡°í™”ëœ í‚¤ì›Œë“œ</label><div id="q-keywords-container"></div><button class="button light-button" onclick="addKeywordField()">+ í‚¤ì›Œë“œ ì¶”ê°€</button></div>
            <div class="form-group"><label>êµ¬ì¡°í™”ëœ íƒœê·¸</label><div id="q-tags-container"></div><button class="button light-button" onclick="addTagField()">+ íƒœê·¸ ì¶”ê°€</button></div>
            <div class="form-group"><label>êµ¬ì¡°í™”ëœ ë©”íƒ€íƒœê·¸</label><div id="q-metatags-container"></div><button class="button light-button" onclick="addMetatagField()">+ ë©”íƒ€íƒœê·¸ ì¶”ê°€</button></div>
            <hr>
            <h4>3. ê°ê´€ì‹ ë³´ê¸° (ì„ íƒ)</h4>
            <div id="q-options-container"></div>
            <button class="button light-button" onclick="addOptionField()">+ ë³´ê¸° ì¶”ê°€</button>
            <hr>
            <button id="save-btn" class="button primary-button">ì €ì¥</button>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
        </div>
        <div id="bulk-add-view" class="hidden">
             <h2>ğŸ“š ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</h2>
            <div class="form-group"><textarea id="bulk-text" rows="10" placeholder="ë¬¸ì œ: ..."></textarea></div>
            <button class="button primary-button" onclick="addBulkQuestions()">DBì— ì €ì¥</button>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
        </div>
        <div id="signup-view" class="hidden">
            <h2>íšŒì›ê°€ì…</h2>
            <div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email"></div>
            <div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signup-password"></div>
            <button class="button primary-button" onclick="signUp()">íšŒì›ê°€ì…</button>
            <button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button>
        </div>
        <div id="login-view" class="hidden">
            <h2>ë¡œê·¸ì¸</h2>
            <div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email"></div>
            <div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password"></div>
            <button class="button primary-button" onclick="logIn()">ë¡œê·¸ì¸</button>
            <button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
    
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentSubjectId, currentSubjectData, allQuestionsForSubject = []; 
        let currentQuizIndex = 0, quizQuestions = [], selectedOption = null, quizScore = 0;
        
        // âœ¨ ì ì§„ì  í•™ìŠµ ê¸°ëŠ¥ ë³€ìˆ˜ ì¶”ê°€ âœ¨
        let dailyGoal = 0;
        let dailyProgress = 0;
        
        const views = ['subject-view', 'quiz-view', 'management-view', 'add-edit-view', 'signup-view', 'login-view', 'bulk-add-view', 'tree-view'];

        function showView(viewId) { views.forEach(id => document.getElementById(id)?.classList.toggle('hidden', id !== viewId)); }
        
        auth.onAuthStateChanged(user => {
            const loggedInView = document.getElementById('logged-in-view');
            const loggedOutView = document.getElementById('logged-out-view');
            if (loggedInView) loggedInView.classList.toggle('hidden', !user);
            if (loggedOutView) loggedOutView.classList.toggle('hidden', !!user);
            if (user) {
                document.getElementById('user-email').textContent = `${user.email}ë‹˜`;
                loadSubjects();
            } else {
                showView('subject-view');
                document.getElementById('subject-list').innerHTML = '<p>ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>';
            }
        });
        
        async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); showView('subject-view'); } catch (e) { alert(e.message); } }
        function logOut() { auth.signOut(); }

        async function loadSubjects() {
            const listDiv = document.getElementById('subject-list');
            listDiv.innerHTML = 'ê³¼ëª© ë¡œë”© ì¤‘...';
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const subject = doc.data();
                const item = document.createElement('div');
                item.className = 'subject-item';
                item.innerHTML = `<span class="subject-item-name">${subject.name} (${subject.questionCount || 0}ë¬¸ì œ)</span><div class="subject-item-buttons"><button class="button primary-button" onclick="startQuiz('${doc.id}')">í€´ì¦ˆ ì‹œì‘</button><button class="button secondary-button" onclick="manageSubject('${doc.id}')">ë¬¸ì œ ê´€ë¦¬</button></div>`;
                listDiv.appendChild(item);
            });
        }
        
        async function manageSubject(id) {
            const doc = await db.collection('subjects').doc(id).get();
            if (!doc.exists) return;
            currentSubjectId = id;
            currentSubjectData = doc.data();
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('fixedId').get();
            allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            await showManagementView({ refetch: false });
        }
        
       // ê³¼ëª© ì„ íƒ ë° ë¬¸ì œ ë¡œë“œ
        async function selectSubject(id, data) {
            currentSubjectId = id;
            currentSubjectData = data;
            await showManagementView({ refetch: true });
        }
        
        async function startQuiz(id, questions = null) {
            if (id) {
                await manageSubject(id);
                quizQuestions = [...allQuestionsForSubject].sort(() => 0.5 - Math.random());
            } else {
                quizQuestions = questions.sort(() => 0.5 - Math.random());
            }
            currentQuizIndex = 0;
            quizScore = 0;
            showView('quiz-view');
            displayCurrentQuiz();
        }

        async function showManagementView(options = { refetch: true }) {
            showView('management-view');
            document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
            const container = document.getElementById('question-list-container');
            if (options.refetch) {
                container.innerHTML = 'ë¬¸ì œ ëª©ë¡ ë¡œë”© ì¤‘...';
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('fixedId').get();
                allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            container.innerHTML = '';
            if (allQuestionsForSubject.length === 0) {
                container.innerHTML = '<p>ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                allQuestionsForSubject.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    item.innerHTML = `<span class="question-item-text">${q.fixedId || ''}. ${q.text}</span><button class="button light-button question-item-button" onclick="showEditForm('${q.id}')">ìˆ˜ì •</button>`;
                    container.appendChild(item);
                });
            }
        }
        
        function updateBreadcrumb() {
            const currentQ = questions[currentQuiz];
            const navDiv = document.getElementById('breadcrumb-nav');
            if (!currentQ) { navDiv.innerHTML = ''; return; }
            navDiv.innerHTML = `<strong>ê³¼ëª©:</strong> ${currentSubjectData.name} &nbsp;&nbsp; > &nbsp;&nbsp; <strong>íŒŒíŠ¸:</strong> ${currentQ.partName || 'ë¯¸ì§€ì •'}`;
        }

        function displayCurrentQuiz() {
            const quizBody = document.getElementById('quiz-body');
            const feedbackDiv = document.getElementById('immediate-feedback');
            selectedOption = null;
            feedbackDiv.innerHTML = '';
            feedbackDiv.className = '';

            if (currentQuizIndex >= quizQuestions.length) {
                quizBody.innerHTML = `
                    <div class="final-result">
                        <h2>ğŸ‰ í€´ì¦ˆê°€ ëë‚¬ìŠµë‹ˆë‹¤!</h2>
                        <p>ì´ ${quizQuestions.length}ë¬¸ì œ ì¤‘ <strong>${quizScore}ê°œ</strong>ë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤.</p>
                        <p>ì •ë‹µë¥ : <strong>${((quizScore / quizQuestions.length) * 100).toFixed(1)}%</strong></p>
                    </div>
                `;
                updateDailyProgress(quizScore);
                return;
            }

            const data = quizQuestions[currentQuizIndex];
            let optionsHTML = '';
            (data.options || []).forEach(opt => { optionsHTML += `<div class="option">${opt}</div>`; });
            
            quizBody.innerHTML = `<h4>${data.fixedId || (currentQuizIndex + 1)}. ${data.text}</h4><div>${optionsHTML}</div>`;
            feedbackDiv.innerHTML = `<button id="submit-btn" class="button primary-button">ì •ë‹µ í™•ì¸</button>`;
            
            document.querySelectorAll('.option').forEach(li => { 
                li.onclick = (e) => {  
                    document.querySelector('.option.selected')?.classList.remove('selected');
                    e.currentTarget.classList.add('selected');
                    selectedOption = e.currentTarget.textContent;
                }
            });
            document.getElementById('submit-btn').onclick = submitAnswer;
        }

        // âœ¨ ì ì§„ì  í•™ìŠµ ê¸°ëŠ¥ í•¨ìˆ˜ ì¶”ê°€ âœ¨
        function setDailyGoal() {
            const goalInput = document.getElementById('goal-input');
            const goalValue = parseInt(goalInput.value, 10);

            if (isNaN(goalValue) || goalValue <= 0) {
                alert('1 ì´ìƒì˜ ìˆ«ìë¥¼ ëª©í‘œë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            dailyGoal = goalValue;
            dailyProgress = 0; // ëª©í‘œë¥¼ ìƒˆë¡œ ì„¤ì •í•˜ë©´ ì§„í–‰ë„ëŠ” ì´ˆê¸°í™”

            document.getElementById('goal-setup-view').classList.add('hidden');
            document.getElementById('goal-status-view').classList.remove('hidden');
            
            updateGoalStatusDisplay();
        }

        function updateDailyProgress(correctAnswers) {
            if (dailyGoal <= 0) return; // ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨

            dailyProgress += correctAnswers;
            updateGoalStatusDisplay();

            if (dailyProgress >= dailyGoal) {
                alert('ğŸ‰ ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ëŒ€ë‹¨í•´ìš”!');
            }
        }

        function updateGoalStatusDisplay() {
            const statusSpan = document.getElementById('goal-status');
            statusSpan.innerHTML = `ì˜¤ëŠ˜ì˜ ëª©í‘œ: <span class="progress">${dailyProgress}</span> / <span class="goal">${dailyGoal}</span> ë¬¸ì œ`;
        }
        
        function submitAnswer() {
            if (!selectedOption) { alert("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const data = quizQuestions[currentQuizIndex];
            const isCorrect = selectedOption === data.answer;
            const feedbackDiv = document.getElementById('immediate-feedback');
            
            if (isCorrect) {
                quizScore++;
                feedbackDiv.className = 'feedback correct';
                feedbackDiv.innerHTML = `<p><strong>ì •ë‹µì…ë‹ˆë‹¤!</strong></p>`;
            } else {
                feedbackDiv.className = 'feedback incorrect';
                feedbackDiv.innerHTML = `<p><strong>ì˜¤ë‹µì…ë‹ˆë‹¤.</strong> ì •ë‹µ: ${data.answer}</p>`;
            }
            if (data.explanation) feedbackDiv.innerHTML += `<p>í•´ì„¤: ${data.explanation}</p>`;
            
            document.querySelectorAll('.option').forEach(opt => { 
                opt.style.cursor = 'default';
                opt.onclick = null;  
                if (opt.textContent === data.answer) opt.style.cssText += 'background-color: #d1e7dd; border-color: #198754;';
                else if (opt.textContent === selectedOption) opt.style.cssText += 'background-color: #f8d7da; border-color: #dc3545;';
            });

            const nextButton = document.createElement('button');
            nextButton.className = 'button primary-button';
            nextButton.textContent = 'ë‹¤ìŒ ë¬¸ì œ â†’';
            nextButton.onclick = () => { currentQuizIndex++; displayCurrentQuiz(); };
            feedbackDiv.appendChild(nextButton);
        }

        async function showTreeView() {
            showView('tree-view');
            const container = document.getElementById('tree-container');
            
            container.innerHTML = ''; // í•­ìƒ ìƒˆë¡œ ê·¸ë¦¼

            const parts = {};
            allQuestionsForSubject.forEach(q => {
                const partName = q.partName || 'ë¯¸ì§€ì • íŒŒíŠ¸';
                if (!parts[partName]) parts[partName] = [];
                parts[partName].push(q);
            });

            let treeHTML = '<ul>';
            treeHTML += `<li class="expandable"><span class="node-text">${currentSubjectData.name}</span><ul>`;
            
            const sortedPartNames = currentSubjectData.partOrder || Object.keys(parts).sort();
            sortedPartNames.forEach(partName => {
                if (!parts[partName]) return;
                treeHTML += `<li class="expandable"><span class="node-text">${partName}</span><ul>`;
                parts[partName].forEach(q => {
                    let conceptsHTML = '';
                    (q.keywords || []).forEach(kw => { conceptsHTML += `<span class="concept-badge badge-keyword">${kw}</span>`; });
                    (q.tags || []).forEach(tag => { conceptsHTML += `<span class="concept-badge badge-tag">${tag}</span>`; });
                    (q.metatags || []).forEach(mt => { conceptsHTML += `<span class="concept-badge badge-metatag">${mt}</span>`; });
                    
                    const conceptsContainer = conceptsHTML ? `<div class="concept-badges-container">${conceptsHTML}</div>` : '';

                    treeHTML += `<li>
                                    <span class="node-text">${q.fixedId}. ${q.text}</span>
                                    ${conceptsContainer}
                                 </li>`;
                });
                treeHTML += '</ul></li>';
            });
            treeHTML += '</ul></li></ul>';

            container.innerHTML = treeHTML;
            
            if (container.querySelector('li.expandable')) {
                container.querySelector('li.expandable').classList.add('expanded');
            }

        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const treeContainer = document.getElementById('tree-container');
            if (treeContainer) {
                treeContainer.addEventListener('click', function(e) {
                    const targetLi = e.target.closest('.expandable');
                    if (targetLi) {
                        targetLi.classList.toggle('expanded');
                    }
                });
            }
        });
        
        function displayConceptMap() {
            const mapContainer = document.getElementById('concept-map');
            const mapContent = document.getElementById('map-content');
            const currentQ = questions[currentQuiz];
            if (!currentQ) return;
            let contentHTML = '';
            contentHTML += `<div class="feature"><p class="feature-title">ğŸ”¼ ìƒìœ„ ê°œë… (ìˆ˜ì§)</p><p><strong>ê±°ë¦¬ 1:</strong> ${currentQ.partName || 'ë¯¸ì§€ì • íŒŒíŠ¸'}</p><p><strong>ê±°ë¦¬ 2:</strong> ${currentSubjectData.name}</p></div>`;
            const siblingQuestions = allQuestionsForSubject.filter(q => q.partName === currentQ.partName && q.id !== currentQ.id);
            if (siblingQuestions.length > 0) {
                contentHTML += `<div class="feature"><p class="feature-title">â†”ï¸ ì—°ê´€ ê°œë… (ìˆ˜í‰ ê±°ë¦¬ 2)</p><ul>`;
                siblingQuestions.slice(0, 5).forEach(q => { contentHTML += `<li>${q.fixedId}. ${q.keyword || q.text}</li>`; });
                if (siblingQuestions.length > 5) contentHTML += `<li>...ì™¸ ${siblingQuestions.length - 5}ê°œ</li>`;
                contentHTML += '</ul></div>';
            }
            mapContent.innerHTML = contentHTML;
            mapContainer.classList.remove('hidden');
        }

        async function startHorizontalQuiz() {
            const currentQ = questions[currentQuiz];
            if (!currentQ || !currentQ.partName) { alert('í˜„ì¬ ë¬¸ì œì˜ íŒŒíŠ¸ ì •ë³´ê°€ ì—†ì–´ ì—°ê´€ ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const relatedQuestions = allQuestionsForSubject.filter(q => q.partName === currentQ.partName && q.id !== currentQ.id);
            if (relatedQuestions.length === 0) { alert('ì´ íŒŒíŠ¸ì—ëŠ” ë‹¤ë¥¸ ì—°ê´€ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            questions = relatedQuestions;
            currentQuiz = 0; score = 0;
            document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] ì—°ê´€ ë¬¸ì œ`;
            displayCurrentQuiz();
        }

        

        async function toggleSubjectNode(event, subjectId) {
            event.stopPropagation();
            const node = event.currentTarget;
            const childUl = node.querySelector('ul');
            if (childUl) { childUl.remove(); node.classList.remove('expanded'); return; }
            node.classList.add('expanded');
            const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').orderBy('fixedId').get();
            const parts = {};
            questionsSnapshot.forEach(doc => {
                const q = doc.data();
                const part = q.partName || 'ë¯¸ì§€ì • íŒŒíŠ¸';
                if (!parts[part]) parts[part] = [];
                parts[part].push(q);
            });
            let subTreeHTML = '<ul>';
            for (const partName in parts) {
                subTreeHTML += `<li class="tree-node part-node">${partName}`;
                subTreeHTML += '<ul>';
                parts[partName].forEach(q => { subTreeHTML += `<li class="tree-node question-node">${q.fixedId}. ${q.text}</li>`; });
                subTreeHTML += '</ul></li>';
            }
            subTreeHTML += '</ul>';
            node.insertAdjacentHTML('beforeend', subTreeHTML);
        }
        
        function toggleFeedbackMode(isEnabled) { immediateFeedbackMode = isEnabled; }

        async function recordConfidence(questionId, level) {
            const user = auth.currentUser; if (!user) return;
            const confidenceRef = db.collection('users').doc(user.uid).collection('confidenceRatings').doc(questionId);
            try {
                await confidenceRef.set({
                    level: level,
                    subjectId: currentSubjectId,
                    partName: questions[currentQuiz].partName,
                    ratedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.querySelector('.confidence-buttons').innerHTML = `<p><em>ìì‹ ê°ë„ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.</em></p>`;
            } catch(e) { console.error("ìì‹ ê°ë„ ê¸°ë¡ ì˜¤ë¥˜:", e); alert('ìì‹ ê°ë„ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        }

        async function checkBookmarkStatus(questionId) {
            const user = auth.currentUser; if (!user || !questionId) return false;
            const doc = await db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId).get();
            return doc.exists;
        }

        async function toggleBookmark(questionId) {
            const user = auth.currentUser; if (!user || !questionId) return;
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const bookmarkRef = db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId);
            const isBookmarked = await checkBookmarkStatus(questionId);
            if (isBookmarked) { await bookmarkRef.delete(); bookmarkToggle.textContent = 'â˜†'; } 
            else { await bookmarkRef.set({ subjectId: currentSubjectId, subjectName: currentSubjectData.name, addedAt: firebase.firestore.FieldValue.serverTimestamp() }); bookmarkToggle.textContent = 'â˜…'; }
        }

        async function showBookmarkView() {
            showView('bookmark-view');
            const container = document.getElementById('bookmark-list-container');
            container.innerHTML = 'ë¶ë§ˆí¬ ë¡œë”© ì¤‘...';
            const user = auth.currentUser; if (!user) return;
            const snapshot = await db.collection('users').doc(user.uid).collection('bookmarks').orderBy('addedAt', 'desc').get();
            if (snapshot.empty) { container.innerHTML = '<p>ë¶ë§ˆí¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            container.innerHTML = '';
            for (const doc of snapshot.docs) {
                const bookmark = doc.data();
                if (!bookmark.subjectId) continue;
                try {
                    const questionDoc = await db.collection('subjects').doc(bookmark.subjectId).collection('questions').doc(doc.id).get();
                    if (questionDoc.exists) {
                        const question = questionDoc.data();
                        const item = document.createElement('div');
                        item.className = 'question-item'; item.style.cursor = 'pointer';
                        item.onclick = () => {
                             selectSubject(bookmark.subjectId, { name: bookmark.subjectName, partOrder: currentSubjectData.partOrder });
                             loadQuestionsForSubject(doc.id);
                        };
                        item.innerHTML = `<span class="question-item-text">${question.fixedId || ''} ${question.text}</span><span class="question-item-part">(${bookmark.subjectName})</span>`;
                        container.appendChild(item);
                    }
                } catch (e) { console.error(`ë¶ë§ˆí¬ëœ ë¬¸ì œ(${doc.id}) ë¡œë”© ì‹¤íŒ¨:`, e); }
            }
        }
        
        

        function updateSelectionActions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const actionsDiv = document.getElementById('management-actions');
            const countSpan = document.getElementById('selection-count');
            actionsDiv.classList.toggle('hidden', selected.length === 0);
            if (selected.length > 0) {
                countSpan.textContent = `${selected.length}ê°œ ì„ íƒë¨`;
            }
            if (selected.length === 0) {
                document.getElementById('select-all-checkbox').checked = false;
            }
        }

        function toggleSelectAll(checked) { document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = checked); updateSelectionActions(); }

        async function deleteSelectedQuestions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            if (selected.length === 0 || !confirm(`${selected.length}ê°œì˜ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const batch = db.batch();
            selected.forEach(cb => batch.delete(subjectRef.collection('questions').doc(cb.value)));
            batch.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(-selected.length) });
            await batch.commit();
            currentSubjectData.questionCount -= selected.length;
            showManagementView();
        }

        function showMoveDialog() {
            if (document.querySelectorAll('.question-checkbox:checked').length === 0) { alert('ì´ë™í•  ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const select = document.getElementById('target-part'); select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => { const opt = document.createElement('option'); opt.value = part; opt.textContent = part; select.appendChild(opt); });
            showView('move-question-view');
        }

        async function executeMove() {
            const newPartName = document.getElementById('target-part').value;
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const batch = db.batch();
            selected.forEach(cb => { batch.update(db.collection('subjects').doc(currentSubjectId).collection('questions').doc(cb.value), { partName: newPartName }); });
            await batch.commit();
            alert(`${selected.length}ê°œì˜ ë¬¸ì œë¥¼ '${newPartName}' íŒŒíŠ¸ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
            showManagementView();
        }

        async function startWeaknessQuiz() {
            const user = auth.currentUser;
            if (!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            showView('quiz-view');
            document.getElementById('quiz-header').textContent = 'ì·¨ì•½ì  ë¶„ì„ ì¤‘...';
            document.getElementById('quiz-body').innerHTML = '';

            try {
                const ratingsSnapshot = await db.collection('users').doc(user.uid).collection('confidenceRatings').where('subjectId', '==', currentSubjectId).where('level', 'in', ['unsure', 'guess']).get();
                if (ratingsSnapshot.empty) {
                    document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] ì·¨ì•½ì  ê³µëµ`;
                    document.getElementById('quiz-body').innerHTML = '<h2>ğŸ‰ ì´ ê³¼ëª©ì—ëŠ” ë“±ë¡ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤!</h2>';
                    return;
                }
                const weakQuestionIds = ratingsSnapshot.docs.map(doc => doc.id);
                const weakQuestions = allQuestionsForSubject.filter(q => weakQuestionIds.includes(q.id));
                if (weakQuestions.length === 0) {
                    document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] ì·¨ì•½ì  ê³µëµ`;
                    document.getElementById('quiz-body').innerHTML = '<h2>ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h2><p>ì‚­ì œë˜ì—ˆê±°ë‚˜ IDê°€ ë³€ê²½ëœ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                startQuiz(null, weakQuestions);
                document.getElementById('quiz-header').textContent = `[${currentSubjectData.name}] ì·¨ì•½ì  ê³µëµ`;
            } catch (error) {
                console.error("ì·¨ì•½ì  í€´ì¦ˆ ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
                document.getElementById('quiz-body').innerHTML = '<p>ì·¨ì•½ì  ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function showAddForm() { showEditForm(null); }
        function showBulkAddView() { showView('bulk-add-view'); }
        
        function showEditForm(id) {
            const isEditing = !!id;
            const q = isEditing ? allQuestionsForSubject.find(q => q.id === id) : {};
            showView('add-edit-view');
            document.getElementById('add-edit-header').textContent = isEditing ? 'ë¬¸ì œ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
            document.getElementById('editing-question-id').value = id || '';
            document.getElementById('q-text').value = q.text || '';
            document.getElementById('q-answer').value = q.answer || '';
            document.getElementById('q-explanation').value = q.explanation || '';
            populatePartSelect(q.partName);
            ['q-keywords-container', 'q-tags-container', 'q-metatags-container', 'q-options-container'].forEach(id => document.getElementById(id).innerHTML = '');
            (q.keywords || ['']).forEach(kw => addKeywordField(kw));
            (q.tags || ['']).forEach(t => addTagField(t));
            (q.metatags || ['']).forEach(mt => addMetatagField(mt));
            (q.options || ['']).forEach(opt => addOptionField(opt));
            document.getElementById('save-btn').onclick = saveQuestion;
        }

        function createDynamicField(container, placeholder, value) {
            const group = document.createElement('div');
            group.className = 'dynamic-field-group';
            const count = container.querySelectorAll('.dynamic-field-group').length + 1;
            const label = document.createElement('span');
            label.className = 'field-label';
            label.textContent = `${count}.`;
            const inputsDiv = document.createElement('div');
            inputsDiv.className = 'inputs';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = placeholder;
            input.value = value;
            inputsDiv.appendChild(input);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'X';
            removeBtn.onclick = () => { group.remove(); updateFieldLabels(container); };
            group.appendChild(label);
            group.appendChild(inputsDiv);
            group.appendChild(removeBtn);
            container.appendChild(group);
        }

        function updateFieldLabels(container) {
            container.querySelectorAll('.dynamic-field-group').forEach((group, index) => {
                group.querySelector('.field-label').textContent = `${index + 1}.`;
            });
        }
        
        function addKeywordField(value = '') { createDynamicField(document.getElementById('q-keywords-container'), 'í‚¤ì›Œë“œ (ì˜ˆ: ëª…ì¥ì´ˆë“±í•™êµ)', value); }
        function addTagField(value = '') { createDynamicField(document.getElementById('q-tags-container'), 'íƒœê·¸ê°’ (ì˜ˆ: ëª…ì¥ë™)', value); }
        function addMetatagField(value = '') { createDynamicField(document.getElementById('q-metatags-container'), 'ë©”íƒ€íƒœê·¸ (ì˜ˆ: ìœ„ì¹˜)', value); }
        function addOptionField(value = '') { createDynamicField(document.getElementById('q-options-container'), 'ë³´ê¸° ë‚´ìš©', value); }

        function populatePartSelect(selectedValue) {
            const select = document.getElementById('q-part');
            select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const opt = document.createElement('option');
                opt.value = part; opt.textContent = part;
                if (part === selectedValue) opt.selected = true;
                select.appendChild(opt);
            });
        }
        
        async function saveQuestion() {
            const id = document.getElementById('editing-question-id').value;
            const data = {
                text: document.getElementById('q-text').value.trim(),
                answer: document.getElementById('q-answer').value.trim(),
                explanation: document.getElementById('q-explanation').value.trim(),
                partName: document.getElementById('q-part').value,
                keywords: Array.from(document.querySelectorAll('#q-keywords-container input')).map(i => i.value.trim()).filter(Boolean),
                tags: Array.from(document.querySelectorAll('#q-tags-container input')).map(i => i.value.trim()).filter(Boolean),
                metatags: Array.from(document.querySelectorAll('#q-metatags-container input')).map(i => i.value.trim()).filter(Boolean),
                options: Array.from(document.querySelectorAll('#q-options-container input')).map(i => i.value.trim()).filter(Boolean)
            };
            if (!data.text || !data.answer || !data.partName) { alert("ë¬¸ì œ ë‚´ìš©, ì •ë‹µ, ì†Œì† íŒŒíŠ¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤."); return; }
            try {
                if (id) {
                    await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(data);
                } else {
                    const subjectRef = db.collection('subjects').doc(currentSubjectId);
                    const newDocRef = subjectRef.collection('questions').doc();
                    await db.runTransaction(async t => {
                        const doc = await t.get(subjectRef);
                        const subjectData = doc.data();
                        const partCode = subjectData.partCodes[data.partName];
                        if (!partCode) throw new Error("Invalid part name.");
                        const newCount = (subjectData.partCounters[partCode] || 0) + 1;
                        data.fixedId = `${subjectData.subjectCode}-${partCode}-${String(newCount).padStart(3, '0')}`;
                        t.set(newDocRef, data);
                        t.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(1), [`partCounters.${partCode}`]: newCount });
                    });
                    data.id = newDocRef.id;
                    allQuestionsForSubject.push(data);
                    allQuestionsForSubject.sort((a,b) => a.fixedId.localeCompare(b.fixedId));
                }
                await manageSubject(currentSubjectId); // ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ì´ë™
            } catch(e) { console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }
        
        function selectByRange() {
            const rangeStr = document.getElementById('range-select-input').value; if (!rangeStr.trim()) return;
            const allCheckboxes = Array.from(document.querySelectorAll('.question-checkbox')); const indicesToSelect = new Set();
            rangeStr.split(',').forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(num => parseInt(num.trim(), 10));
                    if (!isNaN(start) && !isNaN(end)) { for (let i = start; i <= end; i++) indicesToSelect.add(i); }
                } else { const num = parseInt(part, 10); if (!isNaN(num)) indicesToSelect.add(num); }
            });
            displayedQuestions.forEach(q => {
                if (!q.fixedId) return;
                const idNum = parseInt(q.fixedId.split('-')[2], 10);
                if (indicesToSelect.has(idNum)) {
                    const checkbox = allCheckboxes.find(cb => cb.value === q.id);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateSelectionActions();
        }

        async function addBulkQuestions() {
            const blocks = document.getElementById('bulk-text').value.trim().split('---');
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            let count = 0;
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef); const subjectData = doc.data();
                const defaultPart = (subjectData.partOrder || ['ì¼ë°˜'])[0];
                let currentCounters = { ...subjectData.partCounters };
                blocks.forEach(block => {
                    if (!block.trim()) return; const lines = block.trim().split('\n');
                    const data = { options: [], partName: defaultPart, text: '', answer: '' };
                    lines.forEach(line => {
                         if (line.toLowerCase().startsWith('ë¬¸ì œ:')) data.text = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('ë³´ê¸°:')) data.options = line.substring(3).trim().split(',').map(s => s.trim());
                         else if (line.toLowerCase().startsWith('ì •ë‹µ:')) data.answer = line.substring(3).trim();
                         else if (line.toLowerCase().startsWith('í•´ì„¤:')) data.explanation = line.substring(3).trim();
                    });
                    if (data.text && data.answer) {
                        const partCode = subjectData.partCodes[data.partName];
                        if(partCode) {
                            const newCount = (currentCounters[partCode] || 0) + 1;
                            data.fixedId = `${subjectData.subjectCode}-${partCode}-${String(newCount).padStart(3, '0')}`;
                            currentCounters[partCode] = newCount;
                        }
                        t.set(subjectRef.collection('questions').doc(), data); 
                        count++; 
                    }
                });
                t.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(count), partCounters: currentCounters });
            });
            if (count > 0) { currentSubjectData.questionCount += count; alert(`${count}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`); showManagementView(); }
             else { alert('ì¶”ê°€í•  ë¬¸ì œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì–‘ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
        }

        function populatePartSelect(selectedValue) {
            const select = document.getElementById('q-part');
            select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const opt = document.createElement('option');
                opt.value = part;
                opt.textContent = part;
                if (part === selectedValue) opt.selected = true;
                select.appendChild(opt);
            });
        }
        
    </script>
</body>
</html>
