<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 CBT</title>
    <style>
        /* 기본 & 레이아웃 */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* 버튼 */
        .button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: 600; transition: all 0.2s ease-in-out; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .primary-button:hover { background-color: #0b5ed7; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .light-button:hover { background-color: #e2e6ea; }
        .small-button { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; }

        /* 상단 인증 영역 */
        #auth-container { display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        #auth-container span { margin-right: auto; font-size: 0.9em; color: #555; }
        #auth-container .button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }

        /* 피드백 바 */
        #feedback-bar { padding: 12px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; }
        #feedback-bar.success { background-color: #d1e7dd; color: #0f5132; }
        #feedback-bar.error { background-color: #f8d7da; color: #842029; }

        /* 폼 그룹 */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
        
        /* 목표 설정 UI */
        #goal-view { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        #goal-view h4 { margin-top: 0; margin-bottom: 15px; }
        .goal-input-group { display: flex; align-items: center; gap: 8px; }
        #goal-view label { font-size: 0.9em; }
        #goal-view input[type="number"] { width: 80px; text-align: center; }
        #goal-view .button { width: auto; margin: 0; }
        #goal-status { font-weight: 600; font-size: 1.1em; }

        /* 과목 아이템 */
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; }
        .subject-name-container { display: flex; align-items: center; margin-bottom: 12px; }
        .subject-item-name { font-weight: 600; font-size: 1.1rem; }
        .subject-item-buttons { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .subject-item-buttons .button { width: auto; margin: 0; padding: 8px 12px; font-size: 0.9em; }
        .subject-goal-controls input[type="number"] { width: 60px; padding: 5px; text-align: center; }
        .subject-goal-controls .button { width: auto; padding: 5px 10px; margin: 0; }
        .edit-btn, .delete-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.1rem; color: #6c757d; margin-left: 5px; }
        .edit-btn:hover, .delete-btn:hover { color: #212529; }
        .subject-name-input { font-size: 1.1rem; font-weight: 600; border: 1px solid #0d6efd; padding: 5px; border-radius: 4px; flex-grow: 1; }
        
        /* 문제 관리 화면 */
        #add-problem-container { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .question-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .question-item:last-child { border-bottom: none; }
        .question-item-text { flex-grow: 1; margin-right: 15px; }
        .question-item-actions { display: flex; gap: 10px; }

        /* 퀴즈 화면 */
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .final-result { text-align: center; padding: 20px; }
        
        .dynamic-field-group .inputs { flex-grow: 1; }
        .dynamic-field-group .field-label { font-size: 0.9em; color: #6c757d; min-width: 25px; }
        .remove-btn { padding: 8px 12px; font-size: 0.9em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        .subject-item-name { font-weight: bold; }
    
        .question-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .question-item-text { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .question-item-button { flex-shrink: 0; width: auto; margin: 0; padding: 6px 10px; font-size: 0.9em; }
       
        .final-result h2 { font-size: 2em; margin-bottom: 10px; }
        .final-result p { font-size: 1.2em; }
        
        #tree-container { padding: 10px; }
        #tree-container ul { padding-left: 1em; list-style: none; position: relative; }
        #tree-container ul ul { margin-left: .5em; }
        #tree-container li { position: relative; padding: 4px 0 4px 1.2em; line-height: 1.5; }
        #tree-container li::before { content: ""; position: absolute; top: 0; left: 0; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; width: 1em; height: 1em; }
        #tree-container li::after { content: ""; position: absolute; top: 1em; left: 0; bottom: 0; border-left: 1px solid #ccc; }
        #tree-container li:last-child::after { display: none; }
        #tree-container li.expandable { cursor: pointer; }
        #tree-container li.expandable > .node-text { font-weight: bold; }
        #tree-container li.expandable > .node-text:hover { color: #0d6efd; }
        #tree-container li.expandable::before { content: "[+] "; font-family: monospace; border: none; width: auto; height: auto; top: 2px; }
        #tree-container li.expandable.expanded::before { content: "[-] "; }
        #tree-container li.expandable.expanded > ul { display: block; }
        #tree-container li > ul { display: none; }
        #tree-container .concept-badges-container { display: block; padding-left: 1.2em; margin-top: 4px; }
        .concept-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.75em;
            border-radius: 10px;
            margin-right: 5px;
            margin-bottom: 4px;
        }
        .badge-keyword { background-color: #e0eaff; color: #4361ee; }
        .badge-tag { background-color: #dcfce7; color: #16a34a; }
        .badge-metatag { background-color: #fefce8; color: #b45309; }

        /* ✨ 점진적 학습 기능 스타일 추가 ✨ */
        .goal-input-group { display: flex; align-items: center; gap: 8px; }
        
        .goal-setup {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .goal-setup input {
            width: 80px;
            text-align: center;
        }
        .goal-setup .button {
            width: auto;
            margin-top: 0;
            padding: 10px 15px;
        }
        #goal-status {
            font-weight: bold;
            font-size: 1.1em;
        }
        #goal-status .progress {
            color: #0d6efd;
        }
        #goal-status .goal {
            color: #6c757d;
        }

        .subject-goal-controls label, .goal-input-group label { white-space: nowrap; font-size: 0.9em; }
        
        .subject-goal-controls .button, .goal-input-group .button { width: auto; padding: 5px 10px; margin: 0; }

        .subject-item-buttons .edit-btn, .subject-item-buttons .delete-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.1rem; color: #6c757d; }
        
    </style>
</head>
<body>
    <div class="container">
        <div id="feedback-bar" class="hidden"></div>

        <div id="auth-container">
            <span id="user-email"></span>
            <div id="logged-out-view">
                <button class="button light-button" onclick="showView('login-view')">로그인</button>
                <button class="button primary-button" onclick="showView('signup-view')">회원가입</button>
            </div>
            <div id="logged-in-view" class="hidden">
                <button class="button secondary-button" onclick="logOut()">로그아웃</button>
            </div>
        </div>

        <div id="subject-view">
            <h2>과목 선택</h2>
            <div id="goal-view">
                <h4>🎯 오늘의 학습 목표</h4>
                <div id="goal-setup-view">
                    <div class="goal-input-group">
                        <input type="number" id="goal-input" min="1" value="10">
                        <button class="button primary-button" onclick="setDailyGoal()">목표 설정</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #555;">
                        <input type="checkbox" id="reset-progress-checkbox" checked>
                        <label for="reset-progress-checkbox">진행도 함께 초기화</label>
                    </div>
                </div>
                <div id="goal-status-view" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                    <span id="goal-status" style="flex-grow: 1;"></span>
                    <button class="button light-button small-button" onclick="resetDailyProgress()">진행도 0으로</button>
                    <button class="button light-button small-button" onclick="resetDailyGoal()">목표 재설정</button>
                </div>
            </div>
            <div id="subject-list"></div>
        </div>

        <div id="quiz-view" class="hidden">
            <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;"></div>
            <div id="quiz-body"></div>
            <div id="immediate-feedback" style="margin-top: 15px;"></div>
            <hr style="margin:20px 0;">
            <button class="button light-button" onclick="exitQuiz()">↩️ 과목 선택으로</button>
        </div>
            
        <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;"></div>
        <div id="quiz-body"></div>
        <div id="immediate-feedback"></div>
        <hr style="margin:20px 0;">
        <button class="button secondary-button" onclick="showManagementView({ refetch: true })">📋 문제 관리</button>
        <button class="button primary-button" onclick="startWeaknessQuiz()">🎯 취약점 공략 퀴즈</button>
        <button class="button light-button" onclick="exitQuiz()">↩️ 과목 선택으로</button>
        </div>

        <div id="management-view" class="hidden">
            <h2 id="management-header"></h2>
            <div id="add-problem-container" class="hidden"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="button primary-button" style="margin-top:0;" onclick="showProblemAddForm()">+ 새 문제 추가</button>
            </div>
            <div id="question-list-container"></div>
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로</button>
        </div>

        <div id="tree-view" class="hidden">
            <h2>🌳 지식 트리</h2>
            <div id="tree-container">지식 트리 로딩 중...</div>
            <hr>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">↩️ 문제 관리로</button>
        </div>
        
        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            <h4>1. 문제 정보</h4>
            <div class="form-group"><label for="q-text">문제 내용</label><textarea id="q-text" rows="3"></textarea></div>
            <div class="form-group"><label for="q-answer">정답</label><input type="text" id="q-answer"></div>
            <div class="form-group"><label for="q-explanation">해설</label><textarea id="q-explanation" rows="3"></textarea></div>
            <div class="form-group"><label for="q-part">소속 파트</label><select id="q-part"></select></div>
            <hr>
            <h4>2. 개념 분석 (선택)</h4>
            <div class="form-group"><label>구조화된 키워드</label><div id="q-keywords-container"></div><button class="button light-button" onclick="addKeywordField()">+ 키워드 추가</button></div>
            <div class="form-group"><label>구조화된 태그</label><div id="q-tags-container"></div><button class="button light-button" onclick="addTagField()">+ 태그 추가</button></div>
            <div class="form-group"><label>구조화된 메타태그</label><div id="q-metatags-container"></div><button class="button light-button" onclick="addMetatagField()">+ 메타태그 추가</button></div>
            <hr>
            <h4>3. 객관식 보기 (선택)</h4>
            <div id="q-options-container"></div>
            <button class="button light-button" onclick="addOptionField()">+ 보기 추가</button>
            <hr>
            <button id="save-btn" class="button primary-button">저장</button>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">← 관리 화면으로</button>
        </div>

        <div id="bulk-add-view" class="hidden">
             <h2>📚 여러 문제 추가</h2>
            <div class="form-group"><textarea id="bulk-text" rows="10" placeholder="문제: ..."></textarea></div>
            <button class="button primary-button" onclick="addBulkQuestions()">DB에 저장</button>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">← 관리 화면으로</button>
        </div>
        
        <div id="signup-view" class="hidden">
            <h2>회원가입</h2>
            <div class="form-group"><label for="signup-email">이메일</label><input type="email" id="signup-email"></div>
            <div class="form-group"><label for="signup-password">비밀번호</label><input type="password" id="signup-password"></div>
            <button class="button primary-button" onclick="signUp()">회원가입</button>
            <button class="button light-button" onclick="showView('subject-view')">취소</button>
        </div>
    </div>

        <div id="management-view" class="hidden">
             </div>
        <div id="login-view" class="hidden">
            <h2>로그인</h2>
            <div class="form-group"><label for="login-email">이메일</label><input type="email" id="login-email"></div>
            <div class="form-group"><label for="login-password">비밀번호</label><input type="password" id="login-password"></div>
            <button class="button primary-button" onclick="logIn()">로그인</button>
            <button class="button light-button" onclick="showView('subject-view')">취소</button>
        </div>
        
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
    
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 전역 변수
    let currentSubjectId, currentSubjectData, allQuestionsForSubject = [];
    let quizProblemsAttempted = 0, quizScore = 0, currentQuizIndex = 0;
    let dailyGoal = 0, dailyProgress = 0;
    let subjectGoals = {}, subjectProgress = {};
    const views = ['subject-view', 'quiz-view', 'management-view', 'login-view', 'signup-view'];

     /** 팝업 대신 피드백 바를 보여주는 새로운 함수 */
     function showFeedback(message, type = 'error') {
        const feedbackBar = document.getElementById('feedback-bar');
        feedbackBar.textContent = message;
        feedbackBar.className = type;
        feedbackBar.classList.remove('hidden');
        setTimeout(() => feedbackBar.classList.add('hidden'), 3000);
    }

    /** 새로운 과목을 Firestore에 추가하는 함수 */
    async function addSubject() {
        const input = document.getElementById('new-subject-name');
        const subjectName = input.value.trim();
        if (!subjectName) { showFeedback('과목 이름을 입력해주세요.'); return; }
        try {
            await db.collection('subjects').add({ name: subjectName, questionCount: 0 });
            showFeedback(`'${subjectName}' 과목이 추가되었습니다.`, 'success');
            hideAddSubjectForm();
            await loadSubjects();
        } catch (error) { console.error("과목 추가 중 오류:", error); showFeedback('과목 추가 중 오류가 발생했습니다.'); }
    }

    /** 과목 추가 입력 창을 보여주는 함수 */
    function showAddSubjectForm() {
        document.getElementById('add-subject-form').classList.remove('hidden');
        document.getElementById('add-subject-button').classList.add('hidden');
    }
    function hideAddSubjectForm() {
        document.getElementById('add-subject-form').classList.add('hidden');
        document.getElementById('new-subject-name').value = '';
        document.getElementById('add-subject-button').classList.remove('hidden');
    }

    /** 과목과 그 하위 문제들을 모두 삭제하는 함수 */
    async function deleteSubject(subjectId, subjectName) {
        // 1단계: 삭제 버튼을 '확인' 버튼으로 변경 (팝업 대체)
        const deleteBtn = document.getElementById(`delete-btn-${subjectId}`);
        if (deleteBtn.textContent !== '삭제 확인') {
            deleteBtn.textContent = '삭제 확인';
            deleteBtn.style.backgroundColor = '#dc3545'; // 빨간색으로 변경
            // 5초 후에 원래대로 되돌리는 타임아웃
            setTimeout(() => {
                deleteBtn.textContent = '삭제';
                deleteBtn.style.backgroundColor = '';
            }, 5000);
            return;
        }

        // 2단계: '확인' 버튼을 눌렀을 때 실제 삭제 로직 실행
        showFeedback(`'${subjectName}' 과목을 삭제하고 있습니다...`);
        try {
            const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get();
            const batch = db.batch();

            // 하위 'questions' 문서들을 모두 삭제 목록에 추가
            questionsSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            // 부모 'subject' 문서도 삭제 목록에 추가
            const subjectRef = db.collection('subjects').doc(subjectId);
            batch.delete(subjectRef);

            // 일괄 삭제 실행
            await batch.commit();

            showFeedback(`'${subjectName}' 과목이 성공적으로 삭제되었습니다.`, 'success');
            await loadSubjects(); // 과목 목록 새로고침

        } catch (error) {
            console.error("과목 삭제 중 오류:", error);
            showFeedback('과목 삭제 중 오류가 발생했습니다.');
        }
    }

    /** 과목 목록을 불러오는 수정된 함수 (과목 관리 버튼 추가) */
    async function loadSubjects() {
        const listDiv = document.getElementById('subject-list');
        listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">과목 로딩 중...</div>';
        try {
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            for (const doc of snapshot.docs) {
                const subject = doc.data();
                const subjectId = doc.id;
                const subjectName = subject.name;
                const item = document.createElement('div');
                item.className = 'subject-item';
                const currentProgress = subjectProgress[subjectId] || 0;
                const currentGoal = subjectGoals[subjectId] || '미설정';
    
                item.innerHTML = `
                    <div id="subject-info-${subjectId}" style="flex-grow: 1;">
                        <div id="subject-name-container-${subjectId}" style="display: flex; align-items: center;">
                            <span class="subject-item-name">${subjectName} (${subject.questionCount || 0}문제)</span>
                            <button class="edit-btn" onclick="startEditSubject('${subjectId}', '${subjectName}')">✏️</button>
                        </div>
                        <div class="subject-goal-controls" style="margin-top: 10px; font-size: 0.9em;">
                             </div>
                    </div>
                    <div class="subject-item-buttons">
                        <button class="button primary-button" onclick="startQuiz('${subjectId}')">퀴즈 시작</button>
                        <button class="button secondary-button" onclick="manageSubject('${subjectId}')">문제 관리</button>
                        <button id="delete-btn-${subjectId}" class="delete-btn" onclick="deleteSubject('${subjectId}', '${subjectName}')">🗑️ 삭제</button>
                    </div>
                `;
                 // 목표 설정 UI 부분만 따로 채워넣어 가독성 확보
                item.querySelector('.subject-goal-controls').innerHTML = `
                    <div class="goal-input-group">
                        <label for="goal-input-${subjectId}">과목 목표:</label>
                        <input type="number" id="goal-input-${subjectId}" min="1" value="10">
                        <button class="button light-button" onclick="setSubjectGoal('${subjectId}')">설정</button>
                        <span id="subject-goal-status-${subjectId}">(달성: ${currentProgress} / ${currentGoal})</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9em; color: #555;">
                        <input type="checkbox" id="reset-subject-progress-checkbox-${subjectId}" checked>
                        <label for="reset-subject-progress-checkbox-${subjectId}">진행도 함께 초기화</label>
                    </div>
                `;
                listDiv.appendChild(item);
            }
            // 과목 추가 UI
            listDiv.insertAdjacentHTML('beforeend', `
                <div id="add-subject-form" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div class="form-group">
                        <label for="new-subject-name" style="font-weight: bold;">새 과목 이름</label>
                        <input type="text" id="new-subject-name" placeholder="예: 정보처리기사 필기">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button class="button light-button" style="flex: 1;" onclick="hideAddSubjectForm()">취소</button>
                        <button class="button primary-button" style="flex: 1;" onclick="addSubject()">저장</button>
                    </div>
                </div>
                <button id="add-subject-button" class="button primary-button" onclick="showAddSubjectForm()">+ 새 과목 추가</button>
            `);
        } catch (error) {
            console.error("과목 로딩 중 오류:", error);
            showFeedback('과목을 불러오는 중 오류가 발생했습니다.');
        }
    }

    /** 과목 이름 수정을 시작하는 함수 */
    function startEditSubject(subjectId, currentName) {
        const nameContainer = document.getElementById(`subject-name-container-${subjectId}`);
        const buttonsContainer = nameContainer.closest('.subject-item').querySelector('.subject-item-buttons');
        nameContainer.innerHTML = `<input type="text" id="edit-subject-input-${subjectId}" class="subject-name-input" value="${currentName}">`;
        buttonsContainer.innerHTML = `
            <button class="button light-button small-button" onclick="cancelEdit()">취소</button>
            <button class="button primary-button small-button" onclick="saveSubjectUpdate('${subjectId}')">저장</button>
        `;
        document.getElementById(`edit-subject-input-${subjectId}`).focus();
    }
    
    /** 과목 이름 수정 내용을 저장하는 함수 */
    async function saveSubjectUpdate(subjectId) {
        const input = document.getElementById(`edit-subject-input-${subjectId}`);
        const newName = input.value.trim();
        if (!newName) { showFeedback("과목 이름은 비워둘 수 없습니다."); return; }
        try {
            await db.collection('subjects').doc(subjectId).update({ name: newName });
            showFeedback("과목 이름이 수정되었습니다.", "success");
        } catch (error) { console.error("과목 이름 수정 중 오류:", error); showFeedback("과목 이름 수정 중 오류가 발생했습니다."); }
        await loadSubjects();
    }

    /** 과목 이름 수정을 취소하고 원래대로 되돌리는 함수 */
    function cancelEdit() { loadSubjects(); }
    
    /** 과목과 그 하위 문제들을 모두 삭제하는 함수 (2단계 확인) */
    async function deleteSubject(subjectId, subjectName) {
        const deleteBtn = document.getElementById(`delete-btn-${subjectId}`);
        if (deleteBtn.innerHTML !== '🗑️ 삭제 확인') {
            const originalHTML = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '🗑️ 삭제 확인';
            deleteBtn.style.color = '#dc3545';
            setTimeout(() => {
                const currentBtn = document.getElementById(`delete-btn-${subjectId}`);
                if (currentBtn) { currentBtn.innerHTML = originalHTML; currentBtn.style.color = '#6c757d'; }
            }, 4000);
            return;
        }
        showFeedback(`'${subjectName}' 과목을 삭제하고 있습니다...`);
        try {
            const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get();
            const batch = db.batch();
            questionsSnapshot.forEach(doc => batch.delete(doc.ref));
            const subjectRef = db.collection('subjects').doc(subjectId);
            batch.delete(subjectRef);
            await batch.commit();
            showFeedback(`'${subjectName}' 과목이 삭제되었습니다.`, 'success');
            await loadSubjects();
        } catch (error) { console.error("과목 삭제 중 오류:", error); showFeedback('과목 삭제 중 오류가 발생했습니다.'); }
    }
        
    // ==================================
    // ## 핵심 유틸리티 함수 ##
    // ==================================
    function showView(viewId) { views.forEach(id => document.getElementById(id)?.classList.toggle('hidden', id !== viewId)); }
    
    function showFeedback(message, type = 'error') {
        const feedbackBar = document.getElementById('feedback-bar');
        feedbackBar.textContent = message;
        feedbackBar.className = type;
        feedbackBar.classList.remove('hidden');
        setTimeout(() => feedbackBar.classList.add('hidden'), 3000);
    }
    function getTodayDateString() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }


    function getTodayDateString() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

    // ==================================
    // ## DB 저장/로드 함수 ##
    // ==================================
    async function saveDailyLog() {
        const user = auth.currentUser; if (!user) return;
        const logRef = db.collection('users').doc(user.uid).collection('daily_logs').doc(getTodayDateString());
        const logData = { totalGoal: dailyGoal, totalProgress: dailyProgress, subjectGoals: subjectGoals, subjectProgress: subjectProgress, lastUpdated: new Date() };
        try { await logRef.set(logData, { merge: true }); } catch (error) { console.error("학습 기록 저장 중 오류:", error); }
    }
        
    async function loadDailyLog() {
        const user = auth.currentUser; if (!user) return;
        const logRef = db.collection('users').doc(user.uid).collection('daily_logs').doc(getTodayDateString());
        try {
            const doc = await logRef.get();
            if (doc.exists) {
                const data = doc.data();
                dailyGoal = data.totalGoal || 0; dailyProgress = data.totalProgress || 0;
                subjectGoals = data.subjectGoals || {}; subjectProgress = data.subjectProgress || {};
                if (dailyGoal > 0) {
                    document.getElementById('goal-setup-view').classList.add('hidden');
                    document.getElementById('goal-status-view').classList.remove('hidden');
                    updateGoalStatusDisplay();
                }
            }
        } catch (error) { console.error("학습 기록 불러오는 중 오류:", error); }
    }

    // ==================================
    // ## 인증 및 앱 시작 함수 ##
    // ==================================
    auth.onAuthStateChanged(async (user) => {
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const userEmailSpan = document.getElementById('user-email');
        if (user) {
            loggedInView.classList.remove('hidden'); loggedOutView.classList.add('hidden');
            userEmailSpan.textContent = `${user.email}님`;
            await loadDailyLog();
            await loadSubjects();
        } else {
            loggedInView.classList.add('hidden'); loggedOutView.classList.remove('hidden');
            userEmailSpan.textContent = '';
            document.getElementById('subject-list').innerHTML = '<p>로그인 후 이용해주세요.</p>';
            showView('subject-view');
        }
    });

    async function signUp() { try { await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); } catch (e) { showFeedback(e.message); } }
    async function logIn() { try { await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); } catch (e) { showFeedback(e.message); } }
    function logOut() { auth.signOut(); }
    
    // ==================================
    // ## 학습 목표 관리 함수 ##
    // ==================================
    function setDailyGoal() {
        const goalInput = document.getElementById('goal-input');
        const goalValue = parseInt(goalInput.value, 10);
        if (isNaN(goalValue) || goalValue <= 0) { showFeedback('1 이상의 숫자를 목표로 설정해주세요.'); return; }
        const shouldResetProgress = document.getElementById('reset-progress-checkbox').checked;
        dailyGoal = goalValue;
        if (shouldResetProgress) { dailyProgress = 0; }
        document.getElementById('goal-setup-view').classList.add('hidden');
        document.getElementById('goal-status-view').classList.remove('hidden');
        document.getElementById('reset-progress-checkbox').checked = true;
        updateGoalStatusDisplay();
        saveDailyLog();
    }

    function resetDailyGoal() { dailyGoal = 0; document.getElementById('goal-status-view').classList.add('hidden'); document.getElementById('goal-setup-view').classList.remove('hidden'); saveDailyLog(); }
    
    function resetDailyProgress() {
        dailyProgress = 0;
        updateGoalStatusDisplay();
        saveDailyLog();
        showFeedback('진행도가 0으로 초기화되었습니다.', 'success');
    }
    
    function setSubjectGoal(subjectId) {
        const goalInput = document.getElementById(`goal-input-${subjectId}`);
        const goalValue = parseInt(goalInput.value, 10);
        if (isNaN(goalValue) || goalValue <= 0) { showFeedback('1 이상의 숫자를 목표로 설정해주세요.'); return; }
        const shouldResetProgress = document.getElementById(`reset-subject-progress-checkbox-${subjectId}`).checked;
        subjectGoals[subjectId] = goalValue;
        if (shouldResetProgress) { subjectProgress[subjectId] = 0; }
        document.getElementById(`reset-subject-progress-checkbox-${subjectId}`).checked = true;
        updateSubjectStatusDisplay(subjectId);
        saveDailyLog();
    }

    function updateGoalStatusDisplay() { document.getElementById('goal-status').innerHTML = `오늘의 목표: <span class="progress">${dailyProgress}</span> / <span class="goal">${dailyGoal}</span> 문제`; }
    
    function updateSubjectStatusDisplay(subjectId) {
        const statusSpan = document.getElementById(`subject-goal-status-${subjectId}`);
        if(statusSpan) {
            statusSpan.textContent = `(달성: ${subjectProgress[subjectId] || 0} / ${subjectGoals[subjectId] || '미설정'})`;
        }
    }
        
    function updateDailyProgress(attemptedCount) {
        if (dailyGoal <= 0) return;
        const progressBefore = dailyProgress;
        dailyProgress += attemptedCount;
        updateGoalStatusDisplay();
        if ((dailyProgress >= dailyGoal) && (progressBefore < dailyGoal)) { showFeedback('🎉 오늘의 통합 학습 목표를 달성했습니다! 대단해요!', 'success'); }
    }
    
    // ==================================
    // ## 과목 및 문제 로드/관리 함수 ##
    // ==================================
    async function loadSubjects() {
        const listDiv = document.getElementById('subject-list');
        listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">과목 로딩 중...</div>';
        try {
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            for (const doc of snapshot.docs) {
                const subject = doc.data();
                const subjectId = doc.id;
                const subjectName = subject.name;
                const item = document.createElement('div');
                item.className = 'subject-item';
                item.innerHTML = `
                    <div style="flex-grow: 1;">
                        <div class="subject-name-container" id="subject-name-container-${subjectId}">
                            <span class="subject-item-name">${subjectName} (${subject.questionCount || 0}문제)</span>
                        </div>
                        <div class="subject-goal-controls" style="margin-top: 10px;">
                            <div class="goal-input-group">
                                <label for="goal-input-${subjectId}">과목 목표:</label>
                                <input type="number" id="goal-input-${subjectId}" min="1" value="10">
                                <button class="button light-button small-button" onclick="setSubjectGoal('${subjectId}')">설정</button>
                                <span id="subject-goal-status-${subjectId}"></span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.9em; color: #555;">
                                <input type="checkbox" id="reset-subject-progress-checkbox-${subjectId}" checked>
                                <label for="reset-subject-progress-checkbox-${subjectId}">진행도 함께 초기화</label>
                            </div>
                        </div>
                    </div>
                    <div class="subject-item-buttons">
                        <button class="button primary-button" onclick="startQuiz('${subjectId}')">퀴즈 시작</button>
                        <button class="button secondary-button" onclick="manageSubject('${subjectId}')">문제 관리</button>
                        <button class="edit-btn" onclick="startEditSubject('${subjectId}', '${subjectName}')">✏️</button>
                        <button id="delete-btn-${subjectId}" class="delete-btn" onclick="deleteSubject('${subjectId}', '${subjectName}')">🗑️</button>
                    </div>
                `;
                listDiv.appendChild(item);
                updateSubjectStatusDisplay(subjectId);
            }
            listDiv.insertAdjacentHTML('beforeend', `
                <div id="add-subject-form" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div class="form-group"> <label for="new-subject-name" style="font-weight: bold;">새 과목 이름</label> <input type="text" id="new-subject-name" placeholder="예: 정보처리기사 필기"> </div>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button class="button light-button" style="flex: 1;" onclick="hideAddSubjectForm()">취소</button>
                        <button class="button primary-button" style="flex: 1;" onclick="addSubject()">저장</button>
                    </div>
                </div>
                <button id="add-subject-button" class="button primary-button" onclick="showAddSubjectForm()">+ 새 과목 추가</button>
            `);
        } catch (error) { console.error("과목 로딩 중 오류:", error); showFeedback('과목을 불러오는 중 오류가 발생했습니다.'); }
    }

    async function manageSubject(id) {
        const doc = await db.collection('subjects').doc(id).get();
        if (!doc.exists) { showFeedback("과목 정보를 찾을 수 없습니다."); return; }
        currentSubjectId = id;
        currentSubjectData = doc.data();
        await showManagementView({ refetch: true });
    }

    // ==================================
    // ## 퀴즈 실행 함수 ##
    // ==================================
    async function startQuiz(id, questions = null) {
        if (id) {
            const doc = await db.collection('subjects').doc(id).get();
            if (!doc.exists) return;
            currentSubjectId = id;
            currentSubjectData = doc.data();
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
            quizQuestions = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort(() => 0.5 - Math.random());
        } else {
            quizQuestions = questions;
        }
        currentQuizIndex = 0;
        quizScore = 0;
        quizProblemsAttempted = 0;
        showView('quiz-view');
        displayCurrentQuiz();
    }
    
    async function exitQuiz() {
        const attempted = quizProblemsAttempted;
        if (attempted > 0) {
            updateDailyProgress(attempted);
            if (subjectGoals[currentSubjectId]) {
                subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
            }
            await saveDailyLog();
        }
        await loadSubjects();
        showView('subject-view');
    }

    async function displayCurrentQuiz() {
        const quizBody = document.getElementById('quiz-body');
        const feedbackDiv = document.getElementById('immediate-feedback');
        selectedOption = null;
        feedbackDiv.className = '';
        feedbackDiv.innerHTML = '';
        if (currentQuizIndex >= quizQuestions.length) {
            quizBody.innerHTML = `<div class="final-result"><h2>🎉 퀴즈가 끝났습니다!</h2><p>총 ${quizQuestions.length}문제 중 <strong>${quizScore}개</strong>를 맞히셨습니다.</p></div>`;
            const attempted = quizProblemsAttempted;
            if (attempted > 0) {
                updateDailyProgress(attempted);
                if (subjectGoals[currentSubjectId]) {
                    subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
                }
                await saveDailyLog();
            }
            await loadSubjects();
            return;
        }
        const data = quizQuestions[currentQuizIndex];
        let optionsHTML = (data.options || []).map(opt => `<div class="option">${opt}</div>`).join('');
        quizBody.innerHTML = `<h4>${currentQuizIndex + 1}. ${data.text}</h4><div>${optionsHTML}</div>`;
        feedbackDiv.innerHTML = `<button id="submit-btn" class="button primary-button">정답 확인</button>`;
        document.querySelectorAll('.option').forEach(li => {
            li.onclick = (e) => {
                document.querySelector('.option.selected')?.classList.remove('selected');
                e.currentTarget.classList.add('selected');
                selectedOption = e.currentTarget.textContent;
            }
        });
        document.getElementById('submit-btn').onclick = submitAnswer;
    }

    function submitAnswer() {
        if (!selectedOption) {
            showFeedback("보기를 선택해주세요."); // alert 대체
            return;
        }
        quizProblemsAttempted++;
        const data = quizQuestions[currentQuizIndex];
        const isCorrect = selectedOption === data.answer;
        const feedbackDiv = document.getElementById('immediate-feedback');
        if (isCorrect) {
            quizScore++;
            feedbackDiv.className = 'feedback correct';
            feedbackDiv.innerHTML = `<p><strong>정답입니다!</strong></p>`;
        } else {
            feedbackDiv.className = 'feedback incorrect';
            feedbackDiv.innerHTML = `<p><strong>오답입니다.</strong> 정답: ${data.answer}</p>`;
        }
        if (data.explanation) feedbackDiv.innerHTML += `<p>해설: ${data.explanation}</p>`;
        document.querySelectorAll('.option').forEach(opt => {
            opt.style.cursor = 'default';
            opt.onclick = null;
            if (opt.textContent === data.answer) opt.style.cssText += 'background-color: #d1e7dd; border-color: #198754;';
            else if (opt.textContent === selectedOption) opt.style.cssText += 'background-color: #f8d7da; border-color: #dc3545;';
        });
        const nextButton = document.createElement('button');
        nextButton.className = 'button primary-button';
        nextButton.textContent = '다음 문제 →';
        nextButton.onclick = () => { currentQuizIndex++; displayCurrentQuiz(); };
        feedbackDiv.appendChild(nextButton);
    }
    
    // ==================================
    // ## 그 외 나머지 함수들 ##
    // ==================================
    async function showTreeView() {
        showView('tree-view');
        const container = document.getElementById('tree-container');
        container.innerHTML = '';
        const parts = {};
        allQuestionsForSubject.forEach(q => {
            const partName = q.partName || '미지정 파트';
            if (!parts[partName]) parts[partName] = [];
            parts[partName].push(q);
        });
        let treeHTML = '<ul>';
        treeHTML += `<li class="expandable"><span class="node-text">${currentSubjectData.name}</span><ul>`;
        const sortedPartNames = currentSubjectData.partOrder || Object.keys(parts).sort();
        sortedPartNames.forEach(partName => {
            if (!parts[partName]) return;
            treeHTML += `<li class="expandable"><span class="node-text">${partName}</span><ul>`;
            parts[partName].forEach(q => {
                let conceptsHTML = '';
                (q.keywords || []).forEach(kw => { conceptsHTML += `<span class="concept-badge badge-keyword">${kw}</span>`; });
                (q.tags || []).forEach(tag => { conceptsHTML += `<span class="concept-badge badge-tag">${tag}</span>`; });
                (q.metatags || []).forEach(mt => { conceptsHTML += `<span class="concept-badge badge-metatag">${mt}</span>`; });
                const conceptsContainer = conceptsHTML ? `<div class="concept-badges-container">${conceptsHTML}</div>` : '';
                treeHTML += `<li><span class="node-text">${q.fixedId || ''}. ${q.text}</span>${conceptsContainer}</li>`;
            });
            treeHTML += '</ul></li>';
        });
        treeHTML += '</ul></li></ul>';
        container.innerHTML = treeHTML;
        if (container.querySelector('li.expandable')) {
            container.querySelector('li.expandable').classList.add('expanded');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const treeContainer = document.getElementById('tree-container');
        if (treeContainer) {
            treeContainer.addEventListener('click', function(e) {
                const targetLi = e.target.closest('.expandable');
                if (targetLi) {
                    targetLi.classList.toggle('expanded');
                }
            });
        }
    });

    function showAddForm() { showEditForm(null); }
    function showBulkAddView() { showView('bulk-add-view'); }

    function showEditForm(id) {
        const isEditing = !!id;
        const q = isEditing ? allQuestionsForSubject.find(q => q.id === id) : {};
        showView('add-edit-view');
        document.getElementById('add-edit-header').textContent = isEditing ? '문제 수정' : '새 문제 추가';
        document.getElementById('editing-question-id').value = id || '';
        document.getElementById('q-text').value = q.text || '';
        document.getElementById('q-answer').value = q.answer || '';
        document.getElementById('q-explanation').value = q.explanation || '';
        populatePartSelect(q.partName);
        ['q-keywords-container', 'q-tags-container', 'q-metatags-container', 'q-options-container'].forEach(id => document.getElementById(id).innerHTML = '');
        (q.keywords || ['']).forEach(kw => addKeywordField(kw));
        (q.tags || ['']).forEach(t => addTagField(t));
        (q.metatags || ['']).forEach(mt => addMetatagField(mt));
        (q.options || ['']).forEach(opt => addOptionField(opt));
        document.getElementById('save-btn').onclick = saveQuestion;
    }

    function createDynamicField(container, placeholder, value) {
        const group = document.createElement('div');
        group.className = 'dynamic-field-group';
        const count = container.querySelectorAll('.dynamic-field-group').length + 1;
        const label = document.createElement('span');
        label.className = 'field-label';
        label.textContent = `${count}.`;
        const inputsDiv = document.createElement('div');
        inputsDiv.className = 'inputs';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = placeholder;
        input.value = value;
        inputsDiv.appendChild(input);
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = 'X';
        removeBtn.onclick = () => { group.remove(); updateFieldLabels(container); };
        group.appendChild(label);
        group.appendChild(inputsDiv);
        group.appendChild(removeBtn);
        container.appendChild(group);
    }

    function updateFieldLabels(container) {
        container.querySelectorAll('.dynamic-field-group').forEach((group, index) => {
            group.querySelector('.field-label').textContent = `${index + 1}.`;
        });
    }

    function addKeywordField(value = '') { createDynamicField(document.getElementById('q-keywords-container'), '키워드', value); }
    function addTagField(value = '') { createDynamicField(document.getElementById('q-tags-container'), '태그값', value); }
    function addMetatagField(value = '') { createDynamicField(document.getElementById('q-metatags-container'), '메타태그', value); }
    function addOptionField(value = '') { createDynamicField(document.getElementById('q-options-container'), '보기 내용', value); }

    function populatePartSelect(selectedValue) {
        const select = document.getElementById('q-part');
        select.innerHTML = '';
        (currentSubjectData.partOrder || []).forEach(part => {
            const opt = document.createElement('option');
            opt.value = part; 
            opt.textContent = part;
            if (part === selectedValue) opt.selected = true;
            select.appendChild(opt);
        });
    }

    async function saveQuestion() {
        const id = document.getElementById('editing-question-id').value;
        const data = {
            text: document.getElementById('q-text').value.trim(),
            answer: document.getElementById('q-answer').value.trim(),
            explanation: document.getElementById('q-explanation').value.trim(),
            partName: document.getElementById('q-part').value,
            keywords: Array.from(document.querySelectorAll('#q-keywords-container input')).map(i => i.value.trim()).filter(Boolean),
            tags: Array.from(document.querySelectorAll('#q-tags-container input')).map(i => i.value.trim()).filter(Boolean),
            metatags: Array.from(document.querySelectorAll('#q-metatags-container input')).map(i => i.value.trim()).filter(Boolean),
            options: Array.from(document.querySelectorAll('#q-options-container input')).map(i => i.value.trim()).filter(Boolean)
        };
        if (!data.text || !data.answer || !data.partName) { alert("문제 내용, 정답, 소속 파트는 필수 항목입니다."); return; }
        try {
            if (id) {
                await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(data);
            } else {
                const subjectRef = db.collection('subjects').doc(currentSubjectId);
                const newDocRef = subjectRef.collection('questions').doc();
                await db.runTransaction(async t => {
                    const doc = await t.get(subjectRef);
                    const subjectData = doc.data();
                    const newCount = (subjectData.questionCount || 0) + 1;
                    data.fixedId = newCount;
                    t.set(newDocRef, data);
                    t.update(subjectRef, { questionCount: newCount });
                });
            }
            await manageSubject(currentSubjectId);
        } catch(e) { console.error("저장 중 오류 발생:", e); alert("저장 중 오류가 발생했습니다."); }
    }

    /** 과목 이름 수정 내용을 저장하는 함수 */
    async function saveSubjectUpdate(subjectId) {
        const input = document.getElementById(`edit-subject-input-${subjectId}`);
        const newName = input.value.trim();
        if (!newName) {
            showFeedback("과목 이름은 비워둘 수 없습니다.");
            return;
        }
        try {
            await db.collection('subjects').doc(subjectId).update({ name: newName });
            showFeedback("과목 이름이 수정되었습니다.", "success");
            await loadSubjects();
        } catch (error) {
            console.error("과목 이름 수정 중 오류:", error);
            showFeedback("과목 이름 수정 중 오류가 발생했습니다.");
        }
    }
    
    /** 과목 이름 수정을 취소하고 원래대로 되돌리는 함수 */
    function cancelEdit() {
        loadSubjects(); // 간단하게 목록을 다시 로드하여 수정 상태를 취소
    }
    
    /** 과목과 그 하위 문제들을 모두 삭제하는 함수 (2단계 확인) */
    async function deleteSubject(subjectId, subjectName) {
        const deleteBtn = document.getElementById(`delete-btn-${subjectId}`);
        if (deleteBtn.textContent !== '🗑️ 삭제 확인') {
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '🗑️ 삭제 확인';
            deleteBtn.style.color = '#dc3545';
            setTimeout(() => {
                deleteBtn.innerHTML = originalText;
                deleteBtn.style.color = '#6c757d';
            }, 4000);
            return;
        }
    
    async function manageSubject(id) {
            const doc = await db.collection('subjects').doc(id).get();
            if (!doc.exists) return;
            currentSubjectId = id;
            currentSubjectData = doc.data();
            await showManagementView({ refetch: true });
        }
    
        async function showManagementView(options = { refetch: true }) {
        showView('management-view');
        const header = document.getElementById('management-header');
        const container = document.getElementById('question-list-container');
        if (!header || !container) return; 

        header.textContent = `[${currentSubjectData.name}] 문제 관리`;
        
        if (options.refetch) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">문제 목록 로딩 중...</div>';
            const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('text', 'asc').get();
            allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        container.innerHTML = '';
        if (allQuestionsForSubject.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">등록된 문제가 없습니다. 새 문제를 추가해보세요.</p>';
        } else {
            allQuestionsForSubject.forEach(q => {
                const item = document.createElement('div');
                item.className = 'question-item';
                item.id = `question-item-${q.id}`;
                item.innerHTML = `
                    <div class="question-item-text">${q.text}</div>
                    <div class="question-item-actions">
                        <button class="button light-button small-button" onclick="showProblemEditForm('${q.id}')">수정</button>
                        <button id="delete-problem-btn-${q.id}" class="button light-button small-button" onclick="deleteProblem('${q.id}')">삭제</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        hideProblemAddForm();
    }
    
        function getProblemFormHTML(question = {}) {
        const isEditing = !!question.id;
        const qData = { text: '', answer: '', explanation: '', ...question };
        return `
            <h4>${isEditing ? '문제 수정' : '새 문제 추가'}</h4>
            <div class="form-group"><label>문제 내용</label><textarea id="q-text" rows="2">${qData.text}</textarea></div>
            <div class="form-group"><label>정답</label><input type="text" id="q-answer" value="${qData.answer}"></div>
            <div class="form-group"><label>해설 (선택)</label><textarea id="q-explanation" rows="2">${qData.explanation}</textarea></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="button light-button" onclick="${isEditing ? `cancelProblemEdit()` : 'hideProblemAddForm()'}">취소</button>
                <button class="button primary-button" onclick="${isEditing ? `saveProblemUpdate('${qData.id}')` : 'saveNewProblem()'}">저장</button>
            </div>
        `;
    }
    
        function showProblemAddForm() {
        const container = document.getElementById('add-problem-container');
        container.innerHTML = getProblemFormHTML();
        container.classList.remove('hidden');
    }
    function hideProblemAddForm() {
        const container = document.getElementById('add-problem-container');
        container.innerHTML = '';
        container.classList.add('hidden');
    }
    
        async function saveNewProblem() {
        const data = { text: document.getElementById('q-text').value.trim(), answer: document.getElementById('q-answer').value.trim(), explanation: document.getElementById('q-explanation').value.trim() };
        if (!data.text || !data.answer) { showFeedback("문제 내용과 정답은 필수입니다."); return; }
        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            await subjectRef.collection('questions').add(data);
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef);
                t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + 1 });
            });
            showFeedback("새 문제가 추가되었습니다.", "success");
            await showManagementView({ refetch: true });
        } catch (error) { console.error(error); showFeedback("문제 추가 중 오류 발생"); }
    }
    
        function showProblemEditForm(questionId) {
        const question = allQuestionsForSubject.find(q => q.id === questionId);
        const itemDiv = document.getElementById(`question-item-${questionId}`);
        itemDiv.innerHTML = getProblemFormHTML(question);
    }
        
        async function saveProblemUpdate(questionId) {
        const data = { text: document.getElementById('q-text').value.trim(), answer: document.getElementById('q-answer').value.trim(), explanation: document.getElementById('q-explanation').value.trim() };
        if (!data.text || !data.answer) { showFeedback("문제 내용과 정답은 필수입니다."); return; }
        try {
            await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(questionId).update(data);
            showFeedback("문제가 수정되었습니다.", "success");
            await showManagementView({ refetch: true });
        } catch (error) { console.error(error); showFeedback("문제 수정 중 오류 발생"); }
    }
    
        async function cancelProblemEdit() { await showManagementView({ refetch: false }); }
    
        async function deleteProblem(questionId) {
        const deleteBtn = document.getElementById(`delete-problem-btn-${questionId}`);
        if (deleteBtn.textContent !== '삭제 확인') {
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = '삭제 확인';
            deleteBtn.style.backgroundColor = '#f8d7da'; deleteBtn.style.color = '#842029';
            setTimeout(() => {
                const currentBtn = document.getElementById(`delete-problem-btn-${questionId}`);
                if (currentBtn) { currentBtn.textContent = originalText; currentBtn.style.backgroundColor = ''; currentBtn.style.color = ''; }
            }, 4000);
            return;
        }
        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            await subjectRef.collection('questions').doc(questionId).delete();
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef);
                t.update(subjectRef, { questionCount: (doc.data().questionCount || 1) - 1 });
            });
            showFeedback("문제가 삭제되었습니다.", "success");
            await showManagementView({ refetch: true });
        } catch(error) { console.error(error); showFeedback("문제 삭제 중 오류 발생"); }
    }

    showFeedback(`'${subjectName}' 과목을 삭제하고 있습니다...`);
    try {
        const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get();
        const batch = db.batch();
        questionsSnapshot.forEach(doc => batch.delete(doc.ref));
        
        const subjectRef = db.collection('subjects').doc(subjectId);
        batch.delete(subjectRef);
        
        await batch.commit();
        showFeedback(`'${subjectName}' 과목이 삭제되었습니다.`, 'success');
        await loadSubjects();
    } catch (error) {
        console.error("과목 삭제 중 오류:", error);
        showFeedback('과목 삭제 중 오류가 발생했습니다.');
    }
}
    let quizQuestions = [], selectedOption;
    async function startQuiz(id) {
        const doc = await db.collection('subjects').doc(id).get();
        if (!doc.exists) return;
        currentSubjectId = id;
        currentSubjectData = doc.data();
        const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
        quizQuestions = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort(() => 0.5 - Math.random());
        
        currentQuizIndex = 0;
        quizScore = 0;
        quizProblemsAttempted = 0;
        showView('quiz-view');
        displayCurrentQuiz();
    }
    async function exitQuiz() {
        const attempted = quizProblemsAttempted;
        if (attempted > 0) {
            updateDailyProgress(attempted);
            if (subjectGoals[currentSubjectId]) {
                subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
            }
            await saveDailyLog();
        }
        await loadSubjects();
        showView('subject-view');
    }
    function displayCurrentQuiz() {
        const quizView = document.getElementById('quiz-view');
        if (currentQuizIndex >= quizQuestions.length) {
            quizView.innerHTML = `
                <div class="final-result">
                    <h2>🎉 퀴즈가 끝났습니다!</h2>
                    <p>총 ${quizQuestions.length}문제 중 <strong>${quizScore}개</strong>를 맞히셨습니다.</p>
                </div>
                <button class="button primary-button" onclick="exitQuiz()">과목 선택으로 돌아가기</button>
            `;
            const attempted = quizProblemsAttempted;
            if (attempted > 0) {
                updateDailyProgress(attempted);
                if (subjectGoals[currentSubjectId]) {
                    subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
                }
                saveDailyLog();
            }
            return;
        }
        const data = quizQuestions[currentQuizIndex];
        let optionsHTML = (data.options || []).map(opt => `<div class="option">${opt}</div>`).join('');
        quizView.innerHTML = `
            <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;">${currentQuizIndex + 1} / ${quizQuestions.length}</div>
            <div id="quiz-body">
                <h4>${data.text}</h4>
                <div>${optionsHTML}</div>
            </div>
            <div id="immediate-feedback" style="margin-top: 15px;">
                <button id="submit-btn" class="button primary-button">정답 확인</button>
            </div>
            <hr style="margin:20px 0;">
            <button class="button light-button" onclick="exitQuiz()">↩️ 퀴즈 중단</button>
        `;

        quizView.querySelectorAll('.option').forEach(li => {
            li.onclick = (e) => {
                const selected = quizView.querySelector('.option.selected');
                if (selected) selected.classList.remove('selected');
                e.currentTarget.classList.add('selected');
                selectedOption = e.currentTarget.textContent;
            }
        });
        quizView.querySelector('#submit-btn').onclick = submitAnswer;
    }
    function submitAnswer() {
        const selectedOptElem = document.querySelector('.option.selected');
        if (!selectedOptElem) { showFeedback("보기를 선택해주세요."); return; }
        
        quizProblemsAttempted++;
        const data = quizQuestions[currentQuizIndex];
        const isCorrect = selectedOption === data.answer;
        const feedbackDiv = document.getElementById('immediate-feedback');
        
        let feedbackHTML = '';
        if (isCorrect) {
            quizScore++;
            feedbackHTML = `<div class="feedback correct"><p><strong>정답입니다!</strong></p></div>`;
        } else {
            feedbackHTML = `<div class="feedback incorrect"><p><strong>오답입니다.</strong> 정답: ${data.answer}</p></div>`;
        }
        if (data.explanation) {
            feedbackHTML += `<p style="margin-top:10px;"><strong>해설:</strong> ${data.explanation}</p>`;
        }
        
        feedbackHTML += `<button id="next-btn" class="button primary-button">다음 문제 →</button>`;
        feedbackDiv.innerHTML = feedbackHTML;
        
        feedbackDiv.querySelector('#next-btn').onclick = () => { currentQuizIndex++; displayCurrentQuiz(); };
    }
        
</script>
</body>
</html>
