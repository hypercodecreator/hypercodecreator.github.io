<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ CBT</title>
    <style>
        /* ê¸°ë³¸ & ë ˆì´ì•„ì›ƒ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* ë²„íŠ¼ */
        .button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 6px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: 600; transition: all 0.2s ease-in-out; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .primary-button:hover { background-color: #0b5ed7; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .light-button:hover { background-color: #e2e6ea; }
        .small-button { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0; }

        /* ìƒë‹¨ ì¸ì¦ ì˜ì—­ */
        #auth-container { display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        #auth-container span { margin-right: auto; font-size: 0.9em; color: #555; }
        #auth-container .button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }

        /* í”¼ë“œë°± ë°” */
        #feedback-bar { padding: 12px; margin-bottom: 15px; border-radius: 5px; text-align: center; font-weight: bold; }
        #feedback-bar.success { background-color: #d1e7dd; color: #0f5132; }
        #feedback-bar.error { background-color: #f8d7da; color: #842029; }

        /* í¼ ê·¸ë£¹ & ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ í†µì¼ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; font-family: inherit; }
        .dynamic-field-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .dynamic-field-group .field-label { font-size: 0.9em; color: #6c757d; min-width: 25px; }
        .dynamic-field-group input { flex-grow: 1; font-size: 1em !important; }
        .remove-btn { padding: 5px 10px; font-size: 0.8em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* ëª©í‘œ ì„¤ì • UI */
        #goal-view { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        #goal-view h4 { margin-top: 0; margin-bottom: 15px; }
        .goal-input-group { display: flex; align-items: center; gap: 8px; }
        #goal-view label { font-size: 0.9em; }
        #goal-view input[type="number"] { width: 80px; text-align: center; }
        #goal-view .button { width: auto; margin: 0; }
        #goal-status { font-weight: 600; font-size: 1.1em; }
        #goal-status .progress { color: #0d6efd; }
        #goal-status .goal { color: #6c757d; }

        /* ê³¼ëª© ì•„ì´í…œ */
        .subject-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; }
        .subject-name-container { display: flex; align-items: center; margin-bottom: 12px; }
        .subject-item-name { font-weight: 600; font-size: 1.1rem; }
        .subject-item-buttons { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .subject-item-buttons .button { width: auto; margin: 0; padding: 8px 12px; font-size: 0.9em; }
        .subject-goal-controls input[type="number"] { width: 60px; padding: 5px; text-align: center; }
        .subject-goal-controls .button { width: auto; padding: 5px 10px; margin: 0; }
        .edit-btn, .delete-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 1.1rem; color: #6c757d; margin-left: 5px; }
        .edit-btn:hover, .delete-btn:hover { color: #212529; }
        .subject-name-input { font-size: 1.1rem; font-weight: 600; border: 1px solid #0d6efd; padding: 5px; border-radius: 4px; flex-grow: 1; }
        .subject-goal-controls label, .goal-input-group label { white-space: nowrap; font-size: 0.9em; }
        .subject-goal-controls .button, .goal-input-group .button { width: auto; padding: 5px 10px; margin: 0; }
                
        /* ë¬¸ì œ ê´€ë¦¬ í™”ë©´ */
        #add-problem-container { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .question-item { border-bottom: 1px solid #eee; }
        .question-item:last-child { border-bottom: none; }
        .question-item-display { display: flex; align-items: center; padding: 15px; cursor: pointer; }
        .question-item-display:hover { background-color: #f8f9fa; }
        .question-item-text { flex-grow: 1; margin-right: 15px; }
        .question-item-actions { display: flex; gap: 10px; }
        .simple-edit-form { padding: 15px; background-color: #f0f2f5; }
        .simple-edit-form input { font-size: 1em; }

        /* í€´ì¦ˆ í™”ë©´ */
        .option { margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: bold; }
        .feedback { padding: 10px; margin-top: 15px; border-radius: 5px; }
        .feedback.correct { background-color: #d1e7dd; color: #0f5132; }
        .feedback.incorrect { background-color: #f8d7da; color: #842029; }
        .final-result { text-align: center; padding: 20px; }
        .final-result h2 { font-size: 2em; margin-bottom: 10px; }
        .final-result p { font-size: 1.2em; }
        
        /* ì§€ì‹ íŠ¸ë¦¬ */
        #tree-container { padding: 10px; }
        #tree-container ul { padding-left: 1em; list-style: none; position: relative; }
        #tree-container ul ul { margin-left: .5em; }
        #tree-container li { position: relative; padding: 4px 0 4px 1.2em; line-height: 1.5; }
        #tree-container li::before { content: ""; position: absolute; top: 0; left: 0; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; width: 1em; height: 1em; }
        #tree-container li::after { content: ""; position: absolute; top: 1em; left: 0; bottom: 0; border-left: 1px solid #ccc; }
        #tree-container li:last-child::after { display: none; }
        #tree-container li.expandable { cursor: pointer; }
        #tree-container li.expandable > .node-text { font-weight: bold; }
        #tree-container li.expandable > .node-text:hover { color: #0d6efd; }
        #tree-container li.expandable::before { content: "[+] "; font-family: monospace; border: none; width: auto; height: auto; top: 2px; }
        #tree-container li.expandable.expanded::before { content: "[-] "; }
        #tree-container li.expandable.expanded > ul { display: block; }
        #tree-container li > ul { display: none; }
        #tree-container .concept-badges-container { display: block; padding-left: 1.2em; margin-top: 4px; }
        .concept-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.75em;
            border-radius: 10px;
            margin-right: 5px;
            margin-bottom: 4px;
        }
        .badge-keyword { background-color: #e0eaff; color: #4361ee; }
        .badge-tag { background-color: #dcfce7; color: #16a34a; }
        .badge-metatag { background-color: #fefce8; color: #b45309; }

        /* âœ¨ ì ì§„ì  í•™ìŠµ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ âœ¨ */
        .goal-setup {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .goal-setup input {
            width: 80px;
            text-align: center;
        }
        .goal-setup .button {
            width: auto;
            margin-top: 0;
            padding: 10px 15px;
        }
        #goal-status .progress {
            color: #0d6efd;
        }
        #goal-status .goal {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="feedback-bar" class="hidden"></div>
        
        <div id="auth-container">
            <span id="user-email"></span>
            <div id="logged-out-view">
                <button class="button light-button" onclick="showView('login-view')">ë¡œê·¸ì¸</button>
                <button class="button primary-button" onclick="showView('signup-view')">íšŒì›ê°€ì…</button>
            </div>
            <div id="logged-in-view" class="hidden">
                <button class="button secondary-button" onclick="logOut()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div id="subject-view">
            <h2>ê³¼ëª© ì„ íƒ</h2>
            <div id="goal-view">
                <h4>ğŸ¯ ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œ</h4>
                <div id="goal-setup-view">
                    <div class="goal-input-group">
                        <input type="number" id="goal-input" min="1" value="10">
                        <button class="button primary-button" onclick="setDailyGoal()">ëª©í‘œ ì„¤ì •</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #555;">
                        <input type="checkbox" id="reset-progress-checkbox" checked>
                        <label for="reset-progress-checkbox">ì§„í–‰ë„ í•¨ê»˜ ì´ˆê¸°í™”</label>
                    </div>
                </div>
                <div id="goal-status-view" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                    <span id="goal-status" style="flex-grow: 1;"></span>
                    <button class="button light-button small-button" onclick="resetDailyProgress()">ì§„í–‰ë„ 0ìœ¼ë¡œ</button>
                    <button class="button light-button small-button" onclick="resetDailyGoal()">ëª©í‘œ ì¬ì„¤ì •</button>
                </div>
            </div>
            <div id="subject-list"></div>
            </div>

        <div id="management-view" class="hidden">
            <h2 id="management-header"></h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="button primary-button" style="margin-top:0;" onclick="showFullEditView()">+ ìƒˆ ë¬¸ì œ ì¶”ê°€</button>
                 <button class="button light-button" style="margin-top:0;" onclick="showTreeView()">ğŸŒ³ ì§€ì‹ íŠ¸ë¦¬ ë³´ê¸°</button>
                 <button class="button light-button" style="margin-top:0;" onclick="showBulkAddView()">ğŸ“š ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</button>
            </div>
            <div id="question-list-container" style="border: 1px solid #eee; border-radius: 8px;"></div>
            <button class="button light-button" onclick="showView('subject-view')" style="margin-top: 20px;">â†©ï¸ ê³¼ëª© ì„ íƒìœ¼ë¡œ</button>
        </div>
        
        <div id="quiz-view" class="hidden"> 
            <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;"></div>
            <div id="quiz-body"></div>
            <div id="immediate-feedback" style="margin-top: 15px;"></div>
            <hr style="margin:20px 0;">
            <button class="button light-button" onclick="exitQuiz()">â†©ï¸ í€´ì¦ˆ ì¤‘ë‹¨</button>
            </div>
        
        <div id="login-view" class="hidden">
            <h2>ë¡œê·¸ì¸</h2>
            <div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email"></div>
            <div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password"></div>
            <button class="button primary-button" onclick="logIn()">ë¡œê·¸ì¸</button>
            <button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button>
        </div>

        <div id="signup-view" class="hidden">
            <h2>íšŒì›ê°€ì…</h2>
            <div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email"></div>
            <div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signup-password"></div>
            <button class="button primary-button" onclick="signUp()">íšŒì›ê°€ì…</button>
            <button class="button light-button" onclick="showView('subject-view')">ì·¨ì†Œ</button>
        </div>
        
        <div id="tree-view" class="hidden">
            <h2>ğŸŒ³ ì§€ì‹ íŠ¸ë¦¬</h2>
            <div id="tree-container">ì§€ì‹ íŠ¸ë¦¬ ë¡œë”© ì¤‘...</div>
            <hr>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">â†©ï¸ ë¬¸ì œ ê´€ë¦¬ë¡œ</button>
        </div>
        
        <div id="add-edit-view" class="hidden">
            <h2 id="add-edit-header"></h2>
            <input type="hidden" id="editing-question-id">
            <h4>1. ë¬¸ì œ ì •ë³´</h4>
            <div class="form-group"><textarea id="q-text-full" rows="3" placeholder="ë¬¸ì œ ë‚´ìš©"></textarea></div>
            <div class="form-group"><input type="text" id="q-answer-full" placeholder="ì •ë‹µ"></div>
            <div class="form-group"><textarea id="q-explanation-full" rows="3" placeholder="í•´ì„¤ (ì„ íƒ)"></textarea></div>
            <hr>
            <h4>2. ê°ê´€ì‹ ë³´ê¸° (ì„ íƒ)</h4>
            <div id="q-options-container"></div>
            <button class="button light-button small-button" onclick="addDynamicField('option')">+ ë³´ê¸° ì¶”ê°€</button>
            <hr>
            <h4>3. ê°œë… ë¶„ì„ (ì„ íƒ)</h4>
            <div class="form-group"><label>í‚¤ì›Œë“œ</label><div id="q-keywords-container"></div><button class="button light-button small-button" onclick="addDynamicField('keyword')">+ í‚¤ì›Œë“œ ì¶”ê°€</button></div>
            <div class="form-group"><label>íƒœê·¸</label><div id="q-tags-container"></div><button class="button light-button small-button" onclick="addDynamicField('tag')">+ íƒœê·¸ ì¶”ê°€</button></div>
            <hr>
            <div style="display:flex; gap: 10px;">
                <button class="button light-button" onclick="showManagementView({ refetch: false })">ì·¨ì†Œ</button>
                <button id="save-full-btn" class="button primary-button">ì €ì¥</button>
            </div>
        </div>

        <div id="bulk-add-view" class="hidden">
            <h2>ğŸ“š ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€</h2>
            <div class="form-group"><textarea id="bulk-text" rows="10" placeholder="ë¬¸ì œ: ..."></textarea></div>
            <button class="button primary-button" onclick="addBulkQuestions()">DBì— ì €ì¥</button>
            <button class="button light-button" onclick="showManagementView({ refetch: false })">â† ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
        </div>
    </div> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
    
    const firebaseConfig = {
      apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
      authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
      projectId: "my-cbt-app-2cdb9",
      storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
      messagingSenderId: "1091430877229",
      appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
    };
        
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ì „ì—­ ë³€ìˆ˜
    let currentSubjectId, currentSubjectData, allQuestionsForSubject = [];
    let dailyGoal = 0, dailyProgress = 0;
    let subjectGoals = {}, subjectProgress = {};
    const views = ['subject-view', 'quiz-view', 'management-view', 'login-view', 'signup-view', 'add-edit-view', 'tree-view', 'bulk-add-view']; // 'tree-view', 'bulk-add-view' ì¶”ê°€
    
    let quizQuestions = [], selectedOption, currentQuizIndex = 0, quizScore = 0, quizProblemsAttempted = 0;


    // ==================================
    // ## í•µì‹¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ##
    // ==================================
    function showView(viewId) { 
        views.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('hidden', id !== viewId);
            }
        }); 
    }
    
    function showFeedback(message, type = 'error') {
        const feedbackBar = document.getElementById('feedback-bar');
        if (!feedbackBar) return;
        feedbackBar.textContent = message;
        feedbackBar.className = type;
        feedbackBar.classList.remove('hidden');
        setTimeout(() => feedbackBar.classList.add('hidden'), 3000);
    }
    
    function getTodayDateString() { 
        const d = new Date(); 
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; 
    }

    // ==================================
    // ## ì¸ì¦ ë° ì•± ì‹œì‘ í•¨ìˆ˜ ##
    // ==================================
    auth.onAuthStateChanged(async (user) => {
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const userEmailSpan = document.getElementById('user-email');
        
        if (user) {
            loggedInView.classList.remove('hidden'); 
            loggedOutView.classList.add('hidden');
            userEmailSpan.textContent = `${user.email}ë‹˜`;
            await loadDailyLog();
            await loadSubjects();
            showView('subject-view'); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ê³¼ëª© ë·° í‘œì‹œ
        } else {
            loggedInView.classList.add('hidden'); 
            loggedOutView.classList.remove('hidden');
            userEmailSpan.textContent = '';
            
            // subject-listë§Œ ì´ˆê¸°í™”í•˜ê³  goal-view ë“±ì€ ë‚¨ê²¨ë‘ 
            const listDiv = document.getElementById('subject-list');
            if(listDiv) {
                listDiv.innerHTML = `<p style="text-align:center; padding: 20px; color: #888;">ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>`;
            }
            // ë¡œê·¸ì¸ í™”ë©´ì´ ê¸°ë³¸ì´ ë˜ë„ë¡ ì„¤ì •
            showView('login-view'); 
        }
    });
    
    async function signUp() { 
        try { 
            await auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value); 
            // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ showView ë¶ˆí•„ìš”
        } catch (e) { 
            showFeedback(e.message); 
        } 
    }
    async function logIn() { 
        try { 
            await auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value); 
            // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ showView ë¶ˆí•„ìš”
        } catch (e) { 
            showFeedback(e.message); 
        } 
    }
    function logOut() { 
        auth.signOut(); 
        // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        currentSubjectId = null;
        currentSubjectData = null;
        allQuestionsForSubject = [];
        dailyGoal = 0; 
        dailyProgress = 0;
        subjectGoals = {}; 
        subjectProgress = {};
    }

    // ==================================
    // ## DB ì €ì¥/ë¡œë“œ (í•™ìŠµ ëª©í‘œ) ##
    // ==================================
    async function saveDailyLog() {
        const user = auth.currentUser; if (!user) return;
        const logRef = db.collection('users').doc(user.uid).collection('daily_logs').doc(getTodayDateString());
        const logData = { 
            totalGoal: dailyGoal, 
            totalProgress: dailyProgress, 
            subjectGoals: subjectGoals, 
            subjectProgress: subjectProgress, 
            lastUpdated: new Date() 
        };
        try { await logRef.set(logData, { merge: true }); } catch (error) { console.error("í•™ìŠµ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error); }
    }
        
    async function loadDailyLog() {
        const user = auth.currentUser; if (!user) return;
        const logRef = db.collection('users').doc(user.uid).collection('daily_logs').doc(getTodayDateString());
        try {
            const doc = await logRef.get();
            if (doc.exists) {
                const data = doc.data();
                dailyGoal = data.totalGoal || 0; 
                dailyProgress = data.totalProgress || 0;
                subjectGoals = data.subjectGoals || {}; 
                subjectProgress = data.subjectProgress || {};
                
                if (dailyGoal > 0) {
                    document.getElementById('goal-setup-view').classList.add('hidden');
                    document.getElementById('goal-status-view').classList.remove('hidden');
                    updateGoalStatusDisplay();
                }
            }
        } catch (error) { console.error("í•™ìŠµ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", error); }
    }

    // ==================================
    // ## í•™ìŠµ ëª©í‘œ ê´€ë¦¬ í•¨ìˆ˜ ##
    // ==================================
    function setDailyGoal() {
        const goalInput = document.getElementById('goal-input');
        const goalValue = parseInt(goalInput.value, 10);
        if (isNaN(goalValue) || goalValue <= 0) { showFeedback('1 ì´ìƒì˜ ìˆ«ìë¥¼ ëª©í‘œë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
        const shouldResetProgress = document.getElementById('reset-progress-checkbox').checked;
        
        dailyGoal = goalValue;
        if (shouldResetProgress) { dailyProgress = 0; }
        
        document.getElementById('goal-setup-view').classList.add('hidden');
        document.getElementById('goal-status-view').classList.remove('hidden');
        document.getElementById('reset-progress-checkbox').checked = true;
        
        updateGoalStatusDisplay();
        saveDailyLog();
    }

    function resetDailyGoal() { 
        dailyGoal = 0; 
        document.getElementById('goal-status-view').classList.add('hidden'); 
        document.getElementById('goal-setup-view').classList.remove('hidden'); 
        saveDailyLog(); 
    }
    
    function resetDailyProgress() {
        dailyProgress = 0;
        updateGoalStatusDisplay();
        saveDailyLog();
        showFeedback('ì§„í–‰ë„ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    function setSubjectGoal(subjectId) {
        const goalInput = document.getElementById(`goal-input-${subjectId}`);
        const goalValue = parseInt(goalInput.value, 10);
        if (isNaN(goalValue) || goalValue <= 0) { showFeedback('1 ì´ìƒì˜ ìˆ«ìë¥¼ ëª©í‘œë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
        const shouldResetProgress = document.getElementById(`reset-subject-progress-checkbox-${subjectId}`).checked;
        
        subjectGoals[subjectId] = goalValue;
        if (shouldResetProgress) { subjectProgress[subjectId] = 0; }
        
        document.getElementById(`reset-subject-progress-checkbox-${subjectId}`).checked = true;
        updateSubjectStatusDisplay(subjectId);
        saveDailyLog();
    }

    function updateGoalStatusDisplay() { 
        const el = document.getElementById('goal-status');
        if (el) {
            el.innerHTML = `ì˜¤ëŠ˜ì˜ ëª©í‘œ: <span class="progress">${dailyProgress}</span> / <span class="goal">${dailyGoal}</span> ë¬¸ì œ`;
        } 
    }
    
    function updateSubjectStatusDisplay(subjectId) {
        const statusSpan = document.getElementById(`subject-goal-status-${subjectId}`);
        if(statusSpan) {
            statusSpan.textContent = `(ë‹¬ì„±: ${subjectProgress[subjectId] || 0} / ${subjectGoals[subjectId] || 'ë¯¸ì„¤ì •'})`;
        }
    }
        
    function updateDailyProgress(attemptedCount) {
        if (dailyGoal <= 0) return;
        const progressBefore = dailyProgress;
        dailyProgress += attemptedCount;
        updateGoalStatusDisplay();
        if ((dailyProgress >= dailyGoal) && (progressBefore < dailyGoal)) { 
            showFeedback('ğŸ‰ ì˜¤ëŠ˜ì˜ í†µí•© í•™ìŠµ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ëŒ€ë‹¨í•´ìš”!', 'success'); 
        }
    }

    // ==================================
    // ## ê³¼ëª© ê´€ë¦¬ í•¨ìˆ˜ ##
    // ==================================

    /** ê³¼ëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°ë¨) */
    async function loadSubjects() {
        const listDiv = document.getElementById('subject-list');
        listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ê³¼ëª© ë¡œë”© ì¤‘...</div>';
        try {
            const snapshot = await db.collection('subjects').orderBy('name').get();
            listDiv.innerHTML = '';
            for (const doc of snapshot.docs) {
                const subject = doc.data();
                const subjectId = doc.id;
                const subjectName = subject.name;
                const item = document.createElement('div');
                item.className = 'subject-item';
                item.innerHTML = `
                    <div style="flex-grow: 1;">
                        <div class="subject-name-container" id="subject-name-container-${subjectId}">
                            <span class="subject-item-name">${subjectName} (${subject.questionCount || 0}ë¬¸ì œ)</span>
                        </div>
                        <div class="subject-goal-controls" style="margin-top: 10px;">
                            <div class="goal-input-group">
                                <label for="goal-input-${subjectId}">ê³¼ëª© ëª©í‘œ:</label>
                                <input type="number" id="goal-input-${subjectId}" min="1" value="10">
                                <button class="button light-button small-button" onclick="setSubjectGoal('${subjectId}')">ì„¤ì •</button>
                                <span id="subject-goal-status-${subjectId}"></span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.9em; color: #555;">
                                <input type="checkbox" id="reset-subject-progress-checkbox-${subjectId}" checked>
                                <label for="reset-subject-progress-checkbox-${subjectId}">ì§„í–‰ë„ í•¨ê»˜ ì´ˆê¸°í™”</label>
                            </div>
                        </div>
                    </div>
                    <div class="subject-item-buttons">
                        <button class="button primary-button" onclick="startQuiz('${subjectId}')">í€´ì¦ˆ ì‹œì‘</button>
                        <button class="button secondary-button" onclick="manageSubject('${subjectId}')">ë¬¸ì œ ê´€ë¦¬</button>
                        <button class="edit-btn" onclick="startEditSubject('${subjectId}', '${subjectName}')">âœï¸</button>
                        <button id="delete-btn-${subjectId}" class="delete-btn" onclick="deleteSubject('${subjectId}', '${subjectName}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                listDiv.appendChild(item);
                updateSubjectStatusDisplay(subjectId);
            }
            listDiv.insertAdjacentHTML('beforeend', `
                <div id="add-subject-form" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div class="form-group"> <label for="new-subject-name" style="font-weight: bold;">ìƒˆ ê³¼ëª© ì´ë¦„</label> <input type="text" id="new-subject-name" placeholder="ì˜ˆ: ì •ë³´ì²˜ë¦¬ê¸°ì‚¬ í•„ê¸°"> </div>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button class="button light-button" style="flex: 1;" onclick="hideAddSubjectForm()">ì·¨ì†Œ</button>
                        <button class="button primary-button" style="flex: 1;" onclick="addSubject()">ì €ì¥</button>
                    </div>
                </div>
                <button id="add-subject-button" class="button primary-button" onclick="showAddSubjectForm()">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>
            `);
        } catch (error) { console.error("ê³¼ëª© ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    /** ìƒˆë¡œìš´ ê³¼ëª©ì„ Firestoreì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ */
    async function addSubject() {
        const input = document.getElementById('new-subject-name');
        const subjectName = input.value.trim();
        if (!subjectName) { showFeedback('ê³¼ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        try {
            await db.collection('subjects').add({ name: subjectName, questionCount: 0 });
            showFeedback(`'${subjectName}' ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            hideAddSubjectForm();
            await loadSubjects();
        } catch (error) { console.error("ê³¼ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:", error); showFeedback('ê³¼ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    /** ê³¼ëª© ì¶”ê°€ ì…ë ¥ ì°½ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ */
    function showAddSubjectForm() {
        document.getElementById('add-subject-form').classList.remove('hidden');
        document.getElementById('add-subject-button').classList.add('hidden');
    }
    function hideAddSubjectForm() {
        document.getElementById('add-subject-form').classList.add('hidden');
        document.getElementById('new-subject-name').value = '';
        document.getElementById('add-subject-button').classList.remove('hidden');
    }

    /** ê³¼ëª© ì´ë¦„ ìˆ˜ì •ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ */
    function startEditSubject(subjectId, currentName) {
        const nameContainer = document.getElementById(`subject-name-container-${subjectId}`);
        const buttonsContainer = nameContainer.closest('.subject-item').querySelector('.subject-item-buttons');
        // ê¸°ì¡´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        buttonsContainer.classList.add('hidden');
        // ì¸ë¼ì¸ í¼ ìƒì„±
        nameContainer.innerHTML = `
            <input type="text" id="edit-subject-input-${subjectId}" class="subject-name-input" value="${currentName}">
            <button class="button light-button small-button" style="margin-left: 5px;" onclick="cancelEdit()">ì·¨ì†Œ</button>
            <button class="button primary-button small-button" style="margin-left: 5px;" onclick="saveSubjectUpdate('${subjectId}')">ì €ì¥</button>
        `;
        document.getElementById(`edit-subject-input-${subjectId}`).focus();
    }
    
    /** ê³¼ëª© ì´ë¦„ ìˆ˜ì • ë‚´ìš©ì„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ */
    async function saveSubjectUpdate(subjectId) {
        const input = document.getElementById(`edit-subject-input-${subjectId}`);
        const newName = input.value.trim();
        if (!newName) { showFeedback("ê³¼ëª© ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
        try {
            await db.collection('subjects').doc(subjectId).update({ name: newName });
            showFeedback("ê³¼ëª© ì´ë¦„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        } catch (error) { console.error("ê³¼ëª© ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:", error); showFeedback("ê³¼ëª© ì´ë¦„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        await loadSubjects(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ UI ë³µì›
    }

    /** ê³¼ëª© ì´ë¦„ ìˆ˜ì •ì„ ì·¨ì†Œí•˜ê³  ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜ */
    function cancelEdit() { 
        loadSubjects(); // ê°„ë‹¨í•˜ê²Œ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìˆ˜ì • ìƒíƒœë¥¼ ì·¨ì†Œ
    }
    
    /** ê³¼ëª©ê³¼ ê·¸ í•˜ìœ„ ë¬¸ì œë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜ (2ë‹¨ê³„ í™•ì¸, ì¤‘ë³µ ì œê±°ë¨) */
    async function deleteSubject(subjectId, subjectName) {
        const deleteBtn = document.getElementById(`delete-btn-${subjectId}`);
        if (!deleteBtn) return;

        if (deleteBtn.innerHTML !== 'ğŸ—‘ï¸ ì‚­ì œ í™•ì¸') {
            const originalHTML = deleteBtn.innerHTML;
            deleteBtn.innerHTML = 'ğŸ—‘ï¸ ì‚­ì œ í™•ì¸';
            deleteBtn.style.color = '#dc3545';
            setTimeout(() => {
                const currentBtn = document.getElementById(`delete-btn-${subjectId}`);
                if (currentBtn && currentBtn.innerHTML === 'ğŸ—‘ï¸ ì‚­ì œ í™•ì¸') { // ë‹¤ë¥¸ ì‘ì—…ìœ¼ë¡œ ì¸í•´ ë²„íŠ¼ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ë˜ëŒë¦¼
                    currentBtn.innerHTML = originalHTML; 
                    currentBtn.style.color = '#6c757d'; 
                }
            }, 4000);
            return;
        }
        
        showFeedback(`'${subjectName}' ê³¼ëª©ì„ ì‚­ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤...`);
        try {
            const questionsSnapshot = await db.collection('subjects').doc(subjectId).collection('questions').get();
            const batch = db.batch();
            questionsSnapshot.forEach(doc => batch.delete(doc.ref));
            
            const subjectRef = db.collection('subjects').doc(subjectId);
            batch.delete(subjectRef);
            
            await batch.commit();
            showFeedback(`'${subjectName}' ê³¼ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            await loadSubjects();
        } catch (error) {
            console.error("ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
            showFeedback('ê³¼ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ==================================
    // ## ë¬¸ì œ ê´€ë¦¬ í•¨ìˆ˜ (CRUD í†µí•©) ##
    // ==================================

    /** 'ë¬¸ì œ ê´€ë¦¬' ë²„íŠ¼ í´ë¦­ ì‹œ (ì¤‘ë³µ ì œê±°ë¨) */
    async function manageSubject(id) {
        const doc = await db.collection('subjects').doc(id).get();
        if (!doc.exists) {
            showFeedback("ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        currentSubjectId = id;
        currentSubjectData = doc.data();
        await showManagementView({ refetch: true }); // í•­ìƒ ìƒˆë¡œê³ ì¹¨
    }

    /** ë¬¸ì œ ê´€ë¦¬ ë·° í‘œì‹œ (ìˆ˜ì •ë¨) */
    async function showManagementView(options = {}) {
        showView('management-view');
        document.getElementById('management-header').textContent = `[${currentSubjectData.name}] ë¬¸ì œ ê´€ë¦¬`;
        const container = document.getElementById('question-list-container');
        
        // refetch ì˜µì…˜ì´ ìˆê±°ë‚˜, ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ DBì—ì„œ ìƒˆë¡œ ê°€ì ¸ì˜´
        if (options.refetch || allQuestionsForSubject.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ë¬¸ì œ ëª©ë¡ ë¡œë”© ì¤‘...</div>';
            try {
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').orderBy('text', 'asc').get();
                allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                 console.error("ë¬¸ì œ ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
                 showFeedback("ë¬¸ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                 allQuestionsForSubject = []; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹„ì›Œì¤Œ
            }
        }
        
        container.innerHTML = '';
        if (allQuestionsForSubject.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            allQuestionsForSubject.forEach(q => {
                const item = document.createElement('div');
                item.className = 'question-item';
                item.id = `question-item-${q.id}`;
                // [ìˆ˜ì •ë¨] ê°„ë‹¨ ìˆ˜ì •ì„ ì—†ì• ê³ , í–‰ ì „ì²´ í´ë¦­ ì‹œ 'ì „ì²´ ìˆ˜ì •'ìœ¼ë¡œ ì´ë™
                item.innerHTML = `
                    <div class="question-item-display" onclick="showFullEditView('${q.id}')">
                        <div class="question-item-text">${q.text}</div>
                        <div class="question-item-actions">
                            <button id="delete-problem-btn-${q.id}" class="button light-button small-button" onclick="event.stopPropagation(); deleteProblem('${q.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        // hideProblemAddForm(); // êµ¬ë²„ì „ í•¨ìˆ˜ ì œê±°
    }

    /** 'ì „ì²´ ì¶”ê°€/ìˆ˜ì •' í¼ ë³´ì—¬ì£¼ê¸° (ê¸°ì¡´ ë¡œì§ í™œìš©) */
    function showFullEditView(questionId = null) {
        showView('add-edit-view');
        const isEditing = !!questionId;
        const question = isEditing ? allQuestionsForSubject.find(q => q.id === questionId) : {};
        
        document.getElementById('add-edit-header').textContent = isEditing ? 'ë¬¸ì œ ì „ì²´ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ì¶”ê°€';
        document.getElementById('editing-question-id').value = questionId || '';
        
        document.getElementById('q-text-full').value = question.text || '';
        document.getElementById('q-answer-full').value = question.answer || '';
        document.getElementById('q-explanation-full').value = question.explanation || '';
        
        ['keyword', 'tag', 'option'].forEach(type => {
            const container = document.getElementById(`q-${type}s-container`);
            container.innerHTML = '';
            const dataArray = question[type + 's'] || [];
            if (dataArray.length > 0) {
                dataArray.forEach(val => addDynamicField(type, val));
            } else {
                 // ë¹ˆ ê°’ì´ë©´ 1ê°œë§Œ ì¶”ê°€ (ì…ë ¥ í¸ì˜ì„±)
                 // addDynamicField(type, ''); // ì£¼ì„ ì²˜ë¦¬: ì‚¬ìš©ìê°€ ì›í•  ë•Œë§Œ ì¶”ê°€í•˜ë„ë¡
            }
        });
    
        document.getElementById('save-full-btn').onclick = () => saveFullUpdate(questionId);
    }

    /** ë™ì  í•„ë“œ(ë³´ê¸°, í‚¤ì›Œë“œ, íƒœê·¸)ì˜ ë¼ë²¨ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ */
    function updateFieldLabels(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('.dynamic-field-group').forEach((group, index) => {
            group.querySelector('.field-label').textContent = `${index + 1}.`;
        });
    }

    /** 'ì „ì²´ ì¶”ê°€/ìˆ˜ì •' í¼ - ë™ì  í•„ë“œ ì¶”ê°€ */
    function addDynamicField(type, value = '') {
        const containerId = `q-${type}s-container`;
        const container = document.getElementById(containerId);
        if(!container) return;

        const count = container.children.length + 1;
        const newField = document.createElement('div');
        newField.className = 'dynamic-field-group';
        
        let placeholder = type;
        if (type === 'option') placeholder = 'ë³´ê¸°';

        newField.innerHTML = `
            <span class="field-label">${count}.</span>
            <input type="text" class="q-${type}" value="${value}" placeholder="${placeholder} ë‚´ìš©">
            <button class="remove-btn">X</button>
        `;
        
        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        newField.querySelector('.remove-btn').onclick = (e) => {
            e.preventDefault();
            e.currentTarget.parentElement.remove();
            updateFieldLabels(containerId); // ì‚­ì œ í›„ ë¼ë²¨ ë²ˆí˜¸ ì¬ì •ë ¬
        };

        container.appendChild(newField);
    }

    /** 'ì „ì²´ ì¶”ê°€/ìˆ˜ì •' í¼ - ì €ì¥ (ê¸°ì¡´ ë¡œì§) */
    async function saveFullUpdate(questionId) {
        const data = {
            text: document.getElementById('q-text-full').value.trim(),
            answer: document.getElementById('q-answer-full').value.trim(),
            explanation: document.getElementById('q-explanation-full').value.trim(),
            keywords: Array.from(document.querySelectorAll('.q-keyword')).map(i => i.value.trim()).filter(Boolean),
            tags: Array.from(document.querySelectorAll('.q-tag')).map(i => i.value.trim()).filter(Boolean),
            options: Array.from(document.querySelectorAll('.q-option')).map(i => i.value.trim()).filter(Boolean)
            // partName: (ê¸°íšì„œì— ìˆìœ¼ë‚˜ í¼ì— ì—†ìŒ. í•„ìš”ì‹œ ì¶”ê°€)
        };
        if (!data.text || !data.answer) { showFeedback("ë¬¸ì œ ë‚´ìš©ê³¼ ì •ë‹µì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
    
        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            if (questionId) {
                // ìˆ˜ì •
                await subjectRef.collection('questions').doc(questionId).update(data);
                showFeedback("ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } else {
                // ì¶”ê°€
                await subjectRef.collection('questions').add(data);
                // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê³¼ëª©ì˜ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸
                await db.runTransaction(async t => {
                    const doc = await t.get(subjectRef);
                    t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + 1 });
                });
                showFeedback("ìƒˆ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            }
            // ì „ì—­ ë³€ìˆ˜ 'allQuestionsForSubject'ë¥¼ ë¹„ì›Œ ë‹¤ìŒë²ˆì— ìƒˆë¡œê³ ì¹¨í•˜ë„ë¡ í•¨
            allQuestionsForSubject = []; 
            await showManagementView({ refetch: true }); // ê´€ë¦¬ ë·°ë¡œ ë³µê·€ ë° ìƒˆë¡œê³ ì¹¨
        } catch (error) { console.error(error); showFeedback("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
    
    /** ë¬¸ì œ ì‚­ì œ (2ë‹¨ê³„ í™•ì¸) */
    async function deleteProblem(questionId) {
        const deleteBtn = document.getElementById(`delete-problem-btn-${questionId}`);
        if (!deleteBtn) return;

        if (deleteBtn.textContent !== 'ì‚­ì œ í™•ì¸') {
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = 'ì‚­ì œ í™•ì¸';
            deleteBtn.style.backgroundColor = '#f8d7da'; 
            deleteBtn.style.color = '#842029';
            setTimeout(() => {
                const currentBtn = document.getElementById(`delete-problem-btn-${questionId}`);
                if (currentBtn && currentBtn.textContent === 'ì‚­ì œ í™•ì¸') { 
                    currentBtn.textContent = originalText; 
                    currentBtn.style.backgroundColor = ''; 
                    currentBtn.style.color = ''; 
                }
            }, 4000);
            return;
        }

        try {
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            await subjectRef.collection('questions').doc(questionId).delete();
            
            // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¸ì œ ìˆ˜ ê°ì†Œ
            await db.runTransaction(async t => {
                const doc = await t.get(subjectRef);
                t.update(subjectRef, { questionCount: (doc.data().questionCount || 1) - 1 });
            });

            showFeedback("ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            // ì „ì—­ ë³€ìˆ˜ì—ì„œ ì¦‰ì‹œ ì œê±°
            allQuestionsForSubject = allQuestionsForSubject.filter(q => q.id !== questionId);
            await showManagementView({ refetch: false }); // DB ë‹¤ì‹œ ì½ì§€ ì•Šê³  í™”ë©´ë§Œ ê°±ì‹ 
        } catch(error) { 
            console.error(error); 
            showFeedback("ë¬¸ì œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); 
        }
    }
    
    // ==================================
    // ## í€´ì¦ˆ ì‹¤í–‰ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°ë¨) ##
    // ==================================
    
    /** í€´ì¦ˆ ì‹œì‘ */
    async function startQuiz(id) {
        // idê°€ ì œê³µë˜ë©´, í•´ë‹¹ ê³¼ëª©ì˜ ëª¨ë“  ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜´
        if (id) {
            const doc = await db.collection('subjects').doc(id).get();
            if (!doc.exists) {
                showFeedback("ê³¼ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            currentSubjectId = id;
            currentSubjectData = doc.data();
            
            try {
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
                quizQuestions = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort(() => 0.5 - Math.random());
            } catch (error) {
                console.error("í€´ì¦ˆ ë¬¸ì œ ë¡œë”© ì¤‘ ì˜¤ë¥˜:", error);
                showFeedback("í€´ì¦ˆ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }
        }
        // else { 
        //    // 'ì·¨ì•½ì  ê³µëµ' ë“±ì—ì„œëŠ” questions ë°°ì—´ì„ ì§ì ‘ ë°›ì•„ì˜¬ ìˆ˜ ìˆìŒ (í˜„ì¬ëŠ” id ê¸°ë°˜ë§Œ ì‚¬ìš© ì¤‘)
        //    // quizQuestions = questions; 
        // }

        if (quizQuestions.length === 0) {
            showFeedback("í’€ ìˆ˜ ìˆëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.");
            return;
        }

        currentQuizIndex = 0;
        quizScore = 0;
        quizProblemsAttempted = 0;
        showView('quiz-view');
        displayCurrentQuiz();
    }
    
    /** í€´ì¦ˆ ì¢…ë£Œ ë° ë³µê·€ */
    async function exitQuiz() {
        const attempted = quizProblemsAttempted;
        if (attempted > 0) {
            updateDailyProgress(attempted); // ì „ì²´ ì¼ì¼ ëª©í‘œ ì—…ë°ì´íŠ¸
            if (subjectGoals[currentSubjectId]) { // ê³¼ëª©ë³„ ëª©í‘œ ì—…ë°ì´íŠ¸
                subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
            }
            await saveDailyLog(); // DBì— ë¡œê·¸ ì €ì¥
        }
        await loadSubjects(); // ê³¼ëª© ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë‹¬ì„±ë¥  í‘œì‹œ)
        showView('subject-view');
    }
    
    /** í˜„ì¬ í€´ì¦ˆ ë¬¸ì œ í‘œì‹œ */
    async function displayCurrentQuiz() {
        const quizView = document.getElementById('quiz-view');
        if (!quizView) return;
        
        if (currentQuizIndex >= quizQuestions.length) {
            // í€´ì¦ˆ ì¢…ë£Œ
            quizView.innerHTML = `
                <div class="final-result">
                    <h2>ğŸ‰ í€´ì¦ˆê°€ ëë‚¬ìŠµë‹ˆë‹¤!</h2>
                    <p>ì´ ${quizQuestions.length}ë¬¸ì œ ì¤‘ <strong>${quizScore}ê°œ</strong>ë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤.</p>
                </div>
                <button class="button primary-button" onclick="exitQuiz()">ê³¼ëª© ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            `;
            // í€´ì¦ˆê°€ ëë‚˜ìë§ˆì ê²°ê³¼ ë°˜ì˜
            const attempted = quizProblemsAttempted;
            if (attempted > 0) {
                updateDailyProgress(attempted);
                if (subjectGoals[currentSubjectId]) {
                    subjectProgress[currentSubjectId] = (subjectProgress[currentSubjectId] || 0) + attempted;
                }
                await saveDailyLog();
            }
            return;
        }
        
        const data = quizQuestions[currentQuizIndex];
        let optionsHTML = (data.options && data.options.length > 0) 
            ? data.options.map(opt => `<div class="option">${opt}</div>`).join('')
            : '<p><em>ê°ê´€ì‹ ë³´ê¸°ê°€ ì—†ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. (ì£¼ê´€ì‹/ë‹¨ë‹µí˜•)</em></p>'; // ë³´ê¸°ê°€ ì—†ì„ ê²½ìš°
            
        quizView.innerHTML = `
            <div id="quiz-header" style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;">${currentQuizIndex + 1} / ${quizQuestions.length}</div>
            <div id="quiz-body">
                <h4>${data.text}</h4>
                <div>${optionsHTML}</div>
            </div>
            <div id="immediate-feedback" style="margin-top: 15px;">
                <button id="submit-btn" class="button primary-button">ì •ë‹µ í™•ì¸</button>
            </div>
            <hr style="margin:20px 0;">
            <button class="button light-button" onclick="exitQuiz()">â†©ï¸ í€´ì¦ˆ ì¤‘ë‹¨</button>
        `;

        quizView.querySelectorAll('.option').forEach(li => {
            li.onclick = (e) => {
                const selected = quizView.querySelector('.option.selected');
                if (selected) selected.classList.remove('selected');
                e.currentTarget.classList.add('selected');
                selectedOption = e.currentTarget.textContent;
            }
        });
        
        quizView.querySelector('#submit-btn').onclick = submitAnswer;
    }
    
    /** ì •ë‹µ ì œì¶œ */
    function submitAnswer() {
        const selectedOptElem = document.querySelector('.option.selected');
        // ë³´ê¸°ê°€ ì—†ëŠ” ë¬¸ì œ(ì£¼ê´€ì‹ ë“±)ëŠ” ì´ ë¡œì§ì„ í†µê³¼í•  ìˆ˜ ì—†ìŒ.
        // í˜„ì¬ ë¡œì§ì€ ê°ê´€ì‹ ì „ìš©
        if (!selectedOptElem) { 
            showFeedback("ë³´ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); 
            return; 
        }
        
        quizProblemsAttempted++;
        const data = quizQuestions[currentQuizIndex];
        const isCorrect = selectedOption === data.answer;
        const feedbackDiv = document.getElementById('immediate-feedback');
        
        let feedbackHTML = '';
        if (isCorrect) {
            quizScore++;
            feedbackHTML = `<div class="feedback correct"><p><strong>ì •ë‹µì…ë‹ˆë‹¤!</strong></p></div>`;
        } else {
            feedbackHTML = `<div class="feedback incorrect"><p><strong>ì˜¤ë‹µì…ë‹ˆë‹¤.</strong> ì •ë‹µ: ${data.answer}</p></div>`;
        }
        if (data.explanation) {
            feedbackHTML += `<p style="margin-top:10px;"><strong>í•´ì„¤:</strong> ${data.explanation}</p>`;
        }
        
        feedbackHTML += `<button id="next-btn" class="button primary-button">ë‹¤ìŒ ë¬¸ì œ â†’</button>`;
        feedbackDiv.innerHTML = feedbackHTML;
        
        // ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ
        document.querySelectorAll('.option').forEach(opt => {
            opt.style.cursor = 'default';
            opt.onclick = null; // í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
            if (opt.textContent === data.answer) {
                opt.style.cssText += 'background-color: #d1e7dd; border-color: #198754;';
            } else if (opt.textContent === selectedOption) {
                opt.style.cssText += 'background-color: #f8d7da; border-color: #dc3545;';
            }
        });
        
        feedbackDiv.querySelector('#next-btn').onclick = () => { 
            currentQuizIndex++; 
            selectedOption = null; // ì„ íƒ ì´ˆê¸°í™”
            displayCurrentQuiz(); 
        };
    }

    // ==================================
    // ## ì§€ì‹ íŠ¸ë¦¬ ë° ê¸°íƒ€ ë·° ##
    // ==================================
    
    /** ì§€ì‹ íŠ¸ë¦¬ ë·° í‘œì‹œ */
    async function showTreeView() {
        showView('tree-view');
        const container = document.getElementById('tree-container');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        // allQuestionsForSubjectê°€ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ
        if (allQuestionsForSubject.length === 0) {
             try {
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
                allQuestionsForSubject = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                 container.innerHTML = '<p>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                 return;
            }
        }

        const parts = {};
        allQuestionsForSubject.forEach(q => {
            const partName = q.partName || 'ë¯¸ì§€ì • íŒŒíŠ¸'; // 'partName'ì´ ë°ì´í„°ì— ìˆì–´ì•¼ í•¨ (í˜„ì¬ í¼ì—ëŠ” ì—†ìŒ)
            if (!parts[partName]) parts[partName] = [];
            parts[partName].push(q);
        });
        
        let treeHTML = '<ul>';
        treeHTML += `<li class="expandable expanded"><span class="node-text">${currentSubjectData.name}</span><ul>`; // ìµœìƒìœ„ ê³¼ëª©ì€ í•­ìƒ í¼ì¹¨
        
        const sortedPartNames = currentSubjectData.partOrder || Object.keys(parts).sort();
        
        sortedPartNames.forEach(partName => {
            if (!parts[partName]) return;
            treeHTML += `<li class="expandable"><span class="node-text">${partName}</span><ul>`;
            parts[partName].forEach(q => {
                let conceptsHTML = '';
                (q.keywords || []).forEach(kw => { conceptsHTML += `<span class="concept-badge badge-keyword">${kw}</span>`; });
                (q.tags || []).forEach(tag => { conceptsHTML += `<span class="concept-badge badge-tag">${tag}</span>`; });
                (q.metatags || []).forEach(mt => { conceptsHTML += `<span class="concept-badge badge-metatag">${mt}</span>`; });
                const conceptsContainer = conceptsHTML ? `<div class="concept-badges-container">${conceptsHTML}</div>` : '';
                
                // [ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ] ì—¬ê¸°ì— 'ìˆ˜ì •/ì‚­ì œ' ë²„íŠ¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì˜ˆ: <span class="node-text" onclick="showFullEditView('${q.id}')">${q.text}</span> <button onclick="deleteProblem('${q.id}')">ğŸ—‘ï¸</button>
                treeHTML += `<li><span class="node-text">${q.fixedId || ''}. ${q.text}</span>${conceptsContainer}</li>`;
            });
            treeHTML += '</ul></li>';
        });
        treeHTML += '</ul></li></ul>';
        container.innerHTML = treeHTML;
    }

    // ì§€ì‹ íŠ¸ë¦¬ í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('DOMContentLoaded', () => {
        const treeContainer = document.getElementById('tree-container');
        if (treeContainer) {
            treeContainer.addEventListener('click', function(e) {
                // node-textë¥¼ í´ë¦­í–ˆì„ ë•Œë§Œ í† ê¸€ë˜ë„ë¡ ìˆ˜ì • (í•˜ìœ„ ë²„íŠ¼ í´ë¦­ ë°©ì§€)
                if (e.target.classList.contains('node-text')) {
                    const targetLi = e.target.closest('.expandable');
                    if (targetLi) {
                        targetLi.classList.toggle('expanded');
                    }
                }
            });
        }
    });

    /** ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€ ë·° í‘œì‹œ */
    function showBulkAddView() { 
        showView('bulk-add-view'); 
        document.getElementById('bulk-text').value = ''; // í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™”
    }

    /** ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€ ë¡œì§ (ë¯¸êµ¬í˜„) */
    async function addBulkQuestions() {
        const text = document.getElementById('bulk-text').value;
        if (!text.trim()) {
            showFeedback("ì¶”ê°€í•  ë¬¸ì œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        // [TODO] í…ìŠ¤íŠ¸ íŒŒì‹± ë¡œì§ êµ¬í˜„ í•„ìš”
        // ì˜ˆ: "ë¬¸ì œ: 1+1ì€?\nì •ë‹µ: 2\ní•´ì„¤: ë§ì…ˆì…ë‹ˆë‹¤.\n---\n"
        showFeedback("ì—¬ëŸ¬ ë¬¸ì œ ì¶”ê°€ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error");

        // (êµ¬í˜„ ì‹œ)
        // 1. text.split('---') ë“±ìœ¼ë¡œ ë¬¸ì œ ë¶„ë¦¬
        // 2. ê° ë¬¸ì œ íŒŒì‹± (ì •ê·œì‹ ë˜ëŠ” "ë¬¸ì œ: ", "ì •ë‹µ: " í‚¤ì›Œë“œ)
        // 3. for loop ëŒë©´ì„œ await subjectRef.collection('questions').add(data);
        // 4. íŠ¸ëœì­ì…˜ìœ¼ë¡œ questionCount ì—…ë°ì´íŠ¸
        // 5. showManagementView({ refetch: true });
    }

</script>
</body>
</html>
