<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 CBT</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #212529; }
        .container { max-width: 700px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .button { width: 100%; padding: 12px; font-size: 1.1em; border-radius: 5px; cursor: pointer; margin-top: 10px; border: 1px solid #dee2e6; font-weight: bold; }
        .primary-button { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .secondary-button { background-color: #6c757d; color: white; border-color: #6c757d; }
        .light-button { background-color: #f8f9fa; color: #212529; }
        .danger-button { background-color: #dc3545; color: white; border-color: #dc3545; }
        #auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        #auth-container button { width: auto; font-size: 0.9em; padding: 8px 12px; margin-left: 10px; margin-top: 0; }
        #auth-container span { font-size: 0.9em; margin-right: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em;}
        #management-actions { display: flex; justify-content: space-between; align-items: center; border: 1px solid #0d6efd; background-color: #e7f1ff; padding: 8px 12px; border-radius: 5px; margin-bottom: 10px; }
        #management-actions .button { margin-top: 0; padding: 6px 10px; font-size: 0.9em; }
        .question-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .quiz-question-header { display: flex; align-items: center; justify-content: space-between; }
        #bookmark-toggle { font-size: 1.5em; cursor: pointer; color: #ffc107; user-select: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <div id="logged-out-view"><button class="button light-button" onclick="showView('login-view')">로그인</button><button class="button primary-button" onclick="showView('signup-view')">회원가입</button></div>
            <div id="logged-in-view" class="hidden"><span id="user-email"></span><button class="button secondary-button" onclick="logOut()">로그아웃</button></div>
        </div>

        <div id="subject-view">
            <h2>과목 선택</h2>
            <button class="button secondary-button hidden" onclick="showBookmarkView()">⭐ 북마크 모아보기</button>
            <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;" class="hidden">
            <div id="subject-list"></div>
        </div>

        <div id="quiz-view" class="hidden">
            <div class="quiz-question-header">
                <h2 id="quiz-header" style="margin: 0;"></h2>
                <span id="bookmark-toggle">☆</span>
            </div>
            <div id="quiz-body"></div>
            <hr style="margin: 20px 0;">
            <button class="button secondary-button" onclick="showManagementView()">📋 문제 관리</button>
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로 돌아가기</button>
        </div>
        
        <div id="bookmark-view" class="hidden">
            <h2>⭐ 북마크 모아보기</h2>
            <div id="bookmark-list-container"></div>
            <button class="button light-button" onclick="showView('subject-view')">↩️ 과목 선택으로 돌아가기</button>
        </div>

        <div id="signup-view" class="hidden"></div>
        <div id="login-view" class="hidden"></div>
        <div id="management-view" class="hidden"></div>
        <div id="move-question-view" class="hidden"></div>
        <div id="add-edit-view" class="hidden"></div>
        <div id="bulk-add-view" class="hidden"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyBl4mNG0HVKLY159dPjJEuYZTp9_ay_guk",
  authDomain: "my-cbt-app-2cdb9.firebaseapp.com",
  projectId: "my-cbt-app-2cdb9",
  storageBucket: "my-cbt-app-2cdb9.firebasestorage.app",
  messagingSenderId: "1091430877229",
  appId: "1:1091430877229:web:1c4fae4ff852df4e1610a4"
};
        
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentSubjectId, currentSubjectData, questions = [], currentQuiz = 0;
        const views = ['subject-view', 'signup-view', 'login-view', 'quiz-view', 'management-view', 'add-edit-view', 'move-question-view', 'bookmark-view'];

        function showView(viewId) { views.forEach(id => document.getElementById(id)?.classList.toggle('hidden', id !== viewId)); }
        
        auth.onAuthStateChanged(user => {
            const loggedInElements = [document.getElementById('logged-in-view'), document.querySelector('button[onclick="showBookmarkView()"]'), document.querySelector('hr.hidden')];
            loggedInElements.forEach(el => el?.classList.toggle('hidden', !user));
            document.getElementById('logged-out-view').classList.toggle('hidden', !!user);
            if (user) { document.getElementById('user-email').textContent = `${user.email}님`; loadSubjects(); } 
            else { showView('subject-view'); document.getElementById('subject-list').innerHTML = '<p>로그인 후 이용해주세요.</p>'; }
        });
        
        async function signUp() { try { const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; await auth.createUserWithEmailAndPassword(email, password); showView('subject-view'); } catch (error) { alert(error.message); } }
        async function logIn() { try { const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; await auth.signInWithEmailAndPassword(email, password); showView('subject-view'); } catch (error) { alert(error.message); } }
        function logOut() { auth.signOut(); }
        
        // --- 과목 및 퀴즈 ---
        async function loadSubjects() {
            const listDiv = document.getElementById('subject-list'); listDiv.innerHTML = '과목 로딩 중...';
            try {
                const snapshot = await db.collection('subjects').orderBy('name').get();
                listDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const subject = doc.data(); const button = document.createElement('button');
                    button.textContent = `${subject.name} (${subject.questionCount || 0}문제)`; button.className = 'button light-button';
                    button.onclick = () => selectSubject(doc.id, subject); listDiv.appendChild(button);
                });
            } catch(error) { console.error("Error loading subjects: ", error); listDiv.innerHTML = '<p>과목 로딩 중 오류 발생</p>'; }
        }
        
        function selectSubject(id, data) {
            currentSubjectId = id; currentSubjectData = data;
            showView('quiz-view');
            document.getElementById('quiz-header').textContent = `${data.name} 퀴즈`;
            loadQuestionsForSubject();
        }
        
        async function loadQuestionsForSubject() {
            const quizBody = document.getElementById('quiz-body'); quizBody.innerHTML = '<p>문제 로딩 중...</p>';
            const data = questions[currentQuiz];
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const isBookmarked = await checkBookmarkStatus(data.id);
            bookmarkToggle.textContent = isBookmarked ? '★' : '☆';
            bookmarkToggle.onclick = () => toggleBookmark(data.id);
            try {
                const snapshot = await db.collection('subjects').doc(currentSubjectId).collection('questions').get();
                questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentQuiz = 0; score = 0; displayCurrentQuiz();
            } catch(error) { console.error("Error loading questions: ", error); quizBody.innerHTML = '<p>문제 로딩 중 오류 발생</p>'; }
        }

        function displayCurrentQuiz() {
            const quizBody = document.getElementById('quiz-body'); selectedOption = null;
            document.getElementById('feedback-toggle').checked = immediateFeedbackMode;
            if (questions.length === 0) { quizBody.innerHTML = "<p>이 과목에 문제가 없습니다.</p>"; return; }
            if (currentQuiz >= questions.length) { quizBody.innerHTML = `<h2>퀴즈 결과: ${score}/${questions.length}</h2><button class="button primary-button" onclick="loadQuestionsForSubject()">다시 풀기</button>`; return; }
            
           
            let optionsHTML = '';
            (data.options || []).forEach(opt => { optionsHTML += `<li class="option">${opt}</li>`; });

            quizBody.innerHTML = `
                <div id="question">${data.fixedId || (currentQuiz + 1)}. ${data.text}</div>
                <ul id="options-container" class="options-container">${optionsHTML}</ul>
                <div id="immediate-feedback"></div>
                <button id="submit-btn" class="button primary-button">정답 제출</button>`;
            
            document.querySelectorAll('.option').forEach(li => {
                li.onclick = () => { document.querySelector('.option.selected')?.classList.remove('selected'); li.classList.add('selected'); selectedOption = li.textContent; };
            });
            document.getElementById('submit-btn').onclick = submitAnswer;
            // 북마크 상태 확인 및 UI 업데이트
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const isBookmarked = await checkBookmarkStatus(data.id);
            bookmarkToggle.textContent = isBookmarked ? '★' : '☆';
            bookmarkToggle.onclick = () => toggleBookmark(data.id);
        }

        function submitAnswer() {
            if (!selectedOption) return alert("보기를 선택해주세요!");
            const data = questions[currentQuiz]; const isCorrect = selectedOption === data.answer;
            if (immediateFeedbackMode) {
                const feedbackDiv = document.getElementById('immediate-feedback');
                feedbackDiv.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
                let feedbackHTML = `<p><strong>${isCorrect ? '정답입니다!' : '오답입니다.'}</strong></p>`;
                if (!isCorrect) feedbackHTML += `<p>정답: ${data.answer}</p>`;
                if (data.explanation) feedbackHTML += `<p>해설: ${data.explanation}</p>`;
                feedbackDiv.innerHTML = feedbackHTML;
                document.querySelectorAll('.option').forEach(opt => { opt.onclick = null; });
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.textContent = '다음 문제 →';
                submitBtn.onclick = () => { currentQuiz++; displayCurrentQuiz(); };
            } else {
                if (isCorrect) score++;
                currentQuiz++;
                displayCurrentQuiz();
            }
        }
        function toggleFeedbackMode(isEnabled) { immediateFeedbackMode = isEnabled; }

        // --- 북마크 기능 ---
        async function checkBookmarkStatus(questionId) {
            const user = auth.currentUser;
            if (!user) return false;
            const bookmarkRef = db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId);
            const doc = await bookmarkRef.get();
            return doc.exists;
        }

        async function toggleBookmark(questionId) {
            const user = auth.currentUser;
            if (!user) return;
            const bookmarkToggle = document.getElementById('bookmark-toggle');
            const bookmarkRef = db.collection('users').doc(user.uid).collection('bookmarks').doc(questionId);
            const isBookmarked = await checkBookmarkStatus(questionId);
            if (isBookmarked) {
                await bookmarkRef.delete();
                bookmarkToggle.textContent = '☆';
            } else {
                await bookmarkRef.set({
                    subjectId: currentSubjectId,
                    subjectName: currentSubjectData.name,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                bookmarkToggle.textContent = '★';
            }
        }

        async function showBookmarkView() {
            showView('bookmark-view');
            const user = auth.currentUser;
            const container = document.getElementById('bookmark-list-container');
            container.innerHTML = '북마크 로딩 중...';
            if (!user) return;
            const snapshot = await db.collection('users').doc(user.uid).collection('bookmarks').orderBy('addedAt', 'desc').get();
            if (snapshot.empty) { container.innerHTML = '<p>북마크한 문제가 없습니다.</p>'; return; }
            container.innerHTML = '';
            for (const doc of snapshot.docs) {
                const bookmark = doc.data();
                const questionDoc = await db.collection('subjects').doc(bookmark.subjectId).collection('questions').doc(doc.id).get();
                if (questionDoc.exists) {
                    const question = questionDoc.data();
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    item.innerHTML = `<span class="question-item-text">${question.fixedId || ''} ${question.text}</span><span class="question-item-part">(${bookmark.subjectName})</span>`;
                    container.appendChild(item);
                }
            }
        }

        async function showBookmarkView() {
            showView('bookmark-view');
            const user = auth.currentUser;
            const container = document.getElementById('bookmark-list-container');
            container.innerHTML = '북마크 로딩 중...';
            if (!user) return;
            const snapshot = await db.collection('users').doc(user.uid).collection('bookmarks').orderBy('addedAt', 'desc').get();
            if (snapshot.empty) { container.innerHTML = '<p>북마크한 문제가 없습니다.</p>'; return; }
            container.innerHTML = '';
            for (const doc of snapshot.docs) {
                const bookmark = doc.data();
                const questionDoc = await db.collection('subjects').doc(bookmark.subjectId).collection('questions').doc(doc.id).get();
                if (questionDoc.exists) {
                    const question = questionDoc.data();
                    const item = document.createElement('div');
                    item.className = 'question-item';
                    item.innerHTML = `<span class="question-item-text">${question.fixedId || ''} ${question.text}</span><span class="question-item-part">(${bookmark.subjectName})</span>`;
                    container.appendChild(item);
                }
            }
        }

        function updateSelectionActions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const actionsDiv = document.getElementById('management-actions');
            actionsDiv.classList.toggle('hidden', selected.length === 0);
            if (!actionsDiv.classList.contains('hidden')) {
                document.getElementById('selection-count').textContent = selected.length;
            }
        }

        function toggleSelectAll(checked) {
            document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = checked);
            updateSelectionActions();
        }

        function selectByRange() {
            const rangeStr = document.getElementById('range-select-input').value;
            if (!rangeStr.trim()) return;
            const allCheckboxes = document.querySelectorAll('.question-checkbox');
            const indicesToSelect = new Set();
            rangeStr.split(',').forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(num => parseInt(num.trim(), 10));
                    if (!isNaN(start) && !isNaN(end)) { for (let i = start; i <= end; i++) indicesToSelect.add(i - 1); }
                } else {
                    const num = parseInt(part, 10);
                    if (!isNaN(num)) indicesToSelect.add(num - 1);
                }
            });
            allCheckboxes.forEach((checkbox, index) => { checkbox.checked = indicesToSelect.has(index); });
            updateSelectionActions();
        }

        async function deleteSelectedQuestions() {
            const selected = document.querySelectorAll('.question-checkbox:checked');
            if (selected.length === 0 || !confirm(`${selected.length}개 삭제?`)) return;
            const subjectRef = db.collection('subjects').doc(currentSubjectId);
            const batch = db.batch();
            selected.forEach(cb => batch.delete(subjectRef.collection('questions').doc(cb.value)));
            batch.update(subjectRef, { questionCount: firebase.firestore.FieldValue.increment(-selected.length) });
            await batch.commit();
            showManagementView();
        }

        function showMoveDialog() {
            if (document.querySelectorAll('.question-checkbox:checked').length === 0) { alert('문제 선택 필요'); return; }
            const select = document.getElementById('target-part');
            select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const opt = document.createElement('option');
                opt.value = part; opt.textContent = part; select.appendChild(opt);
            });
            showView('move-question-view');
        }

        async function executeMove() {
            const newPartName = document.getElementById('target-part').value;
            const selected = document.querySelectorAll('.question-checkbox:checked');
            const batch = db.batch();
            selected.forEach(cb => {
                batch.update(db.collection('subjects').doc(currentSubjectId).collection('questions').doc(cb.value), { partName: newPartName });
            });
            await batch.commit();
            alert(`${selected.length}개 문제를 이동했습니다.`);
            showManagementView();
        }

        // --- 문제 추가/수정 함수
        function showAddForm() {
            showEditForm(null);
        }

        function showEditForm(id) {
            const isEditing = !!id;
            const q = isEditing ? questions.find(q => q.id === id) : {};
            document.getElementById('add-edit-header').textContent = isEditing ? '문제 수정' : '새 문제 추가';
            document.getElementById('editing-question-id').value = id || '';
            document.getElementById('q-text').value = q.text || '';
            document.getElementById('q-answer').value = q.answer || '';
            document.getElementById('q-explanation').value = q.explanation || '';
            populatePartSelect(q.partName);
            const optsContainer = document.getElementById('q-options-container');
            optsContainer.innerHTML = '';
            (q.options || ['', '']).forEach(opt => addOptionField(opt));
            document.getElementById('save-btn').onclick = () => saveQuestion(id);
            showView('add-edit-view');
        }

        async function saveQuestion(id) {
            const data = {
                text: document.getElementById('q-text').value.trim(),
                answer: document.getElementById('q-answer').value.trim(),
                explanation: document.getElementById('q-explanation').value.trim(),
                partName: document.getElementById('q-part').value,
                options: Array.from(document.querySelectorAll('#q-options-container input')).map(i => i.value.trim()).filter(Boolean)
            };
            if (!data.text || !data.answer || !data.partName) { alert("문제, 정답, 파트는 필수 항목입니다."); return; }

            if (id) {
                await db.collection('subjects').doc(currentSubjectId).collection('questions').doc(id).update(data);
                alert('문제가 수정되었습니다.');
            } else {
                const subjectRef = db.collection('subjects').doc(currentSubjectId);
                await db.runTransaction(async t => {
                    const doc = await t.get(subjectRef);
                    t.update(subjectRef, { questionCount: (doc.data().questionCount || 0) + 1 });
                    t.set(subjectRef.collection('questions').doc(), data);
                });
                currentSubjectData.questionCount++;
                alert('문제가 추가되었습니다.');
            }
            showManagementView();
        }

        function addOptionField(value = '') {
            const container = document.getElementById('q-options-container');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-group';
            input.value = value;
            container.appendChild(input);
        }
        function populatePartSelect(selectedValue) {
            const select = document.getElementById('q-part');
            select.innerHTML = '';
            (currentSubjectData.partOrder || []).forEach(part => {
                const opt = document.createElement('option');
                opt.value = part;
                opt.textContent = part;
                if (part === selectedValue) opt.selected = true;
                select.appendChild(opt);
            });
        }
    </script>
</body>
</html>
